<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  <meta name="theme-color" content="#ff0050">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tanda">
  <title>Order Details - Tanda Web</title>

  <link rel="icon" type="image/png" sizes="32x32" href="Tanda logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #ff0050, #00f2ea);
      --accent-color: #00f2ea;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --bg-card: rgba(255, 255, 255, 0.05);
      --border-radius: 1rem;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      min-height: 100vh;
      padding: 2rem;
    }

    /* Safe area insets for iPhone notches and home indicator */
    @supports (padding: env(safe-area-inset-top)) {
      .header {
        padding-top: calc(2rem + env(safe-area-inset-top));
        padding-left: calc(2rem + env(safe-area-inset-left));
        padding-right: calc(2rem + env(safe-area-inset-right));
      }

      .container {
        padding-left: calc(2rem + env(safe-area-inset-left));
        padding-right: calc(2rem + env(safe-area-inset-right));
      }

      @media (max-width: 768px) {
        .container {
          padding-left: calc(1rem + env(safe-area-inset-left));
          padding-right: calc(1rem + env(safe-area-inset-right));
        }
      }
    }

    /* iOS keyboard handling - prevent zoom on input focus */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    input[type="tel"],
    input[type="url"],
    input[type="search"],
    textarea,
    select {
      font-size: 16px !important;
    }

    input[type="number"] {
      inputmode: "numeric";
    }

    input[type="tel"] {
      inputmode: "tel";
    }

    input[type="email"] {
      inputmode: "email";
    }

    .header {
      max-width: 1200px;
      margin: 0 auto 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .title {
      font-size: 1.8rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }

    .nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Mobile: Add horizontal scroll to nav items - same as orders.html */
    @media (max-width: 768px) {
      .nav {
        gap: 0.25rem;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      
      .nav::-webkit-scrollbar {
        display: none;
      }
      
      /* Ensure user menu dropdown can escape overflow on mobile */
      .nav .user-menu-dropdown {
        overflow: visible !important;
        position: relative !important;
      }
      
      .nav .user-menu-wrapper {
        overflow: visible !important;
      }
    }
    
    @media (max-width: 480px) {
      .nav {
        gap: 0.15rem;
      }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 2rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .order-id {
      font-size: 1.2rem;
      color: var(--text-secondary);
    }

    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .status-pending {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .status-paid {
      background: rgba(0, 242, 234, 0.2);
      color: var(--accent-color);
      border: 1px solid rgba(0, 242, 234, 0.3);
    }

    .status-delivered {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .status-cancelled {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
      border: 1px solid rgba(244, 67, 54, 0.3);
    }

    .order-items {
      margin-bottom: 2rem;
    }

    .order-item {
      display: flex;
      gap: 1.5rem;
      padding: 1.5rem 0;
      position: relative;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .item-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 0.5rem;
      background: var(--bg-secondary);
    }

    .item-details {
      flex: 1;
    }

    .item-name {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .item-price {
      color: var(--accent-color);
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .item-quantity {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Digital Product Badge in Order Items */
    .digital-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      background: rgba(0, 242, 234, 0.15);
      border: 1px solid rgba(0, 242, 234, 0.3);
      border-radius: 0.4rem;
      color: #00f2ea;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .digital-badge i {
      font-size: 0.7rem;
    }

    /* Download Button in Order Items */
    .item-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .btn-download-small {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #00f2ea, #00d4c8);
      color: #000;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-download-small:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 242, 234, 0.4);
    }

    .btn-download-small i {
      font-size: 0.9rem;
    }

    .download-info {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .order-summary {
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .summary-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .summary-label {
      color: var(--text-secondary);
    }

    .summary-value {
      color: var(--text-primary);
    }

    .delivery-card {
      margin-top: 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      padding-top: 1.5rem;
    }

    .tracking-steps {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    .tracking-step {
      flex: 1 1 calc(20% - 0.75rem);
      min-width: 90px;
      position: relative;
      text-align: center;
      font-size: 0.78rem;
      color: var(--text-secondary);
    }

    .tracking-step-circle {
      width: 1.6rem;
      height: 1.6rem;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.16);
      margin: 0 auto 0.35rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      background: rgba(16, 16, 16, 0.9);
    }

    .tracking-step-line {
      position: absolute;
      top: 0.8rem;
      left: 50%;
      right: -50%;
      height: 2px;
      background: radial-gradient(circle at left, rgba(255, 255, 255, 0.18), transparent 65%);
      opacity: 0.4;
      pointer-events: none;
    }

    .tracking-step:last-child .tracking-step-line {
      display: none;
    }

    .tracking-step.completed .tracking-step-circle {
      background: linear-gradient(135deg, #00f2ea, #00c3ff);
      border-color: transparent;
      color: #000;
      box-shadow: 0 0 20px rgba(0, 242, 234, 0.45);
    }

    .tracking-step.completed .tracking-step-label {
      color: #ffffff;
    }

    .tracking-step.active .tracking-step-circle {
      border-color: #00f2ea;
      box-shadow: 0 0 14px rgba(0, 242, 234, 0.35);
      color: #00f2ea;
    }

    .tracking-step.active .tracking-step-label {
      color: #ffffff;
      font-weight: 500;
    }

    .tracking-meta {
      margin-top: 0.75rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .tracking-meta span {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .tracking-meta i {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .driver-info {
      margin-top: 1rem;
      padding: 0.9rem 1rem;
      border-radius: 0.9rem;
      background: radial-gradient(circle at top left, rgba(0, 242, 234, 0.08), transparent 55%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      gap: 0.85rem;
    }

    .driver-avatar {
      width: 2.4rem;
      height: 2.4rem;
      border-radius: 999px;
      background: radial-gradient(circle at top left, #00f2ea, #00c3ff);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .driver-details {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      font-size: 0.82rem;
    }

    .driver-name {
      font-weight: 600;
      color: #ffffff;
    }

    .driver-phone {
      color: var(--text-secondary);
    }

    .shipping-address-card {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .shipping-address-content {
      margin-top: 0.75rem;
      font-size: 0.86rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .shipping-address-content p {
      margin: 0.1rem 0;
    }

    .shipping-address-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.15rem 0.7rem;
      border-radius: 999px;
      background: rgba(0, 242, 234, 0.08);
      color: #00f2ea;
      font-size: 0.75rem;
      margin-bottom: 0.35rem;
    }

    .btn {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 0, 80, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-pay {
      width: 100%;
      justify-content: center;
      margin-top: 1.5rem;
      font-size: 1.1rem;
      padding: 1.2rem;
    }

    .btn-secondary {
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid rgba(244, 67, 54, 0.3);
      color: #f44336;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .payment-info {
      background: rgba(0, 242, 234, 0.1);
      border: 1px solid rgba(0, 242, 234, 0.3);
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .payment-info p {
      margin-bottom: 0.5rem;
    }

    .payment-info p:last-child {
      margin-bottom: 0;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .title {
        font-size: 1.5rem;
      }

      .title {
        font-size: 1.5rem;
      }

      .card {
        padding: 1.5rem;
      }

      .order-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .order-item {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .item-image {
        width: 100%;
        max-width: 200px;
        height: 200px;
        margin: 0 auto;
      }

      .item-details {
        text-align: center;
      }

      .order-summary {
        padding: 1.5rem;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 0.75rem;
      }

      .title {
        font-size: 1.3rem;
      }

      .card {
        padding: 1rem;
      }

      .order-summary {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 class="title">Order Details</h1>
    <div class="nav" id="authNav"></div>
  </div>

  <div class="container">
    <div id="loading-section" class="loading">
      <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
      <p>Loading order details...</p>
    </div>

    <div id="error-section" class="error" style="display: none;">
      <i class="fas fa-exclamation-circle"></i>
      <span id="error-message"></span>
    </div>

    <div id="order-section" style="display: none;">
      <div class="card">
        <div class="order-header">
          <div>
            <div class="order-id">Order #<span id="order-id"></span></div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
              Placed on <span id="order-date"></span>
            </div>
          </div>
          <div class="status-badge" id="status-badge"></div>
        </div>

        <div class="order-items" id="order-items"></div>

        <div class="order-summary">
          <div class="summary-row">
            <span class="summary-label">Subtotal</span>
            <span class="summary-value" id="subtotal"></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Shipping</span>
            <span class="summary-value" id="shipping"></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Total</span>
            <span class="summary-value" id="total"></span>
          </div>
        </div>

        <!-- Delivery status & tracking -->
        <div class="delivery-card" id="delivery-card" style="display: none;">
          <h2 style="font-size: 1rem; margin-bottom: 0.25rem;">
            <i class="fas fa-route" style="margin-right: 0.4rem;"></i> Delivery Status
          </h2>
          <p style="font-size: 0.82rem; color: var(--text-secondary); margin-bottom: 0.4rem;">
            Track how far your order has gone from confirmation to delivery.
          </p>
          <div class="tracking-steps" id="tracking-steps"></div>
          <div class="tracking-meta">
            <span><i class="fas fa-clock"></i> <span id="delivery-eta">ETA: —</span></span>
            <span><i class="fas fa-history"></i> <span id="delivery-updated">Last update: —</span></span>
          </div>
          <div class="driver-info" id="driver-info" style="display: none;">
            <div class="driver-avatar">
              <i class="fas fa-motorcycle"></i>
            </div>
            <div class="driver-details">
              <div class="driver-name" id="driver-name"></div>
              <div class="driver-phone" id="driver-phone"></div>
            </div>
          </div>
        </div>

        <!-- Shipping address -->
        <div class="shipping-address-card" id="shipping-address-card" style="display: none;">
          <h2 style="font-size: 1rem; margin-bottom: 0.25rem;">
            <i class="fas fa-location-dot" style="margin-right: 0.4rem;"></i> Shipping Address
          </h2>
          <div class="shipping-address-content" id="shipping-address-content"></div>
        </div>

        <div id="payment-section" style="display: none;">
          <div class="payment-info">
            <p><strong>Payment Status:</strong> <span id="payment-status"></span></p>
            <p id="payment-reference" style="display: none;"><strong>Reference:</strong> <span id="reference-value"></span></p>
          </div>
          <button class="btn btn-pay" id="pay-button" onclick="initiatePayment()">
            <i class="fas fa-credit-card"></i> Pay with Paystack
          </button>
        </div>

        <!-- Return Request Information Card -->
        <div id="return-request-card" class="card" style="display: none; margin-top: 1.5rem; background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.3);">
          <h2 style="font-size: 1rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-undo" style="color: #ff9800;"></i> Return Request
          </h2>
          <div id="return-request-content"></div>
        </div>

        <div id="order-actions" style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
          <a href="orders.html" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Orders
          </a>
          <!-- Cancel Order button - shown for paid orders that are pending or confirmed (before shipping) -->
          <button id="cancel-order-btn" class="btn" style="display: none; background: rgba(255, 152, 0, 0.2); color: #ff9800; border: 1px solid #ff9800;" onclick="cancelOrder()">
            <i class="fas fa-times-circle"></i> Cancel Order
          </button>
          <!-- Request Return button - shown for delivered orders (excluding digital-only) -->
          <button id="request-return-btn" class="btn" style="display: none; background: rgba(255, 87, 34, 0.2); color: #ff5722; border: 1px solid #ff5722;" onclick="requestReturn()">
            <i class="fas fa-undo"></i> Request Return
          </button>
          <!-- Acknowledge Return button - shown when seller has approved return -->
          <button id="acknowledge-return-btn" class="btn" style="display: none; background: rgba(76, 175, 80, 0.2); color: #4caf50; border: 1px solid #4caf50;" onclick="acknowledgeReturn()">
            <i class="fas fa-check-circle"></i> Acknowledge Return
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/super-affiliate-api.js?v=3"></script>
  <script>
    let orderData = null;
    let paymentUrl = null;

    // Check authentication
    if (!SuperAffiliateAPI.isAuthenticated()) {
      window.location.href = 'super-affiliate-login.html?redirect=' + encodeURIComponent(window.location.href);
    }

    // Render auth nav
    SuperAffiliateAPI.renderAuthNav('authNav');
    SuperAffiliateAPI.updateCartBadge();

    // Get order ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('id');

    if (!orderId) {
      showError('Order ID not provided');
      // Don't proceed if no order ID
    } else {
      // Load order if ID is present
      loadOrder();
    }

    async function loadOrder() {
      try {
        const response = await SuperAffiliateAPI.apiRequest(`/commerce/orders/${orderId}/`);

        // Some errors are returned as JSON with an error field; treat those as failures
        if (!response || response.error) {
          const message = response && response.error ? response.error : 'Order not found';
          throw new Error(message);
        }

        orderData = response;
        displayOrder(response);
        document.getElementById('loading-section').style.display = 'none';
        document.getElementById('order-section').style.display = 'block';
      } catch (error) {
        console.error('Error loading order:', error);
        showError(error.message || 'Failed to load order details');
        document.getElementById('loading-section').style.display = 'none';
      }
    }

    // Check if order contains only digital products
    function isDigitalOnlyOrder(order) {
      const items = order.items || [];
      if (items.length === 0) return false;
      
      // Check if all items are digital (not physical or hybrid)
      return items.every(item => {
        const productType = item.product?.product_type?.toLowerCase() || 'physical';
        return productType === 'digital';
      });
    }

    function displayOrder(order) {
      if (!order || !order.id) {
        showError('Order not found');
        return;
      }
      
      const isDigitalOnly = isDigitalOnlyOrder(order);
      
      // Order ID and Date
      document.getElementById('order-id').textContent = order.id.substring(0, 8).toUpperCase();
      if (order.created_at) {
        const date = new Date(order.created_at);
        document.getElementById('order-date').textContent = date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // Status Badge
      const statusBadge = document.getElementById('status-badge');
      statusBadge.textContent = order.status || 'pending';
      statusBadge.className = 'status-badge status-' + (order.status || 'pending').toLowerCase();

      // Order Items
      const itemsContainer = document.getElementById('order-items');
      const items = order.items || [];
      
      if (items.length === 0) {
        itemsContainer.innerHTML = '<p style="color: var(--text-secondary);">No items in this order.</p>';
      } else {
        const API_BASE_URL = SuperAffiliateAPI.BASE_URL || 'http://localhost:8000';
        const getImageUrl = (product) => {
          if (!product) return '';
          const img = product.image || product.thumbnail || (product.images && product.images[0]?.image);
          if (!img) return '';
          return img.startsWith('http') ? img : API_BASE_URL + (img.startsWith('/') ? img : '/' + img);
        };

        itemsContainer.innerHTML = items.map(item => {
          const imageUrl = getImageUrl(item.product);
          const formatCurrency = (amount) => {
            return `₦${parseFloat(amount || 0).toLocaleString('en-NG', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
          };

          const isDigital = item.product?.product_type === 'digital' || item.product?.product_type === 'hybrid';
          const hasDownloadLink = item.download_link && order.payment_status === 'paid';

          return `
            <div class="order-item">
              ${imageUrl ? `<img src="${imageUrl}" alt="${item.product?.name || 'Product'}" class="item-image" onerror="this.style.display='none';">` : '<div class="item-image" style="display: flex; align-items: center; justify-content: center;"><i class="fas fa-image" style="font-size: 2rem; opacity: 0.3;"></i></div>'}
              <div class="item-details">
                <div class="item-name">
                  ${item.product?.name || 'Product'}
                  ${isDigital ? '<span class="digital-badge"><i class="fas fa-download"></i> Digital</span>' : ''}
                </div>
                <div class="item-price">${formatCurrency(item.product?.price || 0)}</div>
                <div class="item-quantity">Quantity: ${item.quantity}</div>
                
                ${hasDownloadLink ? `
                  <div class="item-actions">
                    <a href="${item.download_link}" class="btn-download-small" target="_blank" onclick="trackDownload('${item.product?.id}')">
                      <i class="fas fa-download"></i> Download
                    </a>
                    ${item.download_info ? `
                      <span class="download-info">
                        ${item.download_info.download_count || 0}/${item.download_info.max_downloads || '∞'} downloads
                      </span>
                    ` : ''}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      // Order Summary
      const formatCurrency = (amount) => {
        return `₦${parseFloat(amount || 0).toLocaleString('en-NG', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      };

      // Subtotal comes from backend; fall back to total if missing
      const subtotalValue = (order.subtotal != null ? order.subtotal : order.total);
      // Shipping is stored on the order as `shipping`; fall back to `shipping_cost` if present
      const rawShipping = (order.shipping != null ? order.shipping : order.shipping_cost);
      const shippingValue = rawShipping != null ? rawShipping : 0;
      // Total from backend already includes shipping and tax
      const totalValue = order.total != null ? order.total : (subtotalValue || 0) + (shippingValue || 0);

      document.getElementById('subtotal').textContent = formatCurrency(subtotalValue || 0);
      document.getElementById('shipping').textContent = formatCurrency(shippingValue || 0);
      document.getElementById('total').textContent = formatCurrency(totalValue || 0);

      // Shipping address (from order.shipping_address JSON) - only for physical/hybrid orders
      if (!isDigitalOnly && order.shipping_address && order.shipping_address.type !== 'digital') {
        renderShippingAddress(order.shipping_address);
      } else {
        // Hide shipping address card for digital orders
        const shippingCard = document.getElementById('shipping-address-card');
        if (shippingCard) {
          shippingCard.style.display = 'none';
        }
      }

      // Delivery status tracker - only for physical/hybrid orders
      if (!isDigitalOnly) {
        renderTrackingSteps(order);
        // Load delivery tracking (driver + ETA) if available
        if (order.id) {
          loadDeliveryTracking(order.id);
        }
      } else {
        // Hide delivery tracking card for digital orders
        const deliveryCard = document.getElementById('delivery-card');
        if (deliveryCard) {
          deliveryCard.style.display = 'none';
        }
      }

      // Show/hide Cancel Order button - for paid orders that are pending or confirmed (before shipping)
      const cancelBtn = document.getElementById('cancel-order-btn');
      const paymentStatus = order.payment_status?.toLowerCase() || '';
      const orderStatus = order.status?.toLowerCase() || '';
      const isPaid = paymentStatus === 'paid';
      const canCancel = isPaid && ['pending', 'confirmed'].includes(orderStatus) && orderStatus !== 'cancelled';
      
      if (cancelBtn) {
        if (canCancel) {
          cancelBtn.style.display = 'inline-flex';
        } else {
          cancelBtn.style.display = 'none';
        }
      }

      // Show/hide Request Return button - for delivered orders (excluding digital-only)
      const returnBtn = document.getElementById('request-return-btn');
      const canReturn = !isDigitalOnly && orderStatus === 'delivered' && !order.return_status;
      
      if (returnBtn) {
        if (canReturn) {
          returnBtn.style.display = 'inline-flex';
        } else {
          returnBtn.style.display = 'none';
        }
      }

      // Display Return Request Information (if return has been requested)
      const returnCard = document.getElementById('return-request-card');
      const returnContent = document.getElementById('return-request-content');
      const returnStatus = order.return_status?.toLowerCase() || '';
      const hasReturnRequest = orderStatus || order.status?.toLowerCase() === 'return_requested';
      
      if (hasReturnRequest && returnCard && returnContent) {
          const returnReason = order.return_reason || '';
          const sellerResponse = order.seller_response || '';
          
          // Get return status display text and color
          let statusText, statusColor, statusClass;
          switch (returnStatus) {
            case 'pending':
              statusText = 'Pending Review';
              statusColor = '#ff9800';
              statusClass = 'status-pending';
              break;
            case 'seller_reviewing':
              statusText = 'Seller Reviewing';
              statusColor = '#2196f3';
              statusClass = 'status-processing';
              break;
            case 'seller_approved':
              statusText = 'Seller Approved';
              statusColor = '#4caf50';
              statusClass = 'status-confirmed';
              break;
            case 'seller_rejected':
              statusText = 'Seller Rejected';
              statusColor = '#f44336';
              statusClass = 'status-cancelled';
              break;
            case 'processing':
              statusText = 'Processing Return';
              statusColor = '#2196f3';
              statusClass = 'status-processing';
              break;
            case 'admin_approved':
              statusText = 'Admin Approved';
              statusColor = '#4caf50';
              statusClass = 'status-confirmed';
              break;
            case 'admin_rejected':
              statusText = 'Admin Rejected';
              statusColor = '#f44336';
              statusClass = 'status-cancelled';
              break;
            case 'completed':
              statusText = 'Return Completed';
              statusColor = '#4caf50';
              statusClass = 'status-confirmed';
              break;
            default:
              statusText = 'Unknown';
              statusColor = '#9e9e9e';
              statusClass = 'status-pending';
          }
          
          let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <span style="color: var(--text-secondary); font-size: 0.9rem;">Status:</span>
              <span class="status-badge ${statusClass}" style="background: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}; padding: 0.4rem 0.8rem; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600;">
                ${statusText}
              </span>
            </div>
          `;
          
          if (returnReason) {
            html += `
              <div style="margin-bottom: 1rem;">
                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.4rem; font-weight: 500;">Your Reason:</div>
                <div style="color: var(--text-primary); font-size: 0.9rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 0.5rem;">
                  ${returnReason}
                </div>
              </div>
            `;
          }
          
          if (sellerResponse) {
            const responseBgColor = returnStatus === 'seller_approved' ? 'rgba(76, 175, 80, 0.1)' : 
                                   returnStatus === 'seller_rejected' ? 'rgba(244, 67, 54, 0.1)' : 
                                   'rgba(255, 255, 255, 0.05)';
            const responseBorderColor = returnStatus === 'seller_approved' ? 'rgba(76, 175, 80, 0.3)' : 
                                       returnStatus === 'seller_rejected' ? 'rgba(244, 67, 54, 0.3)' : 
                                       'rgba(255, 255, 255, 0.1)';
            
            html += `
              <div style="margin-bottom: 1rem;">
                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.4rem; font-weight: 500;">Seller Response:</div>
                <div style="color: var(--text-primary); font-size: 0.9rem; padding: 0.75rem; background: ${responseBgColor}; border: 1px solid ${responseBorderColor}; border-radius: 0.5rem;">
                  ${sellerResponse}
                </div>
              </div>
            `;
          }
          
          const buyerResponse = order.buyer_response || '';
          if (buyerResponse) {
            html += `
              <div style="margin-bottom: 1rem;">
                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.4rem; font-weight: 500;">Your Response:</div>
                <div style="color: var(--text-primary); font-size: 0.9rem; padding: 0.75rem; background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3); border-radius: 0.5rem;">
                  ${buyerResponse}
                </div>
              </div>
            `;
          }
          
          // Add Response button (shown when seller has responded and not processing/completed)
          if (sellerResponse && returnStatus !== 'processing' && returnStatus !== 'completed') {
            html += `
              <div style="margin-top: 1rem;">
                <button onclick="showBuyerResponseModal('${order.id}')" class="btn" style="width: 100%; background: rgba(33, 150, 243, 0.1); color: #2196f3; border: 1px solid #2196f3; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                  <i class="fas fa-comment"></i> ${buyerResponse ? 'Update Response' : 'Add Response'}
                </button>
              </div>
            `;
          }
          
          returnContent.innerHTML = html;
          returnCard.style.display = 'block';
        }
      } else {
        if (returnCard) {
          returnCard.style.display = 'none';
        }
      }

      // Show/hide Acknowledge Return button - when seller has approved
      const acknowledgeBtn = document.getElementById('acknowledge-return-btn');
      if (acknowledgeBtn) {
        if (returnStatus === 'seller_approved') {
          acknowledgeBtn.style.display = 'inline-flex';
        } else {
          acknowledgeBtn.style.display = 'none';
        }
      }

      // Payment Section
      document.getElementById('payment-status').textContent = (paymentStatus || 'pending').toUpperCase();

      // Show payment button if order is pending payment
      if (paymentStatus === 'pending' || paymentStatus === 'unpaid') {
        document.getElementById('payment-section').style.display = 'block';
        
        // Check if we have payment URL from order creation
        if (order.payment_url || order.authorization_url) {
          paymentUrl = order.payment_url || order.authorization_url;
        } else {
          // Try to get payment URL from metadata or create new payment
          // For now, we'll need to create payment on demand
          console.log('No payment URL found, will create payment on button click');
        }
      } else {
        document.getElementById('payment-section').style.display = 'none';
      }

      // Show payment reference if available
      if (order.transaction_id || order.payment_reference) {
        document.getElementById('payment-reference').style.display = 'block';
        document.getElementById('reference-value').textContent = order.transaction_id || order.payment_reference;
      }
    }

    function trackDownload(productId) {
      // Track download event (optional analytics)
      console.log('Download initiated for product:', productId);
      // Could send analytics event here
    }

    function renderShippingAddress(address) {
      const card = document.getElementById('shipping-address-card');
      const content = document.getElementById('shipping-address-content');
      if (!card || !content) return;

      if (!address) {
        card.style.display = 'none';
        return;
      }

      const fullName = address.full_name || address.name || '';
      const phone = address.phone_number || address.phone || '';
      const street = address.street_address || address.street || '';
      const apartment = address.apartment_suite || address.apartment || '';
      const city = address.city || '';
      const state = address.state || '';
      const postal = address.postal_code || '';
      const country = address.country || 'Nigeria';
      const landmark = address.landmark || '';
      const instructions = address.delivery_instructions || '';

      content.innerHTML = `
        <div class="shipping-address-badge">
          <i class="fas fa-map-pin"></i>
          Delivering to
        </div>
        ${fullName ? `<p><strong>${fullName}</strong></p>` : ''}
        ${phone ? `<p>${phone}</p>` : ''}
        ${street || apartment ? `<p>${street}${apartment ? ', ' + apartment : ''}</p>` : ''}
        ${(city || state || postal) ? `<p>${city}${city && state ? ', ' : ''}${state}${postal ? ' ' + postal : ''}</p>` : ''}
        ${country ? `<p>${country}</p>` : ''}
        ${landmark ? `<p><strong>Landmark:</strong> ${landmark}</p>` : ''}
        ${instructions ? `<p><strong>Instructions:</strong> ${instructions}</p>` : ''}
      `;

      card.style.display = 'block';
    }

    function renderTrackingSteps(order) {
      const card = document.getElementById('delivery-card');
      const stepsContainer = document.getElementById('tracking-steps');
      if (!card || !stepsContainer) return;
      
      // Don't show tracking for digital-only orders
      if (isDigitalOnlyOrder(order)) {
        card.style.display = 'none';
        return;
      }

      const rawStatus = (order.status || 'pending').toLowerCase();
      const steps = ['pending', 'confirmed', 'processing', 'shipped', 'delivered'];

      let statusForSteps = rawStatus;
      if (['cancelled', 'refunded', 'return_requested'].includes(rawStatus)) {
        // For special terminal states, show all steps as completed visually
        statusForSteps = 'delivered';
      }

      const currentIndex = steps.indexOf(statusForSteps);

      const label = (s) => {
        switch (s) {
          case 'pending': return 'Pending';
          case 'confirmed': return 'Confirmed';
          case 'processing': return 'Processing';
          case 'shipped': return 'Shipped';
          case 'delivered': return 'Delivered';
          default: return s.charAt(0).toUpperCase() + s.slice(1);
        }
      };

      stepsContainer.innerHTML = steps.map((step, index) => {
        const isCompleted = currentIndex > index;
        const isActive = currentIndex === index || (currentIndex === -1 && index === 0);
        const classes = [
          'tracking-step',
          isCompleted ? 'completed' : '',
          isActive ? 'active' : ''
        ].join(' ').trim();

        return `
          <div class="${classes}">
            <div class="tracking-step-circle">
              ${isCompleted ? '<i class="fas fa-check"></i>' : index + 1}
            </div>
            <div class="tracking-step-line"></div>
            <div class="tracking-step-label">${label(step)}</div>
          </div>
        `;
      }).join('');

      card.style.display = 'block';
    }

    async function loadDeliveryTracking(orderId) {
      const etaEl = document.getElementById('delivery-eta');
      const updatedEl = document.getElementById('delivery-updated');
      const driverInfo = document.getElementById('driver-info');
      const driverNameEl = document.getElementById('driver-name');
      const driverPhoneEl = document.getElementById('driver-phone');

      if (!etaEl || !updatedEl) return;

      try {
        const tracking = await SuperAffiliateAPI.apiRequest(`/commerce/orders/${orderId}/tracking/`);
        if (!tracking) return;

        // ETA
        if (tracking.estimated_delivery_time) {
          const etaDate = new Date(tracking.estimated_delivery_time);
          etaEl.textContent = 'ETA: ' + etaDate.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        }

        // Last updated
        const updatedRaw = tracking.updated_at || tracking.last_location_update;
        if (updatedRaw) {
          const updDate = new Date(updatedRaw);
          updatedEl.textContent = 'Last update: ' + updDate.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        }

        // Driver info
        const hasDriver = tracking.driver_name || tracking.driver_phone;
        if (hasDriver && driverInfo && driverNameEl && driverPhoneEl) {
          driverNameEl.textContent = tracking.driver_name || 'Assigned driver';
          driverPhoneEl.textContent = tracking.driver_phone ? `Phone: ${tracking.driver_phone}` : '';
          driverInfo.style.display = 'flex';
        }
      } catch (error) {
        console.log('No delivery tracking found for this order (this is normal for new orders).', error);
      }
    }

    async function initiatePayment() {
      const btn = document.getElementById('pay-button');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      try {
        // If we don't have a payment URL, create a new order with payment
        if (!paymentUrl && orderData) {
          // Re-create order with payment (or use existing order to create payment)
          // For now, redirect to checkout with order pre-filled
          // Or create payment directly via API if endpoint exists
          showToast('Redirecting to payment...', 'info');
          
          // Try to get payment URL from order metadata or create new payment
          // Since we already have an order, we'll need to create payment separately
          // For simplicity, redirect to checkout with order info
          window.location.href = `checkout.html?order_id=${orderId}`;
          return;
        }

        if (paymentUrl) {
          // Redirect to Paystack
          window.location.href = paymentUrl;
        } else {
          throw new Error('Payment URL not available. Please try again from checkout.');
        }
      } catch (error) {
        console.error('Payment initiation error:', error);
        showToast('Failed to initiate payment: ' + (error.message || 'Unknown error'), 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-credit-card"></i> Pay with Paystack';
      }
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: ${type === 'success' ? '#00f2ea' : type === 'error' ? '#ff0050' : '#ffc107'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function showError(message) {
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-section').style.display = 'block';
      document.getElementById('loading-section').style.display = 'none';
    }

    async function cancelOrder() {
      if (!orderId) {
        showToast('Order ID not found', 'error');
        return;
      }

      if (!orderData) {
        showToast('Order data not loaded', 'error');
        return;
      }

      const paymentStatus = orderData.payment_status?.toLowerCase() || '';
      const isPaid = paymentStatus === 'paid';
      const message = isPaid
        ? 'Are you sure you want to cancel this order? The refund amount will be credited to your wallet balance for future purchases. This action cannot be undone.'
        : 'Are you sure you want to cancel this order? This action cannot be undone.';

      if (!confirm(message)) {
        return;
      }

      try {
        const response = await SuperAffiliateAPI.apiRequest(`/commerce/orders/${orderId}/cancel/`, {
          method: 'POST',
          body: JSON.stringify({})
        });

        if (response.message) {
          // Extract refund amount and digital items excluded from response
          const refundAmount = response.refund_amount;
          const digitalExcluded = response.digital_items_excluded;
          
          let refundMessage;
          if (refundAmount && refundAmount > 0) {
            refundMessage = `Order cancelled successfully. ₦${parseFloat(refundAmount).toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})} has been credited to your wallet balance.`;
            if (digitalExcluded && digitalExcluded > 0) {
              refundMessage += `\n\nNote: ₦${parseFloat(digitalExcluded).toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})} for digital products was excluded as digital products are non-refundable.`;
            }
          } else if (digitalExcluded && digitalExcluded > 0) {
            refundMessage = 'Order cancelled successfully.\n\nNote: Digital products are non-refundable, so no refund was processed for this order.';
          } else {
            refundMessage = response.message || 'Order cancelled successfully.';
          }
          
          showToast(refundMessage, 'success');
          
          // Reload order to reflect cancellation
          setTimeout(() => {
            loadOrder();
          }, 1000);
        } else {
          showToast(response.error || 'Failed to cancel order', 'error');
        }
      } catch (error) {
        console.error('Error cancelling order:', error);
        showToast(error.message || 'Failed to cancel order. Please try again.', 'error');
      }
    }

    async function requestReturn() {
      if (!orderId) {
        showToast('Order ID not found', 'error');
        return;
      }

      const reason = prompt('Please provide a reason for the return request:');
      if (!reason || reason.trim().length < 10) {
        if (reason !== null) {
          showToast('Please provide a reason with at least 10 characters', 'error');
        }
        return;
      }

      try {
        const response = await SuperAffiliateAPI.apiRequest(`/commerce/orders/${orderId}/return/`, {
          method: 'POST',
          body: JSON.stringify({
            reason: reason.trim()
          })
        });

        if (response.message) {
          showToast('Return request submitted successfully', 'success');
          
          // Reload order to reflect return request
          setTimeout(() => {
            loadOrder();
          }, 1000);
        } else {
          showToast(response.error || 'Failed to submit return request', 'error');
        }
      } catch (error) {
        console.error('Error requesting return:', error);
        showToast(error.message || 'Failed to submit return request. Please try again.', 'error');
      }
    }

    async function acknowledgeReturn() {
      if (!orderId) {
        showToast('Order ID not found', 'error');
        return;
      }

      if (!orderData) {
        showToast('Order data not loaded', 'error');
        return;
      }

      const returnStatus = orderData.return_status?.toLowerCase() || '';
      if (returnStatus !== 'seller_approved') {
        showToast('Return request must be approved by seller before acknowledgment', 'error');
        return;
      }

      const message = prompt(
        'By acknowledging, you confirm that you will proceed with the return process.\n\n' +
        'The seller has approved your return request. Admin will now process the return and refund.\n\n' +
        'Optional: Add a message:',
        ''
      );

      if (message === null) {
        return; // User cancelled
      }

      try {
        const data = message.trim() ? { message: message.trim() } : {};
        const response = await SuperAffiliateAPI.apiRequest(`/commerce/orders/${orderId}/return/acknowledge/`, {
          method: 'POST',
          body: JSON.stringify(data)
        });

        if (response.message) {
          showToast(response.message || 'Return request acknowledged successfully', 'success');
          
          // Reload order to reflect acknowledgment
          setTimeout(() => {
            loadOrder();
          }, 1000);
        } else {
          showToast(response.error || 'Failed to acknowledge return request', 'error');
        }
      } catch (error) {
        console.error('Error acknowledging return:', error);
        showToast(error.message || 'Failed to acknowledge return request. Please try again.', 'error');
      }
    }

    function showBuyerResponseModal(orderId) {
      const currentResponse = orderData?.buyer_response || '';
      const message = prompt(
        'Add your response or message regarding the return request:',
        currentResponse
      );
      
      if (message === null) return; // User cancelled
      
      if (!message.trim()) {
        showToast('Response message cannot be empty', 'error');
        return;
      }
      
      if (message.trim().length < 10) {
        showToast('Response must be at least 10 characters', 'error');
        return;
      }
      
      submitBuyerResponse(orderId, message.trim());
    }

    async function submitBuyerResponse(orderId, response) {
      try {
        const result = await SuperAffiliateAPI.apiRequest(`/commerce/orders/${orderId}/return/buyer-response/`, {
          method: 'POST',
          body: JSON.stringify({ response })
        });

        if (result.message) {
          showToast(result.message || 'Response submitted successfully', 'success');
          
          // Reload order to reflect response
          setTimeout(() => {
            loadOrder();
          }, 1000);
        } else {
          showToast(result.error || 'Failed to submit response', 'error');
        }
      } catch (error) {
        console.error('Error submitting buyer response:', error);
        showToast(error.message || 'Failed to submit response. Please try again.', 'error');
      }
    }

      // Load order on page load if orderId exists
      if (orderId) {
        loadOrder();
      }
  </script>
</body>
</html>
