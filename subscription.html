<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  <meta name="theme-color" content="#ff0050">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Subscription Plans - Tanda Web</title>
  <meta name="description" content="Choose a subscription plan to unlock product tagging features.">

  <link rel="icon" type="image/png" sizes="32x32" href="Tanda logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="site.webmanifest">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #ff0050, #00f2ea);
      --accent-color: #00f2ea;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --bg-card: rgba(255, 255, 255, 0.05);
      --border-radius: 1rem;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      min-height: 100vh;
      padding: 2rem;
    }

    .header {
      max-width: 1200px;
      margin: 0 auto 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .title {
      font-size: 1.8rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }

    .nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Mobile: Add horizontal scroll to nav items */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .nav {
        gap: 0.25rem;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      
      .nav::-webkit-scrollbar {
        display: none;
      }
      
      .nav .user-menu-dropdown {
        overflow: visible !important;
        position: relative !important;
      }
      
      .nav .user-menu-wrapper {
        overflow: visible !important;
      }
    }
    
    @media (max-width: 480px) {
      .nav {
        gap: 0.15rem;
      }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .quota-status {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .quota-status h2 {
      color: var(--accent-color);
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    .quota-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .quota-item {
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 0.75rem;
    }

    .quota-item-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .quota-item-value {
      font-size: 1.5rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .quota-item-limit {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    .plans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-top: 2rem;
      justify-items: center;
      align-items: start;
    }
    
    @media (min-width: 768px) {
      .plans-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        justify-items: stretch;
      }
    }
    
    @media (min-width: 1200px) {
      .plans-grid {
        grid-template-columns: repeat(3, 1fr);
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
      }
    }

    .plan-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      border: 2px solid rgba(255,255,255,0.1);
      padding: 2rem;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .plan-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent-color);
      box-shadow: 0 10px 30px rgba(0, 242, 234, 0.2);
    }

    .plan-card.featured {
      border-color: var(--accent-color);
      background: linear-gradient(135deg, rgba(255, 0, 80, 0.1), rgba(0, 242, 234, 0.1));
    }

    .plan-card.current {
      border: 3px solid var(--accent-color);
      background: rgba(255, 0, 80, 0.1);
      box-shadow: 0 0 20px rgba(255, 0, 80, 0.3);
      transform: scale(1.02);
      position: relative;
    }
    
    .plan-card.current::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
      border-radius: 0.5rem 0.5rem 0 0;
    }

    .plan-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--primary-gradient);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .plan-badge.current {
      background: var(--primary-gradient);
      color: white;
      font-weight: 700;
      font-size: 0.8rem;
      padding: 0.6rem 1.2rem;
      box-shadow: 0 4px 15px rgba(255, 0, 80, 0.4);
      z-index: 10;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .plan-name {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .plan-price {
      font-size: 2.5rem;
      font-weight: 800;
      margin: 1rem 0;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .plan-price .currency {
      font-size: 1.5rem;
      vertical-align: top;
    }

    .plan-price .period {
      font-size: 1rem;
      color: var(--text-secondary);
      font-weight: 400;
    }

    .plan-description {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    .plan-features {
      list-style: none;
      margin-bottom: 2rem;
    }

    .plan-features li {
      padding: 0.5rem 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .plan-features li i {
      color: var(--accent-color);
      width: 20px;
    }

    .plan-btn {
      width: 100%;
      padding: 1rem;
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      margin-top: auto;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .plan-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 0, 80, 0.3);
    }

    .plan-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .plan-btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }

    .plan-btn.current {
      background: var(--primary-gradient);
      color: white;
      border: 2px solid var(--accent-color);
      box-shadow: 0 4px 15px rgba(255, 0, 80, 0.3);
      font-weight: 700;
      cursor: default;
    }
    
    .plan-btn.current:hover {
      transform: none;
      box-shadow: 0 4px 15px rgba(255, 0, 80, 0.3);
    }

    .plan-btn.downgrade {
      background: linear-gradient(135deg, rgba(255, 165, 0, 0.2), rgba(255, 69, 0, 0.2));
      border: 2px solid rgba(255, 165, 0, 0.5);
      color: white;
    }

    .plan-btn.downgrade:hover {
      background: linear-gradient(135deg, rgba(255, 165, 0, 0.3), rgba(255, 69, 0, 0.3));
      border: 2px solid rgba(255, 165, 0, 0.7);
    }

    /* Role onboarding buttons */
    .role-btn {
      width: 100%;
    }

    .role-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 0, 80, 0.3);
      opacity: 0.95;
    }

    @media (max-width: 768px) {
      .role-btn {
        min-width: 100%;
      }
    }

    /* Confirmation Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: var(--background-color);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .modal-actions .btn {
      flex: 1;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-primary);
      border: none;
    }
    
    .modal-actions .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .comparison-table {
      margin: 1rem 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.5rem;
      overflow: hidden;
    }

    .comparison-table tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .comparison-table tr:last-child {
      border-bottom: none;
    }

    .comparison-table td {
      padding: 0.75rem 1rem;
    }

    .comparison-table td:first-child {
      font-weight: 600;
      color: var(--text-secondary);
      width: 40%;
    }

    .comparison-table .old-value {
      color: rgba(255, 0, 80, 0.8);
      text-decoration: line-through;
    }

    .comparison-table .new-value {
      color: var(--accent-color);
      font-weight: 600;
    }

    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .error-message {
      background: rgba(255, 0, 80, 0.1);
      border: 1px solid rgba(255, 0, 80, 0.3);
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      color: #ff6b6b;
    }

    .success-message {
      background: rgba(0, 255, 0, 0.1);
      border: 1px solid rgba(0, 255, 0, 0.3);
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      color: #00ff00;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      .plans-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
        justify-items: stretch;
      }

      .quota-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 class="title"><i class="fas fa-crown"></i> Subscription Plans</h1>
    <div class="nav" id="authNav"></div>
  </div>

  <div class="container">
    <div id="alert-container"></div>

    <!-- Confirmation Modal (for plan changes) -->
    <div id="confirmationModal" class="modal-overlay">
      <div class="modal-content">
        <h3 id="modalTitle"></h3>
        <div id="modalBody"></div>
        <div class="modal-actions">
          <button class="btn" onclick="closeConfirmationModal()" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary);">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button id="modalConfirmBtn" class="btn" style="background: var(--primary-gradient);">
            <i class="fas fa-check"></i> Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- Tanda Confirm Modal (for general confirmations) -->
    <div id="tandaConfirmModal" class="modal-overlay">
      <div class="modal-content">
        <h3 id="tandaConfirmTitle">Confirm Action</h3>
        <div id="tandaConfirmBody" style="margin-bottom: 1.5rem; line-height: 1.6; color: var(--text-primary);"></div>
        <div class="modal-actions">
          <button class="btn" id="tandaConfirmCancel" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary);">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button id="tandaConfirmBtn" class="btn" style="background: var(--primary-gradient);">
            <i class="fas fa-check"></i> Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- Current Quota Status -->
    <div class="quota-status" id="quotaStatus">
      <h2><i class="fas fa-chart-line"></i> Your Current Plan</h2>
      <div class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading quota status...
      </div>
    </div>

    <!-- Subscription Management & History -->
    <div class="quota-status" id="subscriptionHistory" style="display: none;">
      <h2><i class="fas fa-history"></i> Payment History</h2>
      <div id="subscriptionHistoryContent">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i> Loading payment history...
        </div>
      </div>
    </div>

    <!-- Affiliate Links Management Section -->
    <div class="quota-status" id="affiliateLinksSection">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
        <h2><i class="fas fa-link"></i> Affiliate Links</h2>
        <button onclick="showAddAffiliateLinkForm()"
                style="padding: 0.75rem 1.5rem; background: var(--primary-gradient); border: none; border-radius: 0.5rem; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-plus"></i> Add Affiliate Link
        </button>
      </div>
      
      <div style="padding: 1rem; background: rgba(0, 242, 234, 0.1); border: 1px solid rgba(0, 242, 234, 0.3); border-radius: 0.75rem; margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
          <i class="fas fa-info-circle" style="color: #00f2ea; font-size: 1.2rem;"></i>
          <div style="font-weight: 600; color: var(--accent-color);">How Affiliate Links Work</div>
        </div>
        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-left: 2rem;">
          Add your affiliate links for platforms like Jumia, Amazon, Konga, Temu, etc. When you tag external products in your videos, your affiliate links will be used automatically, allowing you to earn commissions on sales.
        </div>
      </div>

      <div id="affiliateLinksContent">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i> Loading affiliate links...
        </div>
      </div>
    </div>

    <!-- Add/Edit Affiliate Link Modal -->
    <div id="affiliateLinkModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; padding: 1rem;">
      <div style="background: var(--bg-secondary); border-radius: var(--border-radius); padding: 2rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2 style="font-size: 1.5rem; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
            <i class="fas fa-link"></i> <span id="affiliateLinkModalTitle">Add Affiliate Link</span>
          </h2>
          <button onclick="closeAffiliateLinkModal()" style="background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 0.5rem;">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form id="affiliateLinkForm" onsubmit="saveAffiliateLink(event); return false;">
          <input type="hidden" id="affiliateLinkId" value="">
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Platform <span style="color: #ff0050;">*</span>
            </label>
            <select id="affiliateLinkPlatform" required
                    style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text-primary); font-size: 1rem;">
              <option value="">Select Platform</option>
              <option value="jumia">Jumia Nigeria</option>
              <option value="amazon">Amazon</option>
              <option value="konga">Konga</option>
              <option value="temu">Temu</option>
              <option value="aliexpress">AliExpress</option>
              <option value="shopify">Shopify Store</option>
              <option value="custom">Custom URL</option>
            </select>
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Affiliate URL <span style="color: #ff0050;">*</span>
            </label>
            <input type="url" id="affiliateLinkUrl" required
                   placeholder="https://jumia.com.ng/...?affcode=YOUR_ID or just YOUR_AFFILIATE_ID"
                   style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text-primary); font-size: 1rem;">
            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
              Enter your full affiliate URL or just your affiliate ID/parameter
            </div>
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Affiliate ID (Optional)
            </label>
            <input type="text" id="affiliateLinkIdField"
                   placeholder="Just the affiliate ID (e.g., TANDA123)"
                   style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text-primary); font-size: 1rem;">
            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
              Optional: Just the affiliate ID for reference
            </div>
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Notes (Optional)
            </label>
            <textarea id="affiliateLinkNotes" rows="3"
                      placeholder="Any notes about this affiliate link..."
                      style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text-primary); font-size: 1rem; resize: vertical; font-family: inherit;"></textarea>
          </div>
          
          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button type="button" onclick="closeAffiliateLinkModal()"
                    style="padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text-primary); font-weight: 600; cursor: pointer;">
              Cancel
            </button>
            <button type="submit"
                    style="padding: 0.75rem 1.5rem; background: var(--primary-gradient); border: none; border-radius: 0.5rem; color: white; font-weight: 600; cursor: pointer;">
              <i class="fas fa-save"></i> Save
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Subscription Plans -->
    <div id="plansSection">
      <h2 style="margin-bottom: 1rem; color: var(--accent-color);">
        <i class="fas fa-rocket"></i> Choose Your Plan
      </h2>
      <div class="plans-grid" id="plansGrid">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i> Loading plans...
        </div>
      </div>
    </div>
  </div>

  <script src="js/security-utils.js"></script>
  <script src="js/super-affiliate-api.js"></script>
  <script>
    SuperAffiliateAPI.renderAuthNav('authNav');
    if (!SuperAffiliateAPI.isAuthenticated()) {
      window.location.href = 'super-affiliate-login.html';
    }

    let currentPlanId = null;
    let plans = [];
    let quota = null;
    let userRoleStatus = null; // Track user's seller/affiliate status

    // Format number with commas
    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Format price in Naira
    // Backend stores prices in USD (1 USD = 1000 NGN), so multiply by 1000
    function formatPrice(price) {
      const num = parseFloat(price);
      if (num === 0) {
        return '0';
      }
      // Convert USD to NGN: 1 USD = 1000 NGN (matching Flutter app)
      const priceNGN = Math.round(num * 1000);
      return formatNumber(priceNGN);
    }

    // Show alert message
    function showAlert(message, type = 'error') {
      const container = document.getElementById('alert-container');
      const alertClass = type === 'error' ? 'error-message' : 'success-message';
      // Use SecurityUtils for safe HTML rendering
      const safeMessage = window.SecurityUtils ? SecurityUtils.sanitizeText(message) : message.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      if (window.SecurityUtils) {
        SecurityUtils.setInnerHTML(container, `<div class="${alertClass}">${safeMessage}</div>`, true);
      } else {
        container.innerHTML = `<div class="${alertClass}">${safeMessage}</div>`;
      }
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }

    // Load quota status
    async function loadQuotaStatus() {
      try {
        const response = await SuperAffiliateAPI.apiRequest('/videos/overlay-quota/');
        quota = response;
        currentPlanId = response.plan?.id || null;
        console.log('üìä Current plan ID:', currentPlanId, 'Plan name:', response.plan?.name);

        const quotaStatusEl = document.getElementById('quotaStatus');
        const plan = response.plan;
        const usage = response.usage;

        if (plan) {
          const productsUsed = usage.products_used_this_month || 0;
          const productsLimit = plan.max_products_per_month === 0 ? '‚àû' : plan.max_products_per_month;
          const videosUsed = usage.videos_used_this_month || 0;
          const videosLimit = plan.max_videos_per_month === 0 ? '‚àû' : plan.max_videos_per_month;

          // Check for quota warnings
          const productsWarning = productsLimit !== '‚àû' && productsUsed >= productsLimit ? 
            '<div style="color: #ff0050; font-size: 0.75rem; margin-top: 0.25rem;">‚ö†Ô∏è Limit reached</div>' : '';
          const videosWarning = videosLimit !== '‚àû' && videosUsed >= videosLimit ? 
            '<div style="color: #ff0050; font-size: 0.75rem; margin-top: 0.25rem;">‚ö†Ô∏è Limit reached</div>' : '';

          // Show subscription end date if available
          let subscriptionEndHTML = '';
          if (response.subscription_ends_at) {
            const endsAt = new Date(response.subscription_ends_at);
            const daysLeft = Math.ceil((endsAt - new Date()) / (1000 * 60 * 60 * 24));
            const isExpiringSoon = daysLeft <= 7;
            subscriptionEndHTML = `
              <div class="quota-item">
                <div class="quota-item-label">Subscription Ends</div>
                <div class="quota-item-value" style="color: ${isExpiringSoon ? '#ff0050' : 'inherit'}; font-size: 1.2rem;">
                  ${endsAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                </div>
                <div class="quota-item-limit" style="color: ${isExpiringSoon ? '#ff0050' : 'var(--text-secondary)'};">
                  ${daysLeft} day${daysLeft !== 1 ? 's' : ''} left
                </div>
              </div>
            `;
          }

          // Show scheduled downgrade notice if exists
          let scheduledDowngradeHTML = '';
          if (response.scheduled_downgrade_plan && response.scheduled_downgrade_at) {
            const downgradeDate = new Date(response.scheduled_downgrade_at);
            scheduledDowngradeHTML = `
              <div style="padding: 1rem; background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.3); border-radius: 0.75rem; margin-top: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                  <i class="fas fa-clock" style="color: orange; font-size: 1.5rem;"></i>
                  <div>
                    <div style="font-weight: bold; margin-bottom: 0.25rem;">
                      <i class="fas fa-arrow-down"></i> Scheduled Plan Change
                    </div>
                    <div style="font-size: 0.9rem;">
                      Your plan will change to <strong>${response.scheduled_downgrade_plan.name}</strong> on 
                      <strong>${downgradeDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</strong>.
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">
                      You'll keep all your current ${plan.name} plan benefits until then, including your remaining quota.
                    </div>
                  </div>
                </div>
              </div>
            `;
          }

          // Subscription management section (only for paid plans)
          const isPaidPlan = parseFloat(plan.price_per_month) > 0;
          const autoRenew = response.auto_renew !== undefined ? response.auto_renew : true;
          let subscriptionManagementHTML = '';
          
          if (isPaidPlan) {
            subscriptionManagementHTML = `
              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                  <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                    <div>
                      <div style="font-weight: 600; margin-bottom: 0.25rem;">Auto-Renewal</div>
                      <div style="font-size: 0.85rem; color: var(--text-secondary);">
                        ${autoRenew ? 'Your subscription will automatically renew' : 'Auto-renewal is disabled. Your subscription will end on the expiration date.'}
                      </div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 60px; height: 34px; cursor: pointer;">
                      <input type="checkbox" id="autoRenewToggle" ${autoRenew ? 'checked' : ''} 
                             onchange="toggleAutoRenew(this.checked)" 
                             style="opacity: 0; width: 0; height: 0;">
                      <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${autoRenew ? '#00f2ea' : '#ccc'}; transition: 0.3s; border-radius: 34px;">
                        <span style="position: absolute; content: ''; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.3s; border-radius: 50%; ${autoRenew ? 'transform: translateX(26px);' : ''}"></span>
                      </span>
                    </label>
                  </div>
                  <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button onclick="cancelSubscription()" 
                            style="padding: 0.75rem 1.5rem; background: rgba(255, 0, 80, 0.2); border: 1px solid rgba(255, 0, 80, 0.4); border-radius: 0.5rem; color: #ff6b6b; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;">
                      <i class="fas fa-times-circle"></i> Cancel Subscription
                    </button>
                    <button onclick="loadSubscriptionHistory()" 
                            style="padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text-primary); font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;">
                      <i class="fas fa-history"></i> Payment History
                    </button>
                  </div>
                </div>
              </div>
            `;
          }

          quotaStatusEl.innerHTML = `
            <h2><i class="fas fa-chart-line"></i> Your Current Plan: ${plan.name}</h2>
            <div style="padding: 1rem; background: rgba(0, 242, 234, 0.1); border: 1px solid rgba(0, 242, 234, 0.3); border-radius: 0.75rem; margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <i class="fas fa-info-circle" style="color: #00f2ea; font-size: 1.2rem;"></i>
                <div style="font-weight: 600; color: var(--accent-color);">Free Tanda Products</div>
              </div>
              <div style="font-size: 0.9rem; color: var(--text-secondary); margin-left: 2rem;">
                Tagging TandaShop products is <strong>always free and unlimited</strong> on all plans. Only external (affiliate) products count toward your quota.
              </div>
            </div>
            <div class="quota-info">
              <div class="quota-item">
                <div class="quota-item-label">External Products This Month</div>
                <div class="quota-item-value">${productsUsed}</div>
                <div class="quota-item-limit">of ${productsLimit}${productsWarning}</div>
              </div>
              <div class="quota-item">
                <div class="quota-item-label">Videos This Month</div>
                <div class="quota-item-value">${videosUsed}</div>
                <div class="quota-item-limit">of ${videosLimit}${videosWarning}</div>
              </div>
              <div class="quota-item">
                <div class="quota-item-label">Plan Price</div>
                <div class="quota-item-value">‚Ç¶${formatPrice(plan.price_per_month)}</div>
                <div class="quota-item-limit">/mo</div>
              </div>
              ${subscriptionEndHTML}
            </div>
            ${scheduledDowngradeHTML}
            ${subscriptionManagementHTML}
          `;
        } else {
          quotaStatusEl.innerHTML = `
            <h2><i class="fas fa-chart-line"></i> No Active Plan</h2>
            <div style="padding: 1rem; background: rgba(0, 242, 234, 0.1); border: 1px solid rgba(0, 242, 234, 0.3); border-radius: 0.75rem; margin-bottom: 1rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <i class="fas fa-info-circle" style="color: #00f2ea; font-size: 1.2rem;"></i>
                <div style="font-weight: 600; color: var(--accent-color);">Good News: Tanda Products Are Free!</div>
              </div>
              <div style="font-size: 0.9rem; color: var(--text-secondary); margin-left: 2rem;">
                You can tag <strong>unlimited TandaShop products for free</strong> on any plan, including the free plan. Subscriptions only apply to external (affiliate) product quotas.
              </div>
            </div>
            <p style="color: var(--text-secondary);">Choose a plan below to get started with external product tagging.</p>
          `;
        }
      } catch (error) {
        console.error('Error loading quota status:', error);
        document.getElementById('quotaStatus').innerHTML = `
          <div class="error-message">Failed to load quota status. Please refresh the page.</div>
        `;
      }
    }

    // Load subscription plans
    async function loadPlans() {
      try {
        console.log('Loading subscription plans from /videos/subscription/plans/...');
        let response = await SuperAffiliateAPI.apiRequest('/videos/subscription/plans/');
        console.log('Plans API response:', response);
        console.log('Response type:', typeof response);
        console.log('Is array?', Array.isArray(response));
        console.log('Has plans key?', response?.plans !== undefined);
        console.log('Plans value:', response?.plans);
        
        // If subscription endpoint returns empty or error, try overlay-plans endpoint as fallback
        const hasPlans = (response?.plans && Array.isArray(response.plans) && response.plans.length > 0) || 
                         (Array.isArray(response) && response.length > 0);
        
        if (!response || response.error || !hasPlans) {
          console.log('Trying fallback endpoint /videos/overlay-plans/...');
          try {
            const fallbackResponse = await SuperAffiliateAPI.apiRequest('/videos/overlay-plans/');
            console.log('Fallback plans API response:', fallbackResponse);
            
            // Use fallback if it has plans
            if (fallbackResponse && 
                ((fallbackResponse.plans && Array.isArray(fallbackResponse.plans) && fallbackResponse.plans.length > 0) ||
                 (Array.isArray(fallbackResponse) && fallbackResponse.length > 0))) {
              response = fallbackResponse;
            }
          } catch (fallbackError) {
            console.warn('Fallback endpoint also failed:', fallbackError);
          }
        }
        
        // Check for error in response
        if (response?.error) {
          throw new Error(response.error);
        }
        
        // Handle different response structures
        // Response should be: { plans: [...] } or just [...]
        if (Array.isArray(response)) {
          plans = response;
        } else if (response?.plans && Array.isArray(response.plans)) {
          plans = response.plans;
        } else {
          plans = [];
        }

        console.log('Final parsed plans:', plans);
        console.log('Plans count:', plans.length);
        const plansGrid = document.getElementById('plansGrid');
        
        if (!Array.isArray(plans) || plans.length === 0) {
          console.warn('No plans found. Full response:', JSON.stringify(response, null, 2));
          plansGrid.innerHTML = `
            <div class="error-message">
              <p><strong>No subscription plans available.</strong></p>
              <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                ${response?.error ? `Error: ${response.error}` : 'Plans may not be configured yet. Please contact support.'}
              </p>
              <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                If you're an admin, ensure plans are seeded in the database using:<br>
                <code style="background: rgba(255,255,255,0.1); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">python manage.py seed_pricing_plans</code>
              </p>
              <button onclick="loadPlans()" class="btn" style="margin-top: 1rem;">
                <i class="fas fa-redo"></i> Retry
              </button>
            </div>
          `;
          return;
        }

        plansGrid.innerHTML = plans.map(plan => {
          // Ensure all fields have defaults
          const planId = plan.id || '';
          const planName = plan.name || 'Unnamed Plan';
          const pricePerMonth = parseFloat(plan.price_per_month || 0);
          const maxProducts = plan.max_products_per_month ?? 0;
          const maxVideos = plan.max_videos_per_month ?? 0;
          const isFeatured = plan.is_featured || false;
          const description = plan.description || '';
          const allowExternal = plan.allow_external_affiliate || false;
          const allowTanda = plan.allow_tanda_affiliate !== false; // Default to true
          const revenueSplit = plan.revenue_split_percentage || '70';
          const features = Array.isArray(plan.features) ? plan.features : [];
          
          // Compare by plan ID (more reliable) or fallback to plan name
          const isCurrentPlan = (currentPlanId && planId && currentPlanId === planId) || 
                                (!currentPlanId && quota?.plan?.name === planName);
          
          // Determine if this is an upgrade or downgrade
          const currentPlanPrice = quota?.plan?.price_per_month ? parseFloat(quota.plan.price_per_month) : 0;
          const isUpgrade = pricePerMonth > currentPlanPrice;
          const isDowngrade = pricePerMonth < currentPlanPrice && !isCurrentPlan;
          
          // Debug logging for plan comparison
          console.log(`Plan: ${planName} (‚Ç¶${pricePerMonth}), Current: ${quota?.plan?.name} (‚Ç¶${currentPlanPrice}), isUpgrade: ${isUpgrade}, isDowngrade: ${isDowngrade}, isCurrent: ${isCurrentPlan}`);
          
          const isFree = pricePerMonth === 0;
          const productsLimit = maxProducts === 0 ? 'Unlimited' : `${maxProducts}`;
          const videosLimit = maxVideos === 0 ? 'Unlimited' : `${maxVideos}`;

          return `
            <div class="plan-card ${isFeatured ? 'featured' : ''} ${isCurrentPlan ? 'current' : ''}">
              ${isFeatured ? '<div class="plan-badge">Popular</div>' : ''}
              ${isCurrentPlan ? '<div class="plan-badge current">Current Plan</div>' : ''}
              
              <div class="plan-name">${planName}</div>
              
              <div class="plan-price">
                <span class="currency">‚Ç¶</span>${formatPrice(pricePerMonth)}
                <span class="period">/mo</span>
              </div>
              
              ${description ? `<div class="plan-description">${description}</div>` : ''}
              
              <ul class="plan-features">
                <li><i class="fas fa-check" style="color: #00f2ea;"></i> <strong>Unlimited Tanda products</strong></li>
                <li><i class="fas fa-check"></i> ${productsLimit === 'Unlimited' ? '<strong>Unlimited</strong>' : productsLimit} <strong>external products</strong> /mo</li>
                <li><i class="fas fa-check"></i> ${videosLimit} videos /mo</li>
                ${allowExternal ? '<li><i class="fas fa-check"></i> Custom affiliate links</li>' : ''}
                ${allowTanda ? `<li><i class="fas fa-check"></i> Tanda affiliate (${revenueSplit}% commission)</li>` : ''}
                ${features.length > 0 ? features.map(f => {
                  // Skip features that are redundant (already shown above)
                  if (f.includes('Unlimited videos') || f.includes('Unlimited Tanda') || f.includes('external product tags')) {
                    return '';
                  }
                  return `<li><i class="fas fa-check"></i> ${f}</li>`;
                }).filter(f => f).join('') : ''}
              </ul>
              
              <button 
                class="plan-btn ${isCurrentPlan ? 'current' : isDowngrade ? 'downgrade' : ''}" 
                ${isCurrentPlan ? '' : `onclick="${isDowngrade ? `confirmPlanChange('${planId}', '${planName}', ${pricePerMonth}, ${maxProducts}, ${maxVideos}, ${isDowngrade})` : `selectPlan('${planId}', ${isCurrentPlan}, ${isFree})`}"`}
                ${isCurrentPlan ? 'disabled' : ''}
                ${isCurrentPlan ? 'style="cursor: not-allowed;"' : ''}
              >
                ${isCurrentPlan ? '<i class="fas fa-check-circle"></i> Current Plan' : 
                  isDowngrade ? '<i class="fas fa-arrow-down"></i> Downgrade' : 
                  isFree && !quota?.plan ? '<i class="fas fa-gift"></i> Get Started' : 
                  '<i class="fas fa-arrow-up"></i> Upgrade'}
              </button>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading plans:', error);
        const errorMsg = error?.message || error?.toString() || 'Unknown error';
        document.getElementById('plansGrid').innerHTML = `
          <div class="error-message">
            <p><strong>Failed to load subscription plans.</strong></p>
            <p style="margin-top: 0.5rem; font-size: 0.9rem;">Error: ${errorMsg}</p>
            <button onclick="loadPlans()" class="btn" style="margin-top: 1rem;">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
      }
    }

    // Show confirmation modal for plan changes
    function confirmPlanChange(planId, planName, newPrice, newMaxProducts, newMaxVideos, isDowngrade) {
      const currentPlan = quota?.plan;
      if (!currentPlan) return selectPlan(planId, false, newPrice === 0);

      const modal = document.getElementById('confirmationModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      const confirmBtn = document.getElementById('modalConfirmBtn');

      const endsAt = quota.subscription_ends_at ? new Date(quota.subscription_ends_at) : null;
      const endsAtStr = endsAt ? endsAt.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : 'the end of your billing cycle';

      if (isDowngrade) {
        modalTitle.innerHTML = '<i class="fas fa-arrow-down"></i> Confirm Plan Downgrade';
        modalBody.innerHTML = `
          <div style="margin-bottom: 1rem;">
            <p><strong>You're about to downgrade from ${currentPlan.name} to ${planName}.</strong></p>
            <p style="margin-top: 0.5rem; padding: 1rem; background: rgba(0, 200, 100, 0.1); border: 1px solid rgba(0, 200, 100, 0.3); border-radius: 0.5rem;">
              <i class="fas fa-info-circle"></i> <strong>Don't worry!</strong> You'll keep all your current ${currentPlan.name} benefits until <strong>${endsAtStr}</strong>. 
              After that, your plan will change to ${planName}.
            </p>
          </div>
          
          <table class="comparison-table">
            <tr>
              <td>Monthly Price</td>
              <td>
                <span class="old-value">‚Ç¶${formatPrice(currentPlan.price_per_month)}</span> 
                ‚Üí <span class="new-value">‚Ç¶${formatPrice(newPrice)}</span>
              </td>
            </tr>
            <tr>
              <td>Products/Month</td>
              <td>
                <span class="old-value">${currentPlan.max_products_per_month === 0 ? 'Unlimited' : currentPlan.max_products_per_month}</span> 
                ‚Üí <span class="new-value">${newMaxProducts === 0 ? 'Unlimited' : newMaxProducts}</span>
              </td>
            </tr>
            <tr>
              <td>Videos/Month</td>
              <td>
                <span class="old-value">${currentPlan.max_videos_per_month === 0 ? 'Unlimited' : currentPlan.max_videos_per_month}</span> 
                ‚Üí <span class="new-value">${newMaxVideos === 0 ? 'Unlimited' : newMaxVideos}</span>
              </td>
            </tr>
          </table>
          
          <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary);">
            <i class="fas fa-shield-alt"></i> Your unused quota will not be lost - you can use it until ${endsAtStr}.
          </div>
        `;
      }

      confirmBtn.onclick = () => {
        closeConfirmationModal();
        selectPlan(planId, false, newPrice === 0);
      };

      modal.classList.add('show');
    }

    function closeConfirmationModal() {
      document.getElementById('confirmationModal').classList.remove('show');
    }

    // Tanda Confirm Modal Functions
    let tandaConfirmResolve = null;
    
    function showTandaConfirm(title, message, confirmText = 'Confirm', cancelText = 'Cancel', isDanger = false) {
      return new Promise((resolve) => {
        tandaConfirmResolve = resolve;
        const modal = document.getElementById('tandaConfirmModal');
        const titleEl = document.getElementById('tandaConfirmTitle');
        const bodyEl = document.getElementById('tandaConfirmBody');
        const confirmBtn = document.getElementById('tandaConfirmBtn');
        const cancelBtn = document.getElementById('tandaConfirmCancel');
        
        titleEl.textContent = title;
        bodyEl.innerHTML = message.replace(/\n/g, '<br>');
        confirmBtn.innerHTML = `<i class="fas fa-check"></i> ${confirmText}`;
        cancelBtn.innerHTML = `<i class="fas fa-times"></i> ${cancelText}`;
        
        if (isDanger) {
          confirmBtn.style.background = 'linear-gradient(135deg, rgba(255, 0, 80, 0.8), rgba(255, 0, 80, 0.6))';
        } else {
          confirmBtn.style.background = 'var(--primary-gradient)';
        }
        
        modal.classList.add('show');
        
        // Handle confirm
        confirmBtn.onclick = () => {
          closeTandaConfirm();
          resolve(true);
        };
        
        // Handle cancel
        cancelBtn.onclick = () => {
          closeTandaConfirm();
          resolve(false);
        };
        
        // Close on backdrop click
        modal.onclick = (e) => {
          if (e.target === modal) {
            closeTandaConfirm();
            resolve(false);
          }
        };
      });
    }
    
    function closeTandaConfirm() {
      const modal = document.getElementById('tandaConfirmModal');
      modal.classList.remove('show');
      if (tandaConfirmResolve) {
        tandaConfirmResolve(false);
        tandaConfirmResolve = null;
      }
    }

    // Close modal on ESC key or clicking outside
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeConfirmationModal();
        closeTandaConfirm();
      }
    });

    document.getElementById('confirmationModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'confirmationModal') {
        closeConfirmationModal();
      }
    });
    
    document.getElementById('tandaConfirmModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'tandaConfirmModal') {
        closeTandaConfirm();
      }
    });

    // Select and subscribe to a plan
    async function selectPlan(planId, isCurrent, isFree) {
      // Prevent action if this is already the current plan
      if (isCurrent) {
        showAlert('This is already your current plan. You cannot subscribe to the same plan twice.', 'error');
        return;
      }

      // Extra safety check: if free plan and user is already on free, don't proceed
      if (isFree && quota?.plan?.name?.toLowerCase() === 'free') {
        showAlert('You are already on the Free plan.', 'error');
        return;
      }

      try {
        // Initialize subscription (handles both free and paid plans)
        const response = await SuperAffiliateAPI.apiRequest(`/videos/subscription/initialize/${planId}/`, {
          method: 'POST',
        });

        if (response.success) {
          // Check if plan was assigned immediately (free plan upgrade)
          if (response.plan_assigned === true) {
            showAlert(`Successfully subscribed to ${response.plan_name || 'plan'}!`, 'success');
            setTimeout(async () => {
              await loadQuotaStatus();
              await loadPlans();
            }, 1000);
            return;
          }
          
          // Check if this is a scheduled downgrade (free plan from paid)
          if (response.scheduled_downgrade === true) {
            showAlert(response.message || `Downgrade to ${response.plan_name} scheduled successfully.`, 'success');
            setTimeout(async () => {
              await loadQuotaStatus();
              await loadPlans();
            }, 1000);
            return;
          }
          
          // Check for payment URL (paid plan)
          const paymentUrl = response.authorization_url || response.payment_url;
          if (paymentUrl) {
            // Store reference for cancellation tracking
            if (response.reference) {
              sessionStorage.setItem('pending_subscription_reference', response.reference);
              sessionStorage.setItem('pending_subscription_plan_id', planId);
            }
            
            // Redirect to payment page
            window.location.href = paymentUrl;
            return;
          }
          
          // No payment URL and no plan_assigned/scheduled_downgrade flags
          // This might mean the backend is returning success: true but with no action
          // (e.g., user already on this plan or some other edge case)
          console.error('Unexpected backend response:', response);
          console.log('Plan ID:', planId, 'isFree:', isFree, 'isCurrent:', isCurrent);
          
          // Check if backend returned the plan was already assigned
          if (response.message && response.message.includes('already')) {
            showAlert(response.message, 'error');
            setTimeout(async () => {
              await loadQuotaStatus();
              await loadPlans();
            }, 1000);
          } else {
            // Generic error for unexpected response
            showAlert('Subscription update completed but response was unclear. Refreshing...', 'warning');
            setTimeout(async () => {
              await loadQuotaStatus();
              await loadPlans();
            }, 1500);
          }
        } else {
          // Check if error is about missing role
          if (response.requires_role || response.redirect_to === 'role_onboarding') {
            showAlert('You must be an approved seller or affiliate to subscribe. Please complete role onboarding first.', 'error');
            // Redirect to role selection after 2 seconds
            setTimeout(async () => {
              const wantsRole = await showTandaConfirm(
                'Role Required',
                'Would you like to become a seller or affiliate now?',
                'Yes',
                'No',
                false
              );
              
              if (wantsRole) {
                const choice = await showTandaConfirm(
                  'Choose Role',
                  'Click Confirm for Seller, Cancel for Affiliate',
                  'Seller',
                  'Affiliate',
                  false
                );
                if (choice) {
                  window.location.href = 'become-seller.html';
                } else {
                  window.location.href = 'become-affiliate.html';
                }
              }
            }, 2000);
          } else {
            showAlert(response.error || 'Failed to initialize subscription.', 'error');
          }
        }
      } catch (error) {
        console.error('Error selecting plan:', error);
        
        // Check if error response contains role requirement
        // SuperAffiliateAPI.apiRequest throws errors with responseData property
        if (error.responseData) {
          if (error.responseData.requires_role || error.responseData.redirect_to === 'role_onboarding') {
            showAlert('You must be an approved seller or affiliate to subscribe. Please complete role onboarding first.', 'error');
            setTimeout(async () => {
              const wantsRole = await showTandaConfirm(
                'Role Required',
                'Would you like to become a seller or affiliate now?',
                'Yes',
                'No',
                false
              );
              
              if (wantsRole) {
                const choice = await showTandaConfirm(
                  'Choose Role',
                  'Click Confirm for Seller, Cancel for Affiliate',
                  'Seller',
                  'Affiliate',
                  false
                );
                if (choice) {
                  window.location.href = 'become-seller.html';
                } else {
                  window.location.href = 'become-affiliate.html';
                }
              }
            }, 2000);
            return;
          }
        }
        
        // Check error message for role requirement keywords
        const errorMsg = error.message || 'Failed to process subscription. Please try again.';
        if (errorMsg.includes('approved seller') || errorMsg.includes('approved affiliate') || errorMsg.includes('role onboarding')) {
          showAlert('You must be an approved seller or affiliate to subscribe. Please complete role onboarding first.', 'error');
          setTimeout(async () => {
            const wantsRole = await showTandaConfirm(
              'Role Required',
              'Would you like to become a seller or affiliate now?',
              'Yes',
              'No',
              false
            );
            
            if (wantsRole) {
              const choice = await showTandaConfirm(
                'Choose Role',
                'Click Confirm for Seller, Cancel for Affiliate',
                'Seller',
                'Affiliate',
                false
              );
              if (choice) {
                window.location.href = 'become-seller.html';
              } else {
                window.location.href = 'become-affiliate.html';
              }
            }
          }, 2000);
          return;
        }
        
        showAlert(errorMsg, 'error');
      }
    }

    // Verify payment after Paystack redirect
    async function verifyPayment(reference, planId) {
      try {
        const response = await SuperAffiliateAPI.apiRequest('/videos/subscription/verify/', {
          method: 'POST',
          body: JSON.stringify({ reference }),
        });

        if (response.success) {
          showAlert(`Successfully subscribed to ${response.plan_name}!`, 'success');
          setTimeout(async () => {
            await loadQuotaStatus();
            await loadPlans();
          }, 1000);
        } else {
          showAlert(response.error || 'Payment verification failed.', 'error');
        }
      } catch (error) {
        console.error('Error verifying payment:', error);
        showAlert('Payment verification failed. Please contact support.', 'error');
      }
    }

    // Check if we're returning from Paystack
    const urlParams = new URLSearchParams(window.location.search);
    const reference = urlParams.get('reference');
    if (reference) {
      verifyPayment(reference, null);
    }

    // Check user role status (seller/affiliate)
    async function checkUserRole() {
      try {
        // Check if user is seller or affiliate
        let isSeller = false;
        let isAffiliate = false;
        let sellerStatus = null;
        let affiliateStatus = null;
        
        // Check seller status
        try {
          const sellerResponse = await SuperAffiliateAPI.apiRequest('/commerce/seller/profile/');
          if (sellerResponse && sellerResponse.status === 'approved') {
            isSeller = true;
            sellerStatus = sellerResponse.status;
            console.log('‚úÖ User is an approved seller');
          } else if (sellerResponse && sellerResponse.status) {
            console.log('‚ÑπÔ∏è User is a seller but status is:', sellerResponse.status);
          }
        } catch (e) {
          // User is not a seller or endpoint doesn't exist (404 is expected for non-sellers)
          if (e.message && !e.message.includes('404')) {
            console.log('Error checking seller status:', e);
          }
        }
        
        // Check affiliate status
        try {
          const affiliateResponse = await SuperAffiliateAPI.apiRequest('/commerce/affiliate/profile/');
          console.log('üìã Affiliate profile response:', affiliateResponse);
          
          if (affiliateResponse) {
            const status = affiliateResponse.status;
            console.log('üìä Affiliate status:', status);
            
            if (status === 'approved') {
              isAffiliate = true;
              affiliateStatus = status;
              console.log('‚úÖ User is an approved affiliate');
            } else if (status) {
              console.log('‚ÑπÔ∏è User is an affiliate but status is:', status, '(not approved)');
            }
          }
        } catch (e) {
          // User is not an affiliate or endpoint doesn't exist (404 is expected for non-affiliates)
          const errorMsg = e.message || e.toString();
          if (!errorMsg.includes('404') && !errorMsg.includes('Not Found')) {
            console.error('‚ùå Error checking affiliate status:', e);
          } else {
            console.log('‚ÑπÔ∏è User does not have an affiliate profile (404 expected)');
          }
        }
        
        userRoleStatus = {
          isSeller,
          isAffiliate,
          sellerStatus,
          affiliateStatus,
          hasRole: isSeller || isAffiliate
        };
        
        // Check if user is admin/staff (can bypass role check)
        try {
          const userProfile = await SuperAffiliateAPI.getUserProfile();
          if (userProfile && (userProfile.is_staff || userProfile.is_superuser || userProfile.role === 'admin')) {
            userRoleStatus.hasRole = true; // Admin/staff can subscribe
            console.log('‚úÖ User is admin/staff - can subscribe');
          }
        } catch (e) {
          // If we can't get user profile, continue with role check
          console.log('Could not fetch user profile for admin check:', e);
        }
        
        console.log('üìä Role check result:', userRoleStatus);
        return userRoleStatus;
      } catch (error) {
        console.error('Error checking user role:', error);
        return { hasRole: false, isSeller: false, isAffiliate: false };
      }
    }
    
    // Show role onboarding message
    function showRoleOnboardingMessage() {
      const quotaStatusEl = document.getElementById('quotaStatus');
      quotaStatusEl.innerHTML = `
        <h2 style="color: var(--accent-color); margin-bottom: 1rem;">
          <i class="fas fa-exclamation-triangle"></i> Role Required
        </h2>
        <div style="background: var(--bg-card); backdrop-filter: blur(20px); border-radius: var(--border-radius); border: 1px solid rgba(255,255,255,0.1); padding: 2rem; margin-top: 1rem;">
          <p style="margin-bottom: 1rem; line-height: 1.6; color: var(--text-primary); font-size: 1rem;">
            To subscribe to a plan and tag products in your videos, you must first become an <strong>approved seller</strong> or <strong>approved affiliate</strong>.
          </p>
          <div style="padding: 1rem; background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.3); border-radius: 0.75rem; margin-bottom: 1.5rem;">
            <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; margin: 0;">
              <i class="fas fa-info-circle" style="color: #ffb703; margin-right: 0.5rem;"></i>
              Subscriptions are only available to sellers and affiliates because product tagging requires role verification.
            </p>
          </div>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
            <a href="become-seller.html" class="role-btn" style="background: var(--primary-gradient); flex: 1; min-width: 200px; text-align: center; padding: 1rem 1.5rem; border-radius: 0.5rem; font-weight: 600; text-decoration: none; color: white; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 1rem; border: none; cursor: pointer;">
              <i class="fas fa-store"></i> Become a Seller
            </a>
            <a href="become-affiliate.html" class="role-btn" style="background: var(--primary-gradient); flex: 1; min-width: 200px; text-align: center; padding: 1rem 1.5rem; border-radius: 0.5rem; font-weight: 600; text-decoration: none; color: white; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 1rem; border: none; cursor: pointer;">
              <i class="fas fa-bullhorn"></i> Become an Affiliate
            </a>
          </div>
          <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary); text-align: center;">
            After approval, you can return here to subscribe to a plan.
          </p>
        </div>
      `;
    }
    
    // Load data on page load - MUST check role first, then quota, then plans
    async function initializePage() {
      try {
        // Clear any existing loading states
        const plansGrid = document.getElementById('plansGrid');
        if (plansGrid) {
          plansGrid.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading plans...</div>';
        }
        
        // Step 1: Check user role
        console.log('üîç Step 1: Checking user role...');
        const roleStatus = await checkUserRole();
        console.log('üìä Role check completed:', roleStatus);
        
        if (!roleStatus.hasRole) {
          // User doesn't have required role - show onboarding message
          console.log('‚ùå User does not have required role. Showing onboarding message.');
          showRoleOnboardingMessage();
          
          // Clear the plans grid loading state
          if (plansGrid) {
            plansGrid.innerHTML = '';
          }
          
          // Don't load plans - user can't subscribe anyway
          return;
        }
        
        console.log('‚úÖ User has required role. Proceeding to load quota and plans...');
        
        // Step 2: Load quota status (needed for current plan)
        await loadQuotaStatus();

        // Step 3: Load plans (needs currentPlanId)
        await loadPlans();
        
        // Step 4: Load affiliate links
        await loadAffiliateLinks();
        
        // Step 5: Check for payment callback parameters
        const urlParams = new URLSearchParams(window.location.search);
        const paymentStatus = urlParams.get('payment');
        const planName = urlParams.get('plan');
        const errorMsg = urlParams.get('error');
        const cancelled = urlParams.get('cancelled');
        
        // Clear pending subscription tracking
        const pendingRef = sessionStorage.getItem('pending_subscription_reference');
        if (pendingRef && (paymentStatus === 'success' || paymentStatus === 'failed' || cancelled)) {
          sessionStorage.removeItem('pending_subscription_reference');
          sessionStorage.removeItem('pending_subscription_plan_id');
        }
        
        if (paymentStatus === 'success') {
          const message = urlParams.get('message') || `Successfully subscribed to ${planName || 'plan'}!`;
          showAlert(message, 'success');
          // Clean URL
          window.history.replaceState({}, document.title, '/subscription.html');
          // Reload quota to show updated status
          await loadQuotaStatus();
        } else if (paymentStatus === 'failed') {
          const error = errorMsg ? decodeURIComponent(errorMsg) : 'Payment failed. Please try again.';
          showAlert(error, 'error');
          // Clean URL
          window.history.replaceState({}, document.title, '/subscription.html');
        } else if (cancelled === 'true') {
          showAlert('Payment was cancelled. You can try again anytime.', 'warning');
          // Clean URL
          window.history.replaceState({}, document.title, '/subscription.html');
        }
        
        // Check if user returned from Paystack without reference (likely cancelled)
        // This handles the case where user closes Paystack window or navigates back
        if (!paymentStatus && !cancelled && pendingRef && document.referrer.includes('paystack')) {
          // User likely cancelled - show message
          showAlert('Payment was cancelled. You can try subscribing again anytime.', 'info');
          sessionStorage.removeItem('pending_subscription_reference');
          sessionStorage.removeItem('pending_subscription_plan_id');
        }
      } catch (error) {
        console.error('‚ùå Error in initializePage:', error);
        const plansGrid = document.getElementById('plansGrid');
        if (plansGrid) {
          plansGrid.innerHTML = `
            <div class="error-message">
              <p><strong>Error loading subscription page.</strong></p>
              <p style="margin-top: 0.5rem; font-size: 0.9rem;">${error.message || 'Unknown error occurred'}</p>
              <button onclick="location.reload()" class="btn" style="margin-top: 1rem;">
                <i class="fas fa-redo"></i> Reload Page
              </button>
            </div>
          `;
        }
      }
    }
    
    // Cancel subscription (disable auto-renew)
    async function cancelSubscription() {
      const confirmed = await showTandaConfirm(
        'Cancel Subscription?',
        'Are you sure you want to cancel your subscription?<br><br>Your subscription will remain active until the end of your billing cycle, but it will not auto-renew. You can re-enable auto-renewal at any time before your subscription expires.',
        'Cancel Subscription',
        'Keep Subscription',
        false
      );
      
      if (!confirmed) {
        return;
      }

      try {
        showAlert('Cancelling subscription...', 'info');
        const response = await SuperAffiliateAPI.apiRequest('/videos/subscription/cancel/', {
          method: 'POST',
        });

        if (response.success) {
          showAlert(response.message || 'Subscription auto-renewal has been cancelled.', 'success');
          setTimeout(async () => {
            await loadQuotaStatus();
          }, 1000);
        } else {
          showAlert(response.error || 'Failed to cancel subscription', 'error');
        }
      } catch (error) {
        console.error('Error cancelling subscription:', error);
        showAlert(error.message || 'Failed to cancel subscription. Please try again.', 'error');
      }
    }

    // Toggle auto-renewal
    async function toggleAutoRenew(enabled) {
      try {
        const response = await SuperAffiliateAPI.apiRequest('/videos/subscription/toggle-auto-renew/', {
          method: 'POST',
          body: JSON.stringify({ auto_renew: enabled }),
        });

        if (response.success) {
          showAlert(response.message || `Auto-renewal has been ${enabled ? 'enabled' : 'disabled'}.`, 'success');
          setTimeout(async () => {
            await loadQuotaStatus();
          }, 1000);
        } else {
          showAlert(response.error || 'Failed to update auto-renewal setting', 'error');
          // Revert checkbox state on error
          const toggle = document.getElementById('autoRenewToggle');
          if (toggle) toggle.checked = !enabled;
        }
      } catch (error) {
        console.error('Error toggling auto-renew:', error);
        showAlert(error.message || 'Failed to update auto-renewal setting. Please try again.', 'error');
        // Revert checkbox state on error
        const toggle = document.getElementById('autoRenewToggle');
        if (toggle) toggle.checked = !enabled;
      }
    }

    // Load subscription payment history
    async function loadSubscriptionHistory() {
      const historySection = document.getElementById('subscriptionHistory');
      const historyContent = document.getElementById('subscriptionHistoryContent');
      
      // Toggle visibility
      if (historySection.style.display === 'none') {
        historySection.style.display = 'block';
        historyContent.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading payment history...</div>';
        
        try {
          const response = await SuperAffiliateAPI.apiRequest('/videos/subscription/history/');
          const transactions = response.transactions || [];
          
          if (transactions.length === 0) {
            historyContent.innerHTML = `
              <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <i class="fas fa-receipt" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                <p>No payment history found.</p>
              </div>
            `;
          } else {
            historyContent.innerHTML = `
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                      <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Date</th>
                      <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Amount</th>
                      <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Status</th>
                      <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Reference</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${transactions.map(tx => {
                      const date = new Date(tx.created_at);
                      const amount = parseFloat(tx.amount);
                      const amountNGN = Math.round(amount * 1000); // Convert USD to NGN
                      const statusColor = tx.status === 'completed' ? '#00f2ea' : 
                                        tx.status === 'pending' ? '#ffb703' : 
                                        tx.status === 'failed' ? '#ff0050' : '#ccc';
                      return `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                          <td style="padding: 1rem;">${date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
                          <td style="padding: 1rem; font-weight: 600;">‚Ç¶${formatNumber(amountNGN)}</td>
                          <td style="padding: 1rem;">
                            <span style="padding: 0.25rem 0.75rem; border-radius: 1rem; background: rgba(255,255,255,0.1); color: ${statusColor}; font-size: 0.85rem; text-transform: capitalize;">
                              ${tx.status}
                            </span>
                          </td>
                          <td style="padding: 1rem; font-family: monospace; font-size: 0.85rem; color: var(--text-secondary);">
                            ${tx.payment_reference || 'N/A'}
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading subscription history:', error);
          historyContent.innerHTML = `
            <div class="error-message">
              Failed to load payment history. ${error.message || ''}
            </div>
          `;
        }
      } else {
        // Hide section
        historySection.style.display = 'none';
      }
    }

    // ==================== AFFILIATE LINKS MANAGEMENT ====================
    
    // Load affiliate links
    async function loadAffiliateLinks() {
      const content = document.getElementById('affiliateLinksContent');
      content.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading affiliate links...</div>';
      
      try {
        const response = await SuperAffiliateAPI.apiRequest('/videos/affiliate-links/');
        const links = response.links || [];
        
        if (links.length === 0) {
          content.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
              <i class="fas fa-link" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
              <p style="margin-bottom: 1rem;">No affiliate links added yet.</p>
              <button onclick="showAddAffiliateLinkForm()"
                      style="padding: 0.75rem 1.5rem; background: var(--primary-gradient); border: none; border-radius: 0.5rem; color: white; font-weight: 600; cursor: pointer;">
                <i class="fas fa-plus"></i> Add Your First Affiliate Link
              </button>
            </div>
          `;
        } else {
          content.innerHTML = `
            <div style="display: grid; gap: 1rem;">
              ${links.map(link => {
                const platformNames = {
                  'jumia': 'Jumia Nigeria',
                  'amazon': 'Amazon',
                  'konga': 'Konga',
                  'temu': 'Temu',
                  'aliexpress': 'AliExpress',
                  'shopify': 'Shopify Store',
                  'custom': 'Custom URL'
                };
                const platformIcons = {
                  'jumia': 'fa-shopping-bag',
                  'amazon': 'fa-amazon',
                  'konga': 'fa-store',
                  'temu': 'fa-box',
                  'aliexpress': 'fa-globe',
                  'shopify': 'fa-shopping-cart',
                  'custom': 'fa-link'
                };
                return `
                  <div style="background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--border-radius); padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap;">
                      <div style="flex: 1; min-width: 200px;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                          <i class="fas ${platformIcons[link.platform] || 'fa-link'}" style="color: var(--accent-color); font-size: 1.5rem;"></i>
                          <h3 style="font-size: 1.2rem; font-weight: 600;">${platformNames[link.platform] || link.platform}</h3>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                          <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Affiliate URL:</div>
                          <div style="font-family: monospace; font-size: 0.9rem; color: var(--text-primary); word-break: break-all;">
                            ${link.affiliate_url}
                          </div>
                        </div>
                        ${link.affiliate_id ? `
                          <div style="margin-bottom: 0.5rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Affiliate ID:</div>
                            <div style="font-family: monospace; font-size: 0.9rem; color: var(--accent-color);">
                              ${link.affiliate_id}
                            </div>
                          </div>
                        ` : ''}
                        ${link.notes ? `
                          <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${link.notes}</div>
                          </div>
                        ` : ''}
                      </div>
                      <div style="display: flex; gap: 0.5rem;">
                        <button onclick="editAffiliateLink('${link.id}', '${link.platform}', '${link.affiliate_url.replace(/'/g, "\\'")}', '${(link.affiliate_id || '').replace(/'/g, "\\'")}', '${(link.notes || '').replace(/'/g, "\\'")}')"
                                style="padding: 0.5rem 1rem; background: rgba(0, 242, 234, 0.2); border: 1px solid rgba(0, 242, 234, 0.4); border-radius: 0.5rem; color: var(--accent-color); font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                          <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="deleteAffiliateLink('${link.id}')"
                                style="padding: 0.5rem 1rem; background: rgba(255, 0, 80, 0.2); border: 1px solid rgba(255, 0, 80, 0.4); border-radius: 0.5rem; color: #ff6b6b; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                          <i class="fas fa-trash"></i> Delete
                        </button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading affiliate links:', error);
        content.innerHTML = `
          <div class="error-message">
            Failed to load affiliate links. ${error.message || ''}
          </div>
        `;
      }
    }

    // Show add affiliate link form
    function showAddAffiliateLinkForm() {
      document.getElementById('affiliateLinkModalTitle').textContent = 'Add Affiliate Link';
      document.getElementById('affiliateLinkId').value = '';
      document.getElementById('affiliateLinkForm').reset();
      document.getElementById('affiliateLinkModal').style.display = 'flex';
    }

    // Edit affiliate link
    function editAffiliateLink(id, platform, url, affiliateId, notes) {
      document.getElementById('affiliateLinkModalTitle').textContent = 'Edit Affiliate Link';
      document.getElementById('affiliateLinkId').value = id;
      document.getElementById('affiliateLinkPlatform').value = platform;
      document.getElementById('affiliateLinkUrl').value = url;
      document.getElementById('affiliateLinkIdField').value = affiliateId || '';
      document.getElementById('affiliateLinkNotes').value = notes || '';
      document.getElementById('affiliateLinkModal').style.display = 'flex';
    }

    // Close modal
    function closeAffiliateLinkModal() {
      document.getElementById('affiliateLinkModal').style.display = 'none';
    }

    // Close modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('affiliateLinkModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeAffiliateLinkModal();
          }
        });
      }
    });

    // Save affiliate link
    async function saveAffiliateLink(event) {
      event.preventDefault();
      
      const linkId = document.getElementById('affiliateLinkId').value;
      const platform = document.getElementById('affiliateLinkPlatform').value;
      const url = document.getElementById('affiliateLinkUrl').value.trim();
      const affiliateId = document.getElementById('affiliateLinkIdField').value.trim();
      const notes = document.getElementById('affiliateLinkNotes').value.trim();
      
      if (!platform || !url) {
        showAlert('Platform and Affiliate URL are required', 'error');
        return;
      }
      
      try {
        const payload = {
          platform: platform,
          affiliate_url: url,
          affiliate_id: affiliateId,
          notes: notes
        };
        
        if (linkId) {
          // Update existing
          payload.id = linkId;
        }
        
        await SuperAffiliateAPI.apiRequest('/videos/affiliate-links/', {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        
        showAlert(linkId ? 'Affiliate link updated successfully!' : 'Affiliate link added successfully!', 'success');
        closeAffiliateLinkModal();
        loadAffiliateLinks();
      } catch (error) {
        console.error('Error saving affiliate link:', error);
        showAlert(error.message || 'Failed to save affiliate link. Please try again.', 'error');
      }
    }

    // Delete affiliate link
    async function deleteAffiliateLink(linkId) {
      const confirmed = await showTandaConfirm(
        'Delete Affiliate Link?',
        'Are you sure you want to delete this affiliate link?',
        'Delete',
        'Cancel',
        true
      );
      
      if (!confirmed) {
        return;
      }
      
      try {
        await SuperAffiliateAPI.apiRequest('/videos/affiliate-links/', {
          method: 'POST',
          body: JSON.stringify({
            _method: 'DELETE',
            id: linkId
          })
        });
        
        showAlert('Affiliate link deleted successfully!', 'success');
        loadAffiliateLinks();
      } catch (error) {
        console.error('Error deleting affiliate link:', error);
        showAlert(error.message || 'Failed to delete affiliate link. Please try again.', 'error');
      }
    }
    
    initializePage();
  </script>
</body>
</html>

