<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  <meta name="theme-color" content="#ff0050">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Profile & Settings - Tanda Web</title>
  <meta name="description" content="Manage your Tanda profile and account settings.">

  <link rel="icon" type="image/png" sizes="32x32" href="Tanda logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="site.webmanifest">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #ff0050, #00f2ea);
      --accent-color: #00f2ea;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --bg-card: rgba(255, 255, 255, 0.05);
      --border-radius: 1rem;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      min-height: 100vh;
      padding: 2rem;
    }

    .header {
      max-width: 1100px;
      margin: 0 auto 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .title {
      font-size: 1.8rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }

    .nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Mobile: Add horizontal scroll to nav items - same as orders.html */
    @media (max-width: 768px) {
      .nav {
        gap: 0.25rem;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      
      .nav::-webkit-scrollbar {
        display: none;
      }
      
      /* Ensure user menu dropdown can escape overflow on mobile */
      .nav .user-menu-dropdown {
        overflow: visible !important;
        position: relative !important;
      }
      
      .nav .user-menu-wrapper {
        overflow: visible !important;
      }
    }
    
    @media (max-width: 480px) {
      .nav {
        gap: 0.15rem;
      }
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .tab {
      padding: 1rem 1.5rem;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .tab.active {
      color: var(--accent-color);
      border-bottom-color: var(--accent-color);
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 2rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      margin-bottom: 1.5rem;
      color: var(--accent-color);
      font-size: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.9rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 0.6rem;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent-color);
      background: rgba(255, 255, 255, 0.08);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      padding: 0.9rem 2rem;
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 0.6rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 0, 80, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
    }

    .avatar-section {
      display: flex;
      align-items: center;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--accent-color);
    }

    .avatar-placeholder {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      border: 3px solid var(--accent-color);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-item {
      text-align: center;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 0.75rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .error-message {
      background: rgba(255, 0, 80, 0.1);
      border: 1px solid rgba(255, 0, 80, 0.3);
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      color: #ff6b6b;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      background: rgba(0, 255, 0, 0.1);
      border: 1px solid rgba(0, 255, 0, 0.3);
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      color: #00ff88;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    /* Email verification styles */
    .email-verify-container {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .email-verify-container input {
      flex: 1;
    }

    .btn-verify {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 0.6rem;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 0.9rem 1.5rem;
      white-space: nowrap;
    }

    .btn-verify:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 0, 80, 0.3);
    }

    .btn-verify:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .verification-status {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      display: none;
    }

    .verification-status.show {
      display: block;
    }

    .verification-status.pending {
      background: rgba(255, 165, 0, 0.1);
      border: 1px solid rgba(255, 165, 0, 0.3);
      color: #ffaa00;
    }

    .verification-status.success {
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid rgba(0, 255, 136, 0.3);
      color: #00ff88;
    }

    .verification-status.error {
      background: rgba(255, 0, 80, 0.1);
      border: 1px solid rgba(255, 0, 80, 0.3);
      color: #ff6b6b;
    }

    .verification-code-group {
      margin-top: 0.75rem;
    }

    .verification-code-label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.875rem;
    }

    .verification-code-container {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .verification-code-container input {
      flex: 1;
      padding: 0.9rem 1rem;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 0.6rem;
      color: var(--text-primary);
      font-size: 1.1rem;
      text-align: center;
      letter-spacing: 0.2em;
      font-weight: 600;
    }

    .verification-code-container input:focus {
      outline: none;
      border-color: var(--accent-color);
      background: rgba(0, 0, 0, 0.45);
    }

    .btn-verify-code {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 0.6rem;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 0.9rem 1.5rem;
      white-space: nowrap;
    }

    .btn-verify-code:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 0, 80, 0.3);
    }

    .btn-verify-code:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .title {
        font-size: 1.5rem;
      }

      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        gap: 0.5rem;
      }

      .tab {
        white-space: nowrap;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }

      .avatar-section {
        flex-direction: column;
        text-align: center;
      }

      .stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }

      .stat-value {
        font-size: 1.5rem;
      }

      .card {
        padding: 1.5rem;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 0.75rem;
      }

      .title {
        font-size: 1.3rem;
      }

      .stats {
        grid-template-columns: 1fr;
      }

      .card {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 class="title">Profile & Settings</h1>
    <div class="nav" id="authNav"></div>
  </div>

  <div class="container">
    <div id="loading-section" class="loading">
      <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
      <p>Loading profile...</p>
    </div>

    <div id="profile-section" style="display: none;">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('profile')">
          <i class="fas fa-user"></i> Profile
        </button>
        <button class="tab" onclick="switchTab('settings')">
          <i class="fas fa-cog"></i> Settings
        </button>
        <button class="tab" onclick="switchTab('platforms')">
          <i class="fas fa-link"></i> Platforms
        </button>
      </div>

      <div id="error-message" class="error-message"></div>
      <div id="success-message" class="success-message"></div>

      <!-- Profile Tab -->
      <div id="tab-profile" class="tab-content active">
        <div class="card">
          <h2>Profile Information</h2>
          <div class="avatar-section">
            <div id="avatar-container">
              <img id="avatar-img" class="avatar" src="" alt="Avatar" style="display: none;">
              <div id="avatar-placeholder" class="avatar-placeholder">
                <i class="fas fa-user"></i>
              </div>
            </div>
            <div style="flex: 1;">
              <div style="margin-bottom: 1rem;">
                <div id="user-role-badge" style="display: inline-block; padding: 0.5rem 1rem; background: rgba(0, 242, 234, 0.15); border: 1px solid rgba(0, 242, 234, 0.3); border-radius: 0.5rem; color: var(--accent-color); font-weight: 600; font-size: 0.9rem;">
                  <i class="fas fa-user-tag"></i> <span id="user-role-text">Loading...</span>
                </div>
              </div>
              <button class="btn btn-secondary" onclick="document.getElementById('avatar-input').click()">
                <i class="fas fa-camera"></i> Change Avatar
              </button>
              <input type="file" id="avatar-input" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
            </div>
          </div>

          <div class="stats">
            <div class="stat-item">
              <div class="stat-value" id="stat-followers">0</div>
              <div class="stat-label">Followers</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-following">0</div>
              <div class="stat-label">Following</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-videos">0</div>
              <div class="stat-label">Videos</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-likes">0</div>
              <div class="stat-label">Likes</div>
            </div>
          </div>

          <form id="profile-form" onsubmit="handleProfileUpdate(event)">
            <div class="form-group">
              <label for="username">Username</label>
              <input type="text" id="username" name="username" required>
            </div>

            <div class="form-group">
              <label for="first_name">First Name</label>
              <input type="text" id="first_name" name="first_name">
            </div>

            <div class="form-group">
              <label for="last_name">Last Name</label>
              <input type="text" id="last_name" name="last_name">
            </div>

            <div class="form-group">
              <label for="bio">Bio</label>
              <textarea id="bio" name="bio" placeholder="Tell us about yourself..."></textarea>
            </div>

            <div class="form-group">
              <label for="country">Country</label>
              <input type="text" id="country" name="country" placeholder="e.g., Nigeria">
            </div>

            <div class="form-group">
              <label for="phone_number">Phone Number</label>
              <input type="tel" id="phone_number" name="phone_number">
            </div>

            <button type="submit" class="btn">
              <i class="fas fa-save"></i> Save Changes
            </button>
          </form>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="tab-settings" class="tab-content">
        <div class="card">
          <h2>Account Settings</h2>
          <form id="settings-form" onsubmit="handleSettingsUpdate(event)">
            <div class="form-group">
              <label for="email">Email Address</label>
              <div class="email-verify-container">
                <input type="email" id="email" name="email" required>
                <button type="button" id="send-verification-btn" class="btn-verify">
                  <i class="fas fa-envelope"></i> <span class="btn-text">Send Code</span>
                </button>
              </div>
              <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                Changing your email requires verification. Click "Send Code" to receive a verification code.
              </small>
              <div id="email-verification-status" class="verification-status" style="display: none;"></div>
              <div id="verification-code-group" class="verification-code-group" style="display: none;">
                <label for="verification_code" class="verification-code-label">Verification Code</label>
                <div class="verification-code-container">
                  <input type="text" id="verification_code" placeholder="000000" maxlength="6" inputmode="numeric">
                  <button type="button" id="verify-code-btn" class="btn-verify-code">
                    <i class="fas fa-check"></i> <span class="btn-text">Verify Code</span>
                  </button>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>
                <input type="checkbox" id="email_visible" name="email_visible" style="width: auto; margin-right: 0.5rem;">
                Make email visible to other users
              </label>
            </div>

            <div class="form-group">
              <label>
                <input type="checkbox" id="show_followers" name="show_followers" style="width: auto; margin-right: 0.5rem;">
                Show followers count
              </label>
            </div>

            <div class="form-group">
              <label>
                <input type="checkbox" id="show_following" name="show_following" style="width: auto; margin-right: 0.5rem;">
                Show following count
              </label>
            </div>

            <button type="submit" class="btn">
              <i class="fas fa-save"></i> Save Settings
            </button>
          </form>
        </div>

        <div class="card" style="margin-top: 1.5rem;">
          <h2><i class="fas fa-shield-alt" style="margin-right: 0.5rem;"></i> Security</h2>
          <form id="password-form" onsubmit="handlePasswordChange(event)">
            <div class="form-group">
              <label for="old_password">Current Password</label>
              <input type="password" id="old_password" name="old_password" required>
            </div>

            <div class="form-group">
              <label for="new_password">New Password</label>
              <input type="password" id="new_password" name="new_password" required minlength="8">
            </div>

            <div class="form-group">
              <label for="confirm_password">Confirm New Password</label>
              <input type="password" id="confirm_password" name="confirm_password" required minlength="8">
            </div>

            <button type="submit" class="btn">
              <i class="fas fa-key"></i> Change Password
            </button>
          </form>
        </div>
      </div>

      <!-- Platforms Tab -->
      <div id="tab-platforms" class="tab-content">
        <div class="card">
          <h2>Connected Platforms</h2>
          <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            Connect your social media accounts to publish videos directly from Tanda.
          </p>
          <a href="connect-platforms.html" class="btn" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-external-link-alt"></i> Manage Platform Connections
          </a>
          <p style="color: var(--text-secondary); margin-top: 1rem; font-size: 0.9rem;">
            Connect TikTok, YouTube, Instagram, and Facebook to publish your videos across all platforms.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script src="js/super-affiliate-api.js"></script>
  <script>
    let profileData = null;

    // Check authentication
    if (!SuperAffiliateAPI.isAuthenticated()) {
      window.location.href = 'super-affiliate-login.html';
    }

    // Render auth nav
    SuperAffiliateAPI.renderAuthNav('authNav');

    // Load profile data
    async function loadProfile() {
      try {
        // IMPORTANT:
        // - `/users/profile/` may return `null` for followers/following depending on privacy settings
        //   (even for the current user), which makes the web UI show 0.
        // - Flutter typically uses `/users/stats/` for accurate current-user counts.
        //
        // So we load profile + stats and merge them, using stats as the source of truth for numbers.
        const t = Date.now();
        const [profileResp, statsResp] = await Promise.all([
          SuperAffiliateAPI.apiRequest(`/users/profile/?_t=${t}`),
          SuperAffiliateAPI.apiRequest(`/users/stats/?_t=${t}`),
        ]);

        const merged = {
          ...(profileResp || {}),
          ...(statsResp || {}),
          // Keep profile avatar field if present; stats endpoint doesn't include it.
          avatar: (profileResp && profileResp.avatar) ? profileResp.avatar : (statsResp && statsResp.avatar),
        };

        profileData = merged;
        displayProfile(merged);
      } catch (error) {
        console.error('Error loading profile:', error);
        showError('Failed to load profile. Please try again.');
      }
    }

    function displayProfile(data) {
      document.getElementById('loading-section').style.display = 'none';
      document.getElementById('profile-section').style.display = 'block';

      const cacheBustUrl = (url) => {
        if (!url) return '';
        const u = String(url);
        const t = Date.now();
        return u.includes('?') ? `${u}&t=${t}` : `${u}?t=${t}`;
      };

      const setAvatar = (avatarUrl) => {
        const img = document.getElementById('avatar-img');
        const placeholder = document.getElementById('avatar-placeholder');
        if (avatarUrl) {
          // Force fresh load by clearing src first, then setting with cache-bust
          // This ensures browser doesn't use cached image
          img.src = '';
          setTimeout(() => {
            img.src = cacheBustUrl(avatarUrl);
            img.style.display = 'block';
            placeholder.style.display = 'none';
            // Force reload by adding onload handler that removes it
            img.onload = function() {
              this.onload = null;
            };
          }, 10);
        } else {
          img.style.display = 'none';
          placeholder.style.display = 'flex';
        }
      };

      // Avatar
      setAvatar(data.avatar);

      // User Role
      const roleElement = document.getElementById('user-role-text');
      const roleBadge = document.getElementById('user-role-badge');
      if (data.role) {
        const roleMap = {
          'basic': { text: 'Basic User', icon: 'fa-user', color: 'rgba(255, 255, 255, 0.15)', border: 'rgba(255, 255, 255, 0.3)' },
          'seller': { text: 'Seller', icon: 'fa-store', color: 'rgba(0, 242, 234, 0.15)', border: 'rgba(0, 242, 234, 0.3)' },
          'affiliate': { text: 'Affiliate', icon: 'fa-bullhorn', color: 'rgba(255, 0, 80, 0.15)', border: 'rgba(255, 0, 80, 0.3)' },
          'admin': { text: 'Admin', icon: 'fa-shield-alt', color: 'rgba(255, 215, 0, 0.15)', border: 'rgba(255, 215, 0, 0.3)' }
        };
        const roleInfo = roleMap[data.role.toLowerCase()] || roleMap['basic'];
        roleElement.innerHTML = `<i class="fas ${roleInfo.icon}"></i> ${roleInfo.text}`;
        roleBadge.style.background = roleInfo.color;
        roleBadge.style.borderColor = roleInfo.border;
        roleBadge.style.color = data.role === 'admin' ? '#ffd700' : (data.role === 'affiliate' ? '#ff0050' : 'var(--accent-color)');
      } else {
        roleElement.innerHTML = '<i class="fas fa-user"></i> Basic User';
      }

      // Stats - use backend values as-is (they work in Flutter Android)
      // Handle null/undefined by converting to 0, but preserve actual numbers including 0
      const getStatValue = (value) => {
        if (value === null || value === undefined) return 0;
        // Convert to number to ensure it's displayed correctly
        const num = Number(value);
        return isNaN(num) ? 0 : num;
      };
      
      document.getElementById('stat-followers').textContent = getStatValue(data.total_followers);
      document.getElementById('stat-following').textContent = getStatValue(data.total_following);
      document.getElementById('stat-videos').textContent = getStatValue(data.total_videos);
      document.getElementById('stat-likes').textContent = getStatValue(data.total_likes_received);

      // Profile form
      document.getElementById('username').value = data.username || '';
      document.getElementById('first_name').value = data.first_name || '';
      document.getElementById('last_name').value = data.last_name || '';
      document.getElementById('bio').value = data.bio || '';
      document.getElementById('country').value = data.country || '';
      document.getElementById('phone_number').value = data.phone_number || '';

      // Settings form
      const emailInput = document.getElementById('email');
      emailInput.value = data.email || '';
      originalEmail = data.email || '';
      emailVerified = false;
      resetEmailVerificationUI();
      document.getElementById('email_visible').checked = data.email_visible || false;
      if (data.privacy_settings) {
        document.getElementById('show_followers').checked = data.privacy_settings.show_followers !== false;
        document.getElementById('show_following').checked = data.privacy_settings.show_following !== false;
      }
    }

    // Email verification state
    let originalEmail = '';
    let emailVerified = false;
    let pendingEmail = '';

    function resetEmailVerificationUI() {
      const statusDiv = document.getElementById('email-verification-status');
      const codeGroup = document.getElementById('verification-code-group');
      const verifyBtn = document.getElementById('send-verification-btn');
      
      statusDiv.style.display = 'none';
      statusDiv.className = '';
      codeGroup.style.display = 'none';
      document.getElementById('verification_code').value = '';
      verifyBtn.innerHTML = '<i class="fas fa-envelope"></i> <span class="btn-text">Send Code</span>';
      verifyBtn.disabled = false;
      emailVerified = false;
      pendingEmail = '';
    }

    function checkEmailChange() {
      const email = document.getElementById('email').value.trim().toLowerCase();
      if (email !== originalEmail) {
        resetEmailVerificationUI();
      } else {
        // Email is back to original, no verification needed
        emailVerified = true;
        resetEmailVerificationUI();
      }
    }

    // Send verification code
    async function sendEmailVerificationCode() {
      const email = document.getElementById('email').value.trim().toLowerCase();
      const verifyBtn = document.getElementById('send-verification-btn');
      const statusDiv = document.getElementById('email-verification-status');
      const codeGroup = document.getElementById('verification-code-group');

      if (!email) {
        showError('Please enter an email address first');
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showError('Please enter a valid email address');
        return;
      }

      // Check if email is different from original
      if (email === originalEmail) {
        showError('This is your current email address. No verification needed.');
        return;
      }

      verifyBtn.disabled = true;
      verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
      statusDiv.style.display = 'block';
      statusDiv.className = 'verification-status show pending';
      statusDiv.innerHTML = '<i class="fas fa-clock"></i> Sending verification code...';

      try {
        // First, update the email (backend will send verification code)
        const response = await SuperAffiliateAPI.apiRequest('/users/profile/update/', {
          method: 'PUT',
          body: JSON.stringify({ email }),
        });

        if (response && response.email_verification_required) {
          pendingEmail = email;
          statusDiv.className = 'verification-status show success';
          statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Verification code sent! Check your email.';
          codeGroup.style.display = 'block';
          document.getElementById('verification_code').focus();
          verifyBtn.innerHTML = '<i class="fas fa-redo"></i> Resend';
          verifyBtn.disabled = false;
        } else {
          // Email was updated without verification (shouldn't happen, but handle it)
          originalEmail = email;
          emailVerified = true;
          showSuccess('Email updated successfully!');
          resetEmailVerificationUI();
        }
      } catch (error) {
        console.error('Send verification code error:', error);
        statusDiv.className = 'verification-status show error';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + (error.message || 'Failed to send verification code. Please try again.');
        verifyBtn.innerHTML = '<i class="fas fa-envelope"></i> <span class="btn-text">Send Code</span>';
        verifyBtn.disabled = false;
      }
    }

    // Verify code
    async function verifyEmailCode() {
      const email = document.getElementById('email').value.trim().toLowerCase();
      const code = document.getElementById('verification_code').value.trim();
      const verifyCodeBtn = document.getElementById('verify-code-btn');
      const statusDiv = document.getElementById('email-verification-status');

      if (!email) {
        showError('Please enter an email address first');
        return;
      }

      if (!code || code.length !== 6 || !/^\d+$/.test(code)) {
        showError('Please enter a valid 6-digit verification code');
        return;
      }

      verifyCodeBtn.disabled = true;
      verifyCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

      try {
        const response = await SuperAffiliateAPI.apiRequest('/users/verify-email/', {
          method: 'POST',
          body: JSON.stringify({ email, code }),
        });

        if (response && response.email_verified) {
          emailVerified = true;
          originalEmail = email;
          statusDiv.className = 'verification-status show success';
          statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Email verified successfully!';
          document.getElementById('verification_code').setAttribute('readonly', 'readonly');
          verifyCodeBtn.disabled = true;
          verifyCodeBtn.innerHTML = '<i class="fas fa-check"></i> Verified';
          showSuccess('Email updated and verified successfully!');
          // Reload profile to get updated email
          setTimeout(() => {
            loadProfile();
          }, 1000);
        } else {
          throw new Error('Verification failed');
        }
      } catch (error) {
        console.error('Verify code error:', error);
        statusDiv.className = 'verification-status show error';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + (error.message || 'Invalid verification code. Please try again.');
        verifyCodeBtn.disabled = false;
        verifyCodeBtn.innerHTML = '<i class="fas fa-check"></i> <span class="btn-text">Verify Code</span>';
      }
    }

    async function handleProfileUpdate(event) {
      event.preventDefault();
      const formData = {
        username: document.getElementById('username').value,
        first_name: document.getElementById('first_name').value,
        last_name: document.getElementById('last_name').value,
        bio: document.getElementById('bio').value,
        country: document.getElementById('country').value,
        phone_number: document.getElementById('phone_number').value,
      };

      try {
        const response = await SuperAffiliateAPI.apiRequest('/users/profile/update/', {
          method: 'PUT',
          body: JSON.stringify(formData),
        });
        showSuccess('Profile updated successfully!');
        loadProfile(); // Reload to get updated data
      } catch (error) {
        showError(error.message || 'Failed to update profile');
      }
    }

    async function handleSettingsUpdate(event) {
      event.preventDefault();
      try {
        const email = document.getElementById('email').value.trim().toLowerCase();
        const emailVisible = document.getElementById('email_visible').checked;
        const showFollowers = document.getElementById('show_followers').checked;
        const showFollowing = document.getElementById('show_following').checked;

        // Check if email changed and needs verification
        if (email !== originalEmail && !emailVerified) {
          showError('Please verify your new email address before saving. Click "Send Code" to receive a verification code.');
          return;
        }

        // 1) Update user profile fields (email_visible only - email is already updated after verification)
        // If email was verified, it's already updated in the backend, so we don't send it again
        const profileResp = await SuperAffiliateAPI.apiRequest('/users/profile/update/', {
          method: 'PUT',
          body: JSON.stringify({ 
            email_visible: emailVisible 
          }),
        });

        // 2) Update privacy settings (followers/following visibility)
        await SuperAffiliateAPI.apiRequest('/users/privacy-settings/', {
          method: 'PUT',
          body: JSON.stringify({ show_followers: showFollowers, show_following: showFollowing }),
        });

        showSuccess('Settings updated successfully!');
        
        // Refresh UI state from source of truth
        loadProfile();
      } catch (error) {
        showError(error.message || 'Failed to update settings');
      }
    }

    async function handlePasswordChange(event) {
      event.preventDefault();
      const oldPassword = document.getElementById('old_password').value;
      const newPassword = document.getElementById('new_password').value;
      const confirmPassword = document.getElementById('confirm_password').value;

      if (newPassword !== confirmPassword) {
        showError('New passwords do not match');
        return;
      }

      try {
        const response = await SuperAffiliateAPI.apiRequest('/users/password/change/', {
          method: 'POST',
          body: JSON.stringify({
            old_password: oldPassword,
            new_password: newPassword,
          }),
        });
        showSuccess('Password changed successfully!');
        document.getElementById('password-form').reset();
      } catch (error) {
        showError(error.message || 'Failed to change password');
      }
    }

    async function handleAvatarUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('avatar', file);

      try {
        // Optimistic preview so UI updates immediately
        try {
          const img = document.getElementById('avatar-img');
          const placeholder = document.getElementById('avatar-placeholder');
          img.src = URL.createObjectURL(file);
          img.style.display = 'block';
          placeholder.style.display = 'none';
        } catch (_) {}

        const response = await SuperAffiliateAPI.multipartRequest('/users/profile/upload-avatar/', formData, {
          method: 'POST',
        });
        showSuccess('Avatar updated successfully!');

        // Update avatar immediately using the returned URL (cache-busted)
        const newUrl = response?.avatar_url;
        if (newUrl) {
          const img = document.getElementById('avatar-img');
          const placeholder = document.getElementById('avatar-placeholder');
          
          // Invalidate service worker cache for the old avatar URL pattern
          if ('serviceWorker' in navigator && 'caches' in window) {
            caches.open('tanda-web-v3').then(cache => {
              // Delete any cached versions of avatar URLs for this user
              cache.keys().then(keys => {
                keys.forEach(key => {
                  if (key.url.includes('/media/avatars/') || key.url.includes('/avatars/')) {
                    cache.delete(key);
                  }
                });
              });
            }).catch(() => {});
          }
          
          // Set new avatar with cache-busting timestamp
          const t = Date.now();
          const finalUrl = newUrl.includes('?') ? `${newUrl}&t=${t}` : `${newUrl}?t=${t}`;
          
          // Force reload by setting src to empty first, then new URL
          img.src = '';
          setTimeout(() => {
            img.src = finalUrl;
            img.style.display = 'block';
            placeholder.style.display = 'none';
          }, 50);
        }

        // Re-render nav avatar/menu too
        try { SuperAffiliateAPI.renderAuthNav('authNav'); } catch (_) {}

        // Reload full profile (stats/forms) after a short delay to ensure cache is cleared
        setTimeout(() => {
          loadProfile();
        }, 200);
      } catch (error) {
        showError(error.message || 'Failed to upload avatar');
      }
    }

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
      setTimeout(() => errorDiv.classList.remove('show'), 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('success-message');
      successDiv.textContent = message;
      successDiv.classList.add('show');
      setTimeout(() => successDiv.classList.remove('show'), 5000);
    }

    // Register Service Worker for PWA immediately (before other initialization)
    // This ensures service worker is active and won't cache API responses
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' })
        .then((registration) => {
          console.log('✅ Service Worker registered for PWA');
          // Force update to ensure latest service worker is active
          registration.update();
        })
        .catch((error) => {
          console.warn('⚠️ Service Worker registration failed:', error);
        });
    }

    // Initialize profile after service worker is registered
    loadProfile();

    // Email verification event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const sendCodeBtn = document.getElementById('send-verification-btn');
      const verifyCodeBtn = document.getElementById('verify-code-btn');
      const emailInput = document.getElementById('email');
      const codeInput = document.getElementById('verification_code');

      if (sendCodeBtn) {
        sendCodeBtn.addEventListener('click', sendEmailVerificationCode);
      }

      if (verifyCodeBtn) {
        verifyCodeBtn.addEventListener('click', verifyEmailCode);
      }

      if (emailInput) {
        emailInput.addEventListener('blur', checkEmailChange);
        emailInput.addEventListener('input', checkEmailChange);
      }

      if (codeInput) {
        // Allow Enter key to submit verification code
        codeInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            verifyEmailCode();
          }
        });

        // Auto-format verification code input (numbers only)
        codeInput.addEventListener('input', (e) => {
          e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
        });
      }
    });
  </script>
</body>
</html>
