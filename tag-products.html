<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  <meta name="theme-color" content="#ff0050">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tanda">
  <title>Tag Products - Tanda Web</title>
  <meta name="description" content="Add product tags to a video from the web (iOS-friendly).">

  <link rel="icon" type="image/png" sizes="32x32" href="Tanda logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #ff0050, #00f2ea);
      --secondary-gradient: linear-gradient(135deg, #667eea, #764ba2);
      --accent-color: #00f2ea;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --bg-card: rgba(255, 255, 255, 0.05);
      --border-radius: 1rem;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      min-height: 100vh;
      padding: 2rem;
    }

    /* Safe area insets for iPhone notches and home indicator */
    @supports (padding: env(safe-area-inset-top)) {
      .header {
        padding-top: calc(2rem + env(safe-area-inset-top));
        padding-left: calc(2rem + env(safe-area-inset-left));
        padding-right: calc(2rem + env(safe-area-inset-right));
      }

      .container {
        padding-left: calc(2rem + env(safe-area-inset-left));
        padding-right: calc(2rem + env(safe-area-inset-right));
      }

      @media (max-width: 768px) {
        .container {
          padding-left: calc(1rem + env(safe-area-inset-left));
          padding-right: calc(1rem + env(safe-area-inset-right));
        }
      }
    }

    /* iOS keyboard handling - prevent zoom on input focus */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    input[type="tel"],
    input[type="url"],
    input[type="search"],
    textarea,
    select {
      font-size: 16px !important;
    }

    input[type="number"] {
      inputmode: "numeric";
    }

    input[type="tel"] {
      inputmode: "tel";
    }

    input[type="email"] {
      inputmode: "email";
    }

    .header {
      max-width: 1100px;
      margin: 0 auto 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .title {
      font-size: 1.8rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }

    .nav a {
      text-decoration: none;
      color: var(--text-primary);
      background: rgba(255,255,255,0.08);
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      margin-left: 0.5rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 1.5rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .hint {
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 1.25rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 700; }
    input, select, textarea {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 0.75rem;
      color: var(--text-primary);
      padding: 0.85rem 1rem;
      font-size: 1rem;
    }
    textarea { min-height: 92px; resize: vertical; }

    .actions { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 0.5rem; }
    .btn {
      border: none;
      cursor: pointer;
      border-radius: 0.75rem;
      padding: 0.9rem 1.1rem;
      font-weight: 800;
      color: #fff;
      background: var(--primary-gradient);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      min-width: 220px;
      justify-content: center;
    }
    .btn.secondary { background: rgba(255,255,255,0.1); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .section-title { margin: 1.5rem 0 0.75rem; color: var(--accent-color); font-weight: 900; }

    .list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem;
    }

    .tag-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 1rem;
      padding: 1rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      max-width: 100%;
      overflow: hidden;
      min-width: 0; /* Allows flex children to shrink below content size */
    }

    .tag-img {
      width: 56px;
      height: 56px;
      border-radius: 0.75rem;
      overflow: hidden;
      background: rgba(255,255,255,0.06);
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.7);
      font-weight: 800;
    }
    .tag-img img { width: 100%; height: 100%; object-fit: cover; }

    .tag-meta { 
      flex: 1; 
      min-width: 0; /* Allows text truncation to work in flexbox */
      overflow: hidden;
    }
    .tag-name { 
      font-weight: 900; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      white-space: nowrap;
      max-width: 100%;
      word-break: break-word;
    }
    .tag-sub { color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.25rem; }
    
    @media (max-width: 768px) {
      .tag-card {
        max-width: 100%;
        overflow: hidden;
        padding: 0.75rem;
      }
      
      .tag-name {
        max-width: calc(100vw - 12rem);
        font-size: 0.85rem;
      }
      
      .tag-meta {
        max-width: 100%;
        overflow: hidden;
      }
    }

    .empty {
      padding: 1rem;
      color: var(--text-secondary);
      background: rgba(255,255,255,0.03);
      border: 1px dashed rgba(255,255,255,0.15);
      border-radius: 0.75rem;
    }

    @media (max-width: 900px) {
      .grid { 
        grid-template-columns: 1fr; 
      }
    }

    @media (max-width: 768px) {
      body { 
        padding: 1rem; 
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .title {
        font-size: 1.5rem;
      }

      .container { 
        padding: 1.25rem; 
      }

      .nav { 
        width: 100%; 
        display: flex; 
        gap: 0.5rem; 
      }

      .nav a { 
        flex: 1; 
        justify-content: center; 
        margin-left: 0; 
      }

      .btn { 
        width: 100%; 
        min-width: unset; 
      }

      .list {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 0.75rem;
      }

      .title {
        font-size: 1.3rem;
      }

      .container {
        padding: 1rem;
      }
    }

    /* Product Selector Button */
    .product-select-btn {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 0.75rem;
      color: var(--text-primary);
      padding: 0.85rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-align: left;
      transition: all 0.2s ease;
    }
    .product-select-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.2);
    }
    .product-select-btn i {
      color: var(--accent-color);
    }
    .product-select-btn span {
      flex: 1;
      color: var(--text-secondary);
    }
    .product-select-btn.has-selection span {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Product Selector Modal */
    .product-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10002;
      background: rgba(0,0,0,0.95);
      backdrop-filter: blur(20px);
      padding: 2rem;
      overflow-y: auto;
    }
    .product-modal.active {
      display: block;
    }
    .product-modal-content {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(17, 17, 17, 0.98);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255,255,255,0.15);
      padding: 1.5rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    }
    .product-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .product-modal-header h2 {
      font-size: 1.5rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .product-modal-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--text-primary);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s ease;
    }
    .product-modal-close:hover {
      background: rgba(255,255,255,0.2);
    }
    .product-search {
      margin-bottom: 1.5rem;
    }
    .product-search input {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 0.75rem;
      color: var(--text-primary);
      padding: 0.85rem 1rem;
      font-size: 1rem;
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 0.5rem;
    }
    .product-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 0.75rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .product-item:hover {
      background: rgba(255,255,255,0.06);
      border-color: var(--accent-color);
      transform: translateY(-2px);
    }
    .product-item.selected {
      background: rgba(0,242,234,0.1);
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(0,242,234,0.3);
    }
    .product-item-image {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 0.5rem;
      overflow: hidden;
      background: rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.5);
    }
    .product-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .product-item-name {
      font-weight: 600;
      font-size: 0.9rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .product-item-price {
      color: var(--accent-color);
      font-weight: 700;
      font-size: 0.85rem;
    }
    .product-modal-footer {
      margin-top: 1.5rem;
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }
    .product-loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }
    .product-empty {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      .product-modal {
        padding: 1rem;
      }
      .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 0.75rem;
      }
      .product-modal-content {
        padding: 1rem;
      }
    }

    /* Platform Publishing Section */
    .platform-publish-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .platform-publish-header {
      margin-bottom: 1.5rem;
    }

    .platform-publish-hint {
      color: var(--text-secondary);
      line-height: 1.6;
      font-size: 0.95rem;
    }

    .platform-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .platform-card {
      background: rgba(255,255,255,0.04);
      border: 2px solid rgba(255,255,255,0.08);
      border-radius: 1rem;
      padding: 1rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .platform-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary-gradient);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .platform-card:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.15);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    .platform-label {
      display: block;
      cursor: pointer;
      margin: 0;
    }

    .platform-checkbox {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .platform-content {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .platform-icon {
      width: 48px;
      height: 48px;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .youtube-icon {
      background: linear-gradient(135deg, rgba(255,0,0,0.2), rgba(255,0,0,0.1));
      color: #FF0000;
      border: 1px solid rgba(255,0,0,0.3);
    }

    .tiktok-icon {
      background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.2));
      color: #ffffff;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .instagram-icon {
      background: linear-gradient(135deg, rgba(228,64,95,0.2), rgba(228,64,95,0.1));
      color: #E4405F;
      border: 1px solid rgba(228,64,95,0.3);
    }

    .facebook-icon {
      background: linear-gradient(135deg, rgba(24,119,242,0.2), rgba(24,119,242,0.1));
      color: #1877F2;
      border: 1px solid rgba(24,119,242,0.3);
    }

    .platform-info {
      flex: 1;
      min-width: 0;
    }

    .platform-name {
      font-weight: 700;
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .platform-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* Checkbox checked state */
    .platform-checkbox:checked + .platform-content .platform-icon {
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(0,242,234,0.4);
    }

    .platform-card.platform-selected::before {
      opacity: 1;
    }

    .platform-card.platform-selected {
      background: rgba(0,242,234,0.08);
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(0,242,234,0.2);
    }

    /* Platform Options (YouTube format) */
    .platform-options {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .platform-option-title {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 600;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .platform-radio-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .platform-radio-label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .platform-radio-label:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.15);
    }

    .platform-radio-label input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .radio-custom {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      position: relative;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .platform-radio-label input[type="radio"]:checked + .radio-custom {
      border-color: var(--accent-color);
      background: var(--accent-color);
    }

    .platform-radio-label input[type="radio"]:checked + .radio-custom::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: #000;
      border-radius: 50%;
    }

    .radio-text {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .radio-text strong {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .radio-text small {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .platform-publish-actions {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .platform-publish-actions .btn {
      width: 100%;
    }

    .publish-status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 0.75rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .publish-status > div {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      line-height: 1.6;
    }

    .publish-status a {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s ease;
    }

    .publish-status a:hover {
      color: #00d4c4;
      text-decoration: underline;
    }

    .platform-loading-state,
    .platform-empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .platform-empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
      color: var(--text-secondary);
    }

    .platform-empty-text {
      margin-bottom: 1rem;
    }

    .platform-empty-text p {
      margin: 0.5rem 0;
    }

    .platform-empty-text strong {
      color: var(--text-primary);
    }

    .platform-connect-message {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(0,242,234,0.08);
      border: 1px solid rgba(0,242,234,0.2);
      border-radius: 0.75rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .platform-connect-message i {
      color: var(--accent-color);
    }

    .platform-connect-message a {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 600;
    }

    .platform-connect-message a:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .platform-grid {
        grid-template-columns: 1fr;
      }

      .platform-publish-card {
        padding: 1.25rem;
      }

      .platform-card {
        padding: 0.875rem;
      }

      .platform-icon {
        width: 44px;
        height: 44px;
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title"><i class="fas fa-tag"></i> Tag Products</div>
    <div class="nav">
      <div id="authNav" class="tanda-nav-container"></div>
    </div>
  </div>

  <div class="container">
    <p class="hint">
      Add product tags to your video. Select a product from your shop or add an external product link.
    </p>

    <div class="grid">
      <div>
        <label for="videoId">Video ID</label>
        <input id="videoId" placeholder="e.g. 28" />
      </div>
      <div>
        <label for="productType">Product Type</label>
        <select id="productType" onchange="toggleProductInputs()">
          <option value="internal">Internal product</option>
          <option value="external">External product link</option>
          <option value="marketplace">Browse Marketplace</option>
        </select>
      </div>
    </div>

    <div class="grid">
      <div id="internalWrap">
        <label for="internalProductBtn">Internal Product</label>
        <button type="button" id="internalProductBtn" class="product-select-btn" onclick="openProductSelector()">
          <i class="fas fa-shopping-bag"></i>
          <span id="selectedProductText">Select a product...</span>
        </button>
        <input type="hidden" id="internalProductId" />
      </div>
      <div id="externalWrap" style="display:none;">
        <label for="externalProductUrl">External Product URL</label>
        <input id="externalProductUrl" type="url" placeholder="Paste product URL (e.g., https://jumia.com/...)" oninput="updateExternalUrlFeedback()" />
        <small style="color: var(--text-secondary); margin-top: 0.25rem; display: block;">
          Paste the product URL. The system will create an external product link automatically.
        </small>
        <input type="hidden" id="externalProductId" />
      </div>
      <div id="marketplaceWrap" style="display:none;">
        <label for="marketplaceProductBtn">Marketplace Product</label>
        <button type="button" id="marketplaceProductBtn" class="product-select-btn" onclick="openMarketplaceSelector()">
          <i class="fas fa-compass"></i>
          <span id="selectedMarketplaceProductText">Browse marketplace products...</span>
        </button>
        <input type="hidden" id="marketplaceProductId" />
        <small style="color: var(--text-secondary); margin-top: 0.25rem; display: block;">
          Select a product from the external marketplace (Jumia, Konga, Temu, etc.)
        </small>
      </div>
      <div>
        <label for="timestamp">Timestamp (seconds)</label>
        <input id="timestamp" placeholder="e.g. 0.0" />
      </div>
    </div>

    <div class="grid">
      <div>
        <label for="overlayStyle">Overlay Style</label>
        <select id="overlayStyle">
          <option value="default">Default</option>
          <option value="minimal">Minimal</option>
          <option value="compact">Compact</option>
          <option value="glassmorphism">Glassmorphism</option>
          <option value="gradient">Gradient</option>
        </select>
      </div>
      <div>
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" placeholder="e.g. Tagged from web"></textarea>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="createBtn" onclick="createTag()">
        <i class="fas fa-plus"></i> Create Tag
      </button>
      <button class="btn secondary" onclick="loadTags()">
        <i class="fas fa-sync"></i> Refresh Tags
      </button>
      <button class="btn secondary" onclick="SuperAffiliateAPI.logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>

    <div class="section-title">Existing Tags</div>
    <div id="tags" class="list"></div>

    <!-- Publish to Tanda Feed (Always Available) -->
    <div class="section-title" style="margin-top: 2rem;">Publish to Tanda Feed</div>
    <div class="platform-publish-card">
      <div class="platform-publish-header">
        <p class="platform-publish-hint">
          Make your video with product tags visible on Tanda feed
        </p>
      </div>
      <div class="platform-publish-actions">
        <button class="btn" onclick="publishToTandaFeed()" id="publishTandaBtn">
          <i class="fas fa-video"></i> Publish to Tanda Feed
        </button>
          </div>
      <div id="publishTandaStatus" class="publish-status" style="display: none;"></div>
        </div>

    <!-- Publish to External Platforms (Optional) -->
    <div class="section-title" style="margin-top: 2rem;">Publish to External Platforms</div>
    <div class="platform-publish-card">
      <div class="platform-publish-header">
        <p class="platform-publish-hint">
          Select platforms to publish your video with product tags
        </p>
        </div>
      <div id="platformSelection" class="platform-grid">
        <div id="platforms-loading" class="platform-loading-state">
          <i class="fas fa-spinner fa-spin"></i> Loading connected platforms...
        </div>
        <div id="platforms-empty" class="platform-empty-state" style="display: none;">
          <div class="platform-empty-icon">
            <i class="fas fa-plug"></i>
        </div>
          <div class="platform-empty-text">
            <p><strong>No platforms connected</strong></p>
            <p>Connect your social media platforms to publish videos with product tags.</p>
      </div>
          <a href="profile.html" class="btn" style="margin-top: 1rem; width: auto; display: inline-block;">
            <i class="fas fa-link"></i> Connect Platforms
          </a>
        </div>
        </div>
      <div id="platform-connect-message" class="platform-connect-message" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span>Want to connect more platforms? <a href="profile.html">Go to Profile Settings</a></span>
      </div>
      <div class="platform-publish-actions">
        <button class="btn" onclick="publishToPlatforms()" id="publishBtn">
          <i class="fas fa-upload"></i> Publish to Selected Platforms
        </button>
      </div>
      <div id="publishStatus" class="publish-status" style="display: none;"></div>
    </div>
  </div>

  <!-- Product Selector Modal -->
  <div id="productModal" class="product-modal">
    <div class="product-modal-content">
      <div class="product-modal-header">
        <h2 id="productModalTitle">Select Product</h2>
        <button class="product-modal-close" onclick="closeProductSelector()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="product-search">
        <input type="text" id="productSearch" placeholder="Search products..." oninput="filterProducts()" />
      </div>
      <div id="productGrid" class="product-grid">
        <div class="product-loading">
          <i class="fas fa-spinner fa-spin"></i> Loading products...
        </div>
      </div>
      <div class="product-modal-footer">
        <button class="btn secondary" onclick="closeProductSelector()">Cancel</button>
        <button class="btn" id="confirmProductBtn" onclick="confirmProductSelection()" disabled>
          Select Product
        </button>
      </div>
    </div>
  </div>

  <!-- Marketplace Selector Modal -->
  <div id="marketplaceModal" class="product-modal">
    <div class="product-modal-content" style="max-height: 90vh; overflow-y: auto;">
      <div class="product-modal-header">
        <h2>Discover Products</h2>
        <button class="product-modal-close" onclick="closeMarketplaceSelector()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Platform Filter -->
      <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
        <button class="btn secondary" id="filterAll" onclick="filterMarketplaceByPlatform('all')" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
          All
        </button>
        <button class="btn secondary" id="filterJumia" onclick="filterMarketplaceByPlatform('jumia')" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
          Jumia
        </button>
        <button class="btn secondary" id="filterKonga" onclick="filterMarketplaceByPlatform('konga')" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
          Konga
        </button>
        <button class="btn secondary" id="filterTemu" onclick="filterMarketplaceByPlatform('temu')" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
          Temu
        </button>
      </div>

      <!-- Search -->
      <div class="product-search">
        <input type="text" id="marketplaceSearch" placeholder="Search marketplace products..." oninput="searchMarketplace()" />
      </div>

      <!-- Marketplace Products Grid -->
      <div id="marketplaceGrid" class="product-grid">
        <div class="product-loading">
          <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
          <p>Loading marketplace products...</p>
          <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;">
            This may take a few seconds
          </p>
        </div>
      </div>

      <!-- Pagination -->
      <div id="marketplacePagination" style="margin-top: 1.5rem; display: none; justify-content: center; gap: 0.5rem; align-items: center;">
        <button class="btn secondary" id="prevPageBtn" onclick="loadMarketplacePage(-1)" disabled style="font-size: 0.85rem;">
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span id="pageInfo" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
        <button class="btn secondary" id="nextPageBtn" onclick="loadMarketplacePage(1)" style="font-size: 0.85rem;">
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>

      <div class="product-modal-footer">
        <button class="btn secondary" onclick="closeMarketplaceSelector()">Cancel</button>
      </div>
    </div>
  </div>

  <script src="js/super-affiliate-api.js"></script>
  <script>
    SuperAffiliateAPI.renderAuthNav('authNav');
    if (!SuperAffiliateAPI.isAuthenticated()) {
      window.location.href = 'super-affiliate-login.html';
    }

    const params = new URLSearchParams(window.location.search);
    const initialVideoId = params.get('video_id');
    if (initialVideoId) {
      document.getElementById('videoId').value = initialVideoId;
    }

    // Product selector state
    let allProducts = [];
    let filteredProducts = [];
    let selectedProduct = null;
    let userRole = null; // 'seller' or 'affiliate'

    async function checkUserRole() {
      try {
        // Check if user is a seller
        const sellerProfile = await SuperAffiliateAPI.apiRequest('/commerce/seller/profile/');
        if (sellerProfile && !sellerProfile.error) {
          userRole = 'seller';
          return;
        }
      } catch (e) {
        // Not a seller, continue
      }

      try {
        // Check if user is an affiliate
        const affiliateProfile = await SuperAffiliateAPI.apiRequest('/commerce/affiliate/profile/');
        if (affiliateProfile && !affiliateProfile.error) {
          userRole = 'affiliate';
          return;
        }
      } catch (e) {
        // Not an affiliate
      }

      userRole = null;
    }

    async function loadProducts() {
      const productGrid = document.getElementById('productGrid');
      productGrid.innerHTML = '<div class="product-loading"><i class="fas fa-spinner fa-spin"></i> Loading products...</div>';

      try {
        let endpoint;
        let title;

        if (userRole === 'seller') {
          endpoint = '/commerce/seller/products/';
          title = 'Select from Your Products';
        } else if (userRole === 'affiliate') {
          endpoint = '/commerce/affiliate/products/';
          title = 'Select Taggable Product';
        } else {
          // Fallback: try user products endpoint
          endpoint = '/commerce/products/my/';
          title = 'Select Product';
        }

        document.getElementById('productModalTitle').textContent = title;

        const response = await SuperAffiliateAPI.apiRequest(endpoint);
        const products = response.products || response.results || [];

        if (products.length === 0) {
          productGrid.innerHTML = `
            <div class="product-empty">
              <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
              <p>No products available.</p>
              ${userRole === 'seller' ? '<p style="margin-top: 0.5rem; font-size: 0.9rem;">Create products in your seller dashboard first.</p>' : ''}
              ${userRole === 'affiliate' ? '<p style="margin-top: 0.5rem; font-size: 0.9rem;">No products are available for tagging at the moment.</p>' : ''}
            </div>
          `;
          allProducts = [];
          filteredProducts = [];
          return;
        }

        allProducts = products;
        filteredProducts = products;
        renderProducts(products);
      } catch (error) {
        productGrid.innerHTML = `
          <div class="product-empty">
            <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem; color: #ff0050;"></i>
            <p>Failed to load products.</p>
            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">${error.message || 'Please try again later.'}</p>
          </div>
        `;
        console.error('Error loading products:', error);
      }
    }

    // Helper function to get product image URL (handles relative/absolute URLs)
    function getProductImageUrl(product) {
      // Get API base URL (same logic as in super-affiliate-api.js)
      function getApiBaseUrl() {
        const metaTag = document.querySelector('meta[name="api-base-url"]');
        if (metaTag && metaTag.content) {
          return metaTag.content.endsWith('/api') ? metaTag.content : metaTag.content + '/api';
        }
        if (typeof process !== 'undefined' && process.env && process.env.API_BASE_URL) {
          return process.env.API_BASE_URL.endsWith('/api') ? process.env.API_BASE_URL : process.env.API_BASE_URL + '/api';
        }
        const hostname = window.location.hostname;
        if (hostname.includes('tanda.media') || hostname.includes('railway.app') || hostname.includes('render.com')) {
          return 'https://api.tanda.media/api';
        }
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
          return 'http://127.0.0.1:8000/api';
        }
        return '/api';
      }
      
      const apiBaseUrl = getApiBaseUrl();
      
      // Helper to normalize image URL
      function normalizeImageUrl(url) {
        if (!url || typeof url !== 'string' || url.trim() === '') {
          return null;
        }
        
        url = url.trim();
        
        // If it's already an absolute URL, use it directly
        if (url.startsWith('http://') || url.startsWith('https://')) {
          return url;
        }
        
        // If it's a relative path starting with /, construct full URL
        if (url.startsWith('/')) {
          // For media files, we need the base URL without /api
          // Get the origin from the API base URL
          let baseUrl = apiBaseUrl;
          if (baseUrl.includes('/api')) {
            baseUrl = baseUrl.replace('/api', '');
          }
          // If baseUrl doesn't start with http, try to construct from current location
          if (!baseUrl.startsWith('http')) {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            if (hostname.includes('tanda.media')) {
              baseUrl = 'https://api.tanda.media';
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
              baseUrl = 'http://127.0.0.1:8000';
            } else {
              baseUrl = `${protocol}//${hostname}`;
            }
          }
          return baseUrl + url;
        }
        
        // Otherwise, prepend API base URL with a slash
        return apiBaseUrl + '/' + url;
      }
      
      // Try images array first (most reliable source)
      if (product.images && Array.isArray(product.images) && product.images.length > 0) {
        // Find primary image first, or use first image
        let selectedImage = product.images.find(img => img && img.is_primary === true) || product.images[0];
        
        if (selectedImage) {
          // Handle image field - could be string URL or object
          let imageUrl = null;
          
          if (typeof selectedImage === 'string') {
            imageUrl = selectedImage;
          } else if (typeof selectedImage === 'object') {
            // Try different possible field names
            imageUrl = selectedImage.image || selectedImage.image_url || selectedImage.url || '';
            
            // If image is an object with url property (FileField serialization)
            if (imageUrl && typeof imageUrl === 'object' && imageUrl.url) {
              imageUrl = imageUrl.url;
            }
          }
          
          if (imageUrl) {
            const normalized = normalizeImageUrl(imageUrl);
            if (normalized) return normalized;
          }
        }
      }
      
      // Fallback to direct image fields
      let imageUrl = product.image_url || product.image || product.thumbnail_url || product.thumbnail || '';
      
      if (imageUrl) {
        return normalizeImageUrl(imageUrl);
      }
      
      return null;
    }

    function renderProducts(products) {
      const productGrid = document.getElementById('productGrid');
      
      if (products.length === 0) {
        productGrid.innerHTML = `
          <div class="product-empty">
            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>No products found.</p>
          </div>
        `;
        return;
      }

      productGrid.innerHTML = products.map(product => {
        const imageUrl = getProductImageUrl(product);
        const name = product.name || 'Unnamed Product';
        const price = product.price ? `â‚¦${parseFloat(product.price).toLocaleString()}` : 'Price N/A';
        const isSelected = selectedProduct && selectedProduct.id === product.id;
        const hasImage = imageUrl && imageUrl.trim() !== '';

        return `
          <div class="product-item ${isSelected ? 'selected' : ''}" data-product-id="${product.id}" data-product-name="${name.replace(/"/g, '&quot;')}">
            <div class="product-item-image">
              ${hasImage ? `<img src="${imageUrl}" alt="${name}" onerror="console.error('Image failed to load:', '${imageUrl}'); this.parentElement.innerHTML='<i class=\\'fas fa-shopping-bag\\'></i>'">` : '<i class="fas fa-shopping-bag"></i>'}
            </div>
            <div class="product-item-name" title="${name}">${name}</div>
            <div class="product-item-price">${price}</div>
          </div>
        `;
      }).join('');
      
      // Add click event listeners to product items
      productGrid.querySelectorAll('.product-item').forEach(item => {
        item.addEventListener('click', function(e) {
          // Don't trigger if clicking on the image (which has its own error handler)
          if (e.target.tagName === 'IMG' && e.target.onerror) {
            return;
          }
          const productId = this.dataset.productId;
          const productName = this.dataset.productName;
          selectProduct(productId, productName, this);
        });
      });
    }

    function selectProduct(productId, productName, element) {
      selectedProduct = { id: productId, name: productName };
      
      // Update UI - remove selected class from all items
      document.querySelectorAll('.product-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Add selected class to clicked item
      if (element) {
        element.classList.add('selected');
      } else {
        // Fallback: find by data attribute
        const item = document.querySelector(`[data-product-id="${productId}"]`);
        if (item) {
          item.classList.add('selected');
        }
      }
      
      // Enable confirm button
      const confirmBtn = document.getElementById('confirmProductBtn');
      if (confirmBtn) {
        confirmBtn.disabled = false;
        console.log('Confirm button enabled for product:', productId, productName);
      } else {
        console.error('Confirm button not found!');
      }
    }

    function confirmProductSelection() {
      if (!selectedProduct) return;

      // Set the product ID
      document.getElementById('internalProductId').value = selectedProduct.id;
      
      // Update button text
      const btn = document.getElementById('internalProductBtn');
      const span = document.getElementById('selectedProductText');
      span.textContent = selectedProduct.name;
      btn.classList.add('has-selection');

      closeProductSelector();
    }

    function filterProducts() {
      const searchTerm = document.getElementById('productSearch').value.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredProducts = allProducts;
      } else {
        filteredProducts = allProducts.filter(product => {
          const name = (product.name || '').toLowerCase();
          const description = (product.description || '').toLowerCase();
          return name.includes(searchTerm) || description.includes(searchTerm);
        });
      }

      renderProducts(filteredProducts);
    }

    async function openProductSelector() {
      const productType = document.getElementById('productType').value;
      if (productType !== 'internal') {
        showToast('Please select "Internal product" type first.', 'error');
        return;
      }

      // Check user role if not already checked
      if (!userRole) {
        await checkUserRole();
      }

      // If user is an affiliate (not a seller), show helpful modal
      if (userRole === 'affiliate') {
        showAffiliateRestrictionModal();
        return;
      }

      // Reset selection
      selectedProduct = null;
      document.getElementById('confirmProductBtn').disabled = true;
      document.getElementById('productSearch').value = '';

      // Show modal
      document.getElementById('productModal').classList.add('active');

      // Load products
      await loadProducts();
    }

    function showAffiliateRestrictionModal() {
      const modal = document.createElement('div');
      modal.className = 'product-modal active';
      modal.id = 'affiliateRestrictionModal';
      modal.innerHTML = `
        <div class="product-modal-content" style="max-width: 500px;">
          <div class="product-modal-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-info-circle" style="color: var(--accent-color);"></i>
              <span>Tag Products via Affiliate Dashboard</span>
            </h2>
            <button class="product-modal-close" onclick="closeAffiliateRestrictionModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div style="padding: 1.5rem;">
            <p style="margin-bottom: 1rem; font-weight: 600; color: var(--text-primary);">
              To promote products as an affiliate:
            </p>
            <ol style="margin-left: 1.5rem; margin-bottom: 1.5rem; line-height: 2; color: var(--text-secondary);">
              <li>Publish your video first</li>
              <li>Go to your Affiliate Dashboard</li>
              <li>Browse products in the Marketplace</li>
              <li>Select "Promote with Existing Video"</li>
              <li>Choose this video to attach the product</li>
            </ol>
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary); font-size: 0.9rem;">
              <strong>Note:</strong> You can still tag external products (Jumia, Konga, etc.) directly by selecting "External product link" or "Browse Marketplace" options.
            </p>
          </div>
          <div class="product-modal-footer">
            <button class="btn secondary" onclick="closeAffiliateRestrictionModal()">Got it</button>
            <button class="btn" onclick="goToAffiliateDashboard()">
              <i class="fas fa-external-link-alt"></i> Go to Affiliate Dashboard
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target.id === 'affiliateRestrictionModal') {
          closeAffiliateRestrictionModal();
        }
      });
    }

    function closeAffiliateRestrictionModal() {
      const modal = document.getElementById('affiliateRestrictionModal');
      if (modal) {
        modal.remove();
      }
    }

    function goToAffiliateDashboard() {
      closeAffiliateRestrictionModal();
      window.location.href = 'affiliate-dashboard.html';
    }

    function closeProductSelector() {
      document.getElementById('productModal').classList.remove('active');
      selectedProduct = null;
    }

    // Close modal on backdrop click
    document.getElementById('productModal').addEventListener('click', (e) => {
      if (e.target.id === 'productModal') {
        closeProductSelector();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (document.getElementById('productModal').classList.contains('active')) {
        closeProductSelector();
        }
        if (document.getElementById('marketplaceModal').classList.contains('active')) {
          closeMarketplaceSelector();
        }
      }
    });

    // Marketplace state
    let marketplaceProducts = [];
    let filteredMarketplaceProducts = [];
    let selectedMarketplaceProduct = null;
    let currentMarketplacePage = 1;
    let currentMarketplacePlatform = 'all';
    let marketplacePagination = null;

    async function openMarketplaceSelector() {
      const productType = document.getElementById('productType').value;
      if (productType !== 'marketplace') {
        showToast('Please select "Browse Marketplace" type first.', 'error');
        return;
      }

      // Reset selection
      selectedMarketplaceProduct = null;
      document.getElementById('marketplaceSearch').value = '';
      currentMarketplacePage = 1;
      currentMarketplacePlatform = 'all';

      // Show modal
      document.getElementById('marketplaceModal').classList.add('active');

      // Load products
      await loadMarketplaceProducts();
    }

    function closeMarketplaceSelector() {
      document.getElementById('marketplaceModal').classList.remove('active');
      selectedMarketplaceProduct = null;
    }

    function resetMarketplaceSelection() {
      selectedMarketplaceProduct = null;
      document.getElementById('marketplaceProductId').value = '';
      const btn = document.getElementById('marketplaceProductBtn');
      const span = document.getElementById('selectedMarketplaceProductText');
      span.textContent = 'Browse marketplace products...';
      btn.classList.remove('has-selection');
    }

    async function loadMarketplaceProducts(page = 1) {
      const grid = document.getElementById('marketplaceGrid');
      grid.innerHTML = '<div class="product-loading"><i class="fas fa-spinner fa-spin"></i> Loading marketplace products...</div>';

      try {
        const response = await SuperAffiliateAPI.browseMarketplaceProducts(
          page,
          20,
          currentMarketplacePlatform,
          document.getElementById('marketplaceSearch').value.trim(),
          'created_at'
        );

        if (response && response.products && Array.isArray(response.products)) {
          marketplaceProducts = response.products;
          filteredMarketplaceProducts = marketplaceProducts;
          marketplacePagination = response.pagination || null;

          if (marketplaceProducts.length === 0) {
            const platformFilter = currentMarketplacePlatform !== 'all' ? currentMarketplacePlatform : '';
            const searchTerm = document.getElementById('marketplaceSearch').value.trim();
            let emptyMessage = 'No products found';
            if (platformFilter && searchTerm) {
              emptyMessage = `No products found matching "${searchTerm}" on ${platformFilter.charAt(0).toUpperCase() + platformFilter.slice(1)}.`;
            } else if (platformFilter) {
              emptyMessage = `No products available on ${platformFilter.charAt(0).toUpperCase() + platformFilter.slice(1)} at the moment.`;
            } else if (searchTerm) {
              emptyMessage = `No products found matching "${searchTerm}".`;
            } else {
              emptyMessage = 'No products available in the marketplace at the moment.';
            }
            grid.innerHTML = `
              <div class="product-empty">
                <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <p>${emptyMessage}</p>
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;">
                  Try adjusting your search or filter settings.
                </p>
              </div>
            `;
          } else {
          renderMarketplaceProducts(marketplaceProducts);
          updateMarketplacePagination();
          
          // Re-enable filter buttons after successful load
          const filterButtonIds = ['filterAll', 'filterJumia', 'filterKonga', 'filterTemu'];
          filterButtonIds.forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (btn) btn.disabled = false;
          });
          const searchInput = document.getElementById('marketplaceSearch');
          if (searchInput) searchInput.disabled = false;
          }
        } else {
          grid.innerHTML = `
            <div class="product-empty">
              <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
              <p>No products found in marketplace.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading marketplace products:', error);
        
        // Re-enable filter buttons on error
        const filterButtonIds = ['filterAll', 'filterJumia', 'filterKonga', 'filterTemu'];
        filterButtonIds.forEach(btnId => {
          const btn = document.getElementById(btnId);
          if (btn) btn.disabled = false;
        });
        const searchInput = document.getElementById('marketplaceSearch');
        if (searchInput) searchInput.disabled = false;
        
        let errorMsg = 'Unable to load marketplace products';
        if (error.message) {
          const msg = error.message.toLowerCase();
          if (msg.includes('timeout') || msg.includes('connection')) {
            errorMsg = 'Connection timeout. Please check your internet connection and try again.';
          } else if (msg.includes('network') || msg.includes('fetch')) {
            errorMsg = 'Network error. Please check your internet connection and try again.';
          } else {
            errorMsg = error.message;
          }
        }
        grid.innerHTML = `
          <div class="product-empty">
            <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem; color: #ff0050;"></i>
            <p style="margin-bottom: 0.5rem;"><strong>Failed to load marketplace products</strong></p>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">${errorMsg}</p>
            <button class="btn" onclick="loadMarketplaceProducts(${page})" style="margin-top: 0.5rem;">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
      }
    }

    function renderMarketplaceProducts(products) {
      const grid = document.getElementById('marketplaceGrid');
      
      if (!products || products.length === 0) {
        const platformFilter = currentMarketplacePlatform !== 'all' ? currentMarketplacePlatform : '';
        const searchTerm = document.getElementById('marketplaceSearch').value.trim();
        let emptyMessage = 'No products found';
        if (platformFilter && searchTerm) {
          emptyMessage = `No products found matching "${searchTerm}" on ${platformFilter.charAt(0).toUpperCase() + platformFilter.slice(1)}.`;
        } else if (platformFilter) {
          emptyMessage = `No products available on ${platformFilter.charAt(0).toUpperCase() + platformFilter.slice(1)}.`;
        } else if (searchTerm) {
          emptyMessage = `No products found matching "${searchTerm}".`;
        }
        grid.innerHTML = `
          <div class="product-empty">
            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>${emptyMessage}</p>
            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;">
              Try adjusting your search or filter settings.
            </p>
          </div>
        `;
        return;
      }

      grid.innerHTML = products.map(product => {
        const productId = product.id || '';
        const productName = product.product_name || product.name || 'Unknown Product';
        const price = product.price ? `â‚¦${parseFloat(product.price).toLocaleString()}` : 'Price not available';
        const platform = product.platform || 'unknown';
        const imageUrl = product.product_image_url || product.image_url || '';
        const isSelected = selectedMarketplaceProduct && selectedMarketplaceProduct.id === productId;

        // Escape HTML
        const escapedName = safeText(productName).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const escapedId = safeText(productId).replace(/'/g, "\\'").replace(/"/g, '&quot;');

        return `
          <div class="product-item ${isSelected ? 'selected' : ''}" 
               data-product-id="${escapedId}" 
               onclick="selectMarketplaceProduct('${escapedId}', '${escapedName}', this)">
            <div class="product-item-image">
              ${imageUrl ? `<img src="${imageUrl}" alt="${escapedName}" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-shopping-bag\\'></i>'">` : '<i class="fas fa-shopping-bag"></i>'}
            </div>
            <div class="product-item-name">${safeText(productName)}</div>
            <div class="product-item-price">${price}</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; text-transform: capitalize;">
              ${platform}
            </div>
          </div>
        `;
      }).join('');
    }

    function selectMarketplaceProduct(productId, productName, element) {
      selectedMarketplaceProduct = { id: productId, name: productName };
      
      // Update UI
      document.querySelectorAll('#marketplaceGrid .product-item').forEach(item => {
        item.classList.remove('selected');
      });
      if (element) {
        element.classList.add('selected');
      }

      // Set the product ID
      document.getElementById('marketplaceProductId').value = productId;
      
      // Update button text
      const btn = document.getElementById('marketplaceProductBtn');
      const span = document.getElementById('selectedMarketplaceProductText');
      span.textContent = productName.length > 30 ? productName.substring(0, 30) + '...' : productName;
      btn.classList.add('has-selection');

      // Close modal and show success
      closeMarketplaceSelector();
      showToast(`âœ… Selected: ${productName}`, 'success');
    }

    function filterMarketplaceByPlatform(platform) {
      currentMarketplacePlatform = platform;
      currentMarketplacePage = 1;

      // Update filter button states
      ['All', 'Jumia', 'Konga', 'Temu'].forEach(p => {
        const btnId = p === 'All' ? 'filterAll' : `filter${p}`;
        const btn = document.getElementById(btnId);
        if (btn) {
          if ((p === 'All' && platform === 'all') || p.toLowerCase() === platform) {
            btn.classList.add('active');
            btn.style.background = 'var(--primary-gradient)';
            btn.style.color = 'white';
          } else {
            btn.classList.remove('active');
            btn.style.background = '';
            btn.style.color = '';
          }
        }
      });

      loadMarketplaceProducts(1);
    }

    function searchMarketplace() {
      const searchTerm = document.getElementById('marketplaceSearch').value.trim();
      currentMarketplacePage = 1;
      loadMarketplaceProducts(1);
    }

    function loadMarketplacePage(direction) {
      if (!marketplacePagination) return;
      
      const newPage = currentMarketplacePage + direction;
      if (newPage < 1) return;
      if (newPage > marketplacePagination.total_pages) return;

      currentMarketplacePage = newPage;
      loadMarketplaceProducts(newPage);
    }

    function updateMarketplacePagination() {
      const paginationEl = document.getElementById('marketplacePagination');
      const pageInfo = document.getElementById('pageInfo');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');

      if (!marketplacePagination) {
        paginationEl.style.display = 'none';
        return;
      }

      paginationEl.style.display = 'flex';
      pageInfo.textContent = `Page ${marketplacePagination.page} of ${marketplacePagination.total_pages}`;
      prevBtn.disabled = !marketplacePagination.has_previous;
      nextBtn.disabled = !marketplacePagination.has_next;
    }

    // Close marketplace modal on backdrop click
    document.getElementById('marketplaceModal').addEventListener('click', (e) => {
      if (e.target.id === 'marketplaceModal') {
        closeMarketplaceSelector();
      }
    });

    function toggleProductInputs() {
      const productType = document.getElementById('productType').value;
      document.getElementById('internalWrap').style.display = productType === 'internal' ? 'block' : 'none';
      document.getElementById('externalWrap').style.display = productType === 'external' ? 'block' : 'none';
      document.getElementById('marketplaceWrap').style.display = productType === 'marketplace' ? 'block' : 'none';
      
      // Reset selections when switching
      if (productType === 'internal') {
        document.getElementById('externalProductUrl').value = '';
        document.getElementById('externalProductId').value = '';
        document.getElementById('marketplaceProductId').value = '';
        resetMarketplaceSelection();
      } else if (productType === 'external') {
        document.getElementById('internalProductId').value = '';
        document.getElementById('marketplaceProductId').value = '';
        const btn = document.getElementById('internalProductBtn');
        const span = document.getElementById('selectedProductText');
        span.textContent = 'Select a product...';
        btn.classList.remove('has-selection');
        resetMarketplaceSelection();
      } else if (productType === 'marketplace') {
        document.getElementById('internalProductId').value = '';
        document.getElementById('externalProductUrl').value = '';
        document.getElementById('externalProductId').value = '';
        const btn = document.getElementById('internalProductBtn');
        const span = document.getElementById('selectedProductText');
        span.textContent = 'Select a product...';
        btn.classList.remove('has-selection');
      }
    }

    function safeText(v) {
      return (v === null || v === undefined) ? '' : String(v);
    }

    // Helper function to normalize image URL (reuse from getProductImageUrl)
    function normalizeImageUrlForTag(url) {
      if (!url || typeof url !== 'string' || url.trim() === '') {
        return null;
      }
      
      url = url.trim();
      
      // If it's already an absolute URL, use it directly
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return url;
      }
      
      // Get API base URL
      function getApiBaseUrl() {
        const metaTag = document.querySelector('meta[name="api-base-url"]');
        if (metaTag && metaTag.content) {
          return metaTag.content.endsWith('/api') ? metaTag.content : metaTag.content + '/api';
        }
        if (typeof process !== 'undefined' && process.env && process.env.API_BASE_URL) {
          return process.env.API_BASE_URL.endsWith('/api') ? process.env.API_BASE_URL : process.env.API_BASE_URL + '/api';
        }
        const hostname = window.location.hostname;
        if (hostname.includes('tanda.media') || hostname.includes('railway.app') || hostname.includes('render.com')) {
          return 'https://api.tanda.media/api';
        }
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
          return 'http://127.0.0.1:8000/api';
        }
        return '/api';
      }
      
      const apiBaseUrl = getApiBaseUrl();
      
      // If it's a relative path starting with /, construct full URL
      if (url.startsWith('/')) {
        // For media files, we need the base URL without /api
        let baseUrl = apiBaseUrl;
        if (baseUrl.includes('/api')) {
          baseUrl = baseUrl.replace('/api', '');
        }
        // If baseUrl doesn't start with http, try to construct from current location
        if (!baseUrl.startsWith('http')) {
          const protocol = window.location.protocol;
          const hostname = window.location.hostname;
          if (hostname.includes('tanda.media')) {
            baseUrl = 'https://api.tanda.media';
          } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
            baseUrl = 'http://127.0.0.1:8000';
          } else {
            baseUrl = `${protocol}//${hostname}`;
          }
        }
        return baseUrl + url;
      }
      
      // Otherwise, prepend API base URL with a slash
      return apiBaseUrl + '/' + url;
    }

    function renderTags(tags) {
      const container = document.getElementById('tags');
      if (!tags || !Array.isArray(tags) || tags.length === 0) {
        container.innerHTML = `<div class="empty">No tags yet for this video.</div>`;
        return;
      }

      console.log('Rendering tags:', tags); // Debug log

      // Get videoId from input field
      const videoIdInput = document.getElementById('videoId');
      const videoId = videoIdInput ? videoIdInput.value.trim() : '';

      container.innerHTML = tags.map(t => {
        // Normalize image URL
        let imgUrl = null;
        if (t.product_image_url) {
          imgUrl = normalizeImageUrlForTag(t.product_image_url);
        }
        
        const name = t.product_name || t.name || `Tag ${t.id || 'Unknown'}`;
        const timestamp = t.timestamp ?? 0;
        const ts = typeof timestamp === 'number' ? timestamp.toFixed(1) : String(timestamp);
        const productType = t.product_type || 'unknown';
        const views = t.views ?? 0;
        const clicks = t.clicks ?? 0;
        const sub = `${productType} â€¢ ${safeText(ts)}s â€¢ views ${views} â€¢ clicks ${clicks}`;
        
        // Escape HTML for image URL
        const escapedImgUrl = imgUrl ? imgUrl.replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
        
        const tagId = t.id || t.tag_id || '';
        // Escape videoId and tagId for use in onclick
        const escapedVideoId = safeText(videoId).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const escapedTagId = safeText(tagId).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const escapedName = safeText(name).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        return `
          <div class="tag-card" data-tag-id="${tagId}">
            <div class="tag-img">
              ${imgUrl ? `<img src="${escapedImgUrl}" alt="${safeText(name)}" onerror="this.parentElement.innerHTML='<span><i class=\\'fas fa-shopping-bag\\'></i></span>'">` : `<span><i class="fas fa-shopping-bag"></i></span>`}
            </div>
            <div class="tag-meta">
              <div class="tag-name">${safeText(name)}</div>
              <div class="tag-sub">${safeText(sub)}</div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button class="tag-edit-btn" onclick="editTag('${escapedVideoId}', '${escapedTagId}', this, event)" title="Edit tag">
                <i class="fas fa-edit"></i>
              </button>
              <button class="tag-delete-btn" onclick="deleteTag('${escapedVideoId}', '${escapedTagId}', '${escapedName}')" title="Delete tag">
              <i class="fas fa-trash"></i>
            </button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadTags() {
      const videoId = document.getElementById('videoId').value.trim();
      if (!videoId) {
        showToast('Please enter a video ID.', 'error');
        return;
      }
      // Current backend endpoint expects numeric native Video IDs
      if (!/^\d+$/.test(videoId)) {
        showToast('This Video ID is not a native numeric ID. Imported/shared videos (UUID) are not taggable yet in web.', 'error');
        return;
      }

      const container = document.getElementById('tags');
      container.innerHTML = '<div class="empty"><i class="fas fa-spinner fa-spin"></i> Loading tags...</div>';

      try {
        const tags = await SuperAffiliateAPI.getProductTagsForVideo(videoId);
        console.log('Loaded tags from API:', tags); // Debug log
        
        if (!tags || !Array.isArray(tags)) {
          console.warn('Tags response is not an array:', tags);
          container.innerHTML = `<div class="empty">No tags found for this video.</div>`;
          return;
        }
        
        // Store tags globally for edit functionality
        window.allTags = tags;
        
        renderTags(tags);
        
        if (tags.length === 0) {
          // Don't show toast for empty tags, just render empty state
        } else {
          console.log(`Successfully loaded ${tags.length} tag${tags.length !== 1 ? 's' : ''}`);
        }
      } catch (e) {
        console.error('Error loading tags:', e);
        let errorMsg = 'Failed to load product tags';
        if (e.message) {
          const msg = e.message.toLowerCase();
          if (msg.includes('not found') || msg.includes('404')) {
            errorMsg = 'Video not found. Please verify the Video ID is correct.';
          } else if (msg.includes('permission') || msg.includes('forbidden')) {
            errorMsg = 'You do not have permission to view tags for this video.';
          } else if (msg.includes('network') || msg.includes('timeout')) {
            errorMsg = 'Network error. Please check your connection and try again.';
          } else {
            errorMsg = e.message;
          }
        }
        container.innerHTML = `
          <div class="empty">
            <i class="fas fa-exclamation-circle" style="color: #ff0050; margin-bottom: 0.5rem;"></i>
            <p>${safeText(errorMsg)}</p>
            <button class="btn" onclick="loadTags()" style="margin-top: 1rem; font-size: 0.9rem;">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
        showToast(errorMsg, 'error');
      }
    }

    async function createTag() {
      const btn = document.getElementById('createBtn');
      const videoId = document.getElementById('videoId').value.trim();
      const productType = document.getElementById('productType').value;
      const timestampRaw = document.getElementById('timestamp').value.trim();
      const overlayStyle = document.getElementById('overlayStyle').value;
      const notes = document.getElementById('notes').value.trim();

      if (!videoId) {
        return showToast('Please enter a Video ID to tag products on your video.', 'error');
      }
      if (!/^\d+$/.test(videoId)) {
        return showToast(
          'This Video ID format is not supported. Only native videos (numeric IDs) can be tagged. ' +
          'Imported or shared videos (UUID format) are not taggable yet in the web app.',
          'error'
        );
      }

      const timestamp = timestampRaw ? Number(timestampRaw) : 0.0;
      if (Number.isNaN(timestamp) || timestamp < 0) {
        return showToast('Invalid timestamp. Please enter a number greater than or equal to 0 (e.g., 0, 5.5, 10).', 'error');
      }

      // Check if video already has a tag (single product per video enforcement)
      try {
        const existingTags = await SuperAffiliateAPI.getProductTagsForVideo(videoId);
        if (existingTags && existingTags.length > 0) {
          const existingTag = existingTags[0];
          const existingProductName = existingTag.product_name || existingTag.name || 'a product';
          const shouldProceed = confirm(
            `This video already has a product tag for "${existingProductName}".\n\n` +
            `Only one product can be tagged per video. Would you like to delete the existing tag and create a new one?`
          );
          
          if (!shouldProceed) {
            return;
          }

          // Delete existing tag
          try {
            await SuperAffiliateAPI.apiRequest(`/videos/${videoId}/product-tags/${existingTag.id}/`, {
              method: 'DELETE'
            });
            showToast('Existing tag deleted. Creating new tag...', 'info');
          } catch (error) {
            showToast(
              'Unable to delete the existing tag automatically. ' +
              'Please delete it manually from the tags list below and try again.',
              'error'
            );
            return;
          }
        }
      } catch (error) {
        // If we can't check for existing tags, continue (might be first tag)
        console.warn('Could not check for existing tags:', error);
      }

      const payload = {
        timestamp,
        position: { x: 0.8, y: 0.1 } // Default position (top-right)
      };

      if (productType === 'internal') {
        const internalId = document.getElementById('internalProductId').value.trim();
        if (!internalId) return showToast('Please select an internal product.', 'error');
        payload.internal_product = internalId;
      } else if (productType === 'marketplace') {
        const marketplaceId = document.getElementById('marketplaceProductId').value.trim();
        if (!marketplaceId) return showToast('Please select a marketplace product.', 'error');
        // Marketplace products are external products, use external_product field
        payload.external_product = marketplaceId;
      } else {
        const externalUrl = document.getElementById('externalProductUrl').value.trim();
        if (!externalUrl) {
          return showToast('Please enter a product URL from Jumia, Konga, Temu, or another supported platform.', 'error');
        }
        
        // Validate URL format
        try {
          new URL(externalUrl);
        } catch (e) {
          return showToast('Invalid URL format. Please enter a complete URL starting with http:// or https://', 'error');
        }
        
        // Detect platform before scraping
        const detectedPlatform = detectPlatform(externalUrl);
        const platformNames = {
          'jumia': 'Jumia',
          'konga': 'Konga',
          'temu': 'Temu',
          'amazon': 'Amazon',
          'aliexpress': 'AliExpress',
          'shopify': 'Shopify',
          'custom': 'Custom Store'
        };
        const platformName = platformNames[detectedPlatform] || 'this platform';
        
        // Show platform detection and scraping progress
        const urlInput = document.getElementById('externalProductUrl');
        const originalPlaceholder = urlInput.placeholder;
        urlInput.placeholder = `Detected: ${platformName}. Scraping product details...`;
        urlInput.disabled = true;
        
        // Try to create or get external product link
        try {
          // Scrape external product using the endpoint (same as Flutter app)
          const externalProduct = await SuperAffiliateAPI.apiRequest('/videos/external-products/scrape/', {
            method: 'POST',
            body: JSON.stringify({
              url: externalUrl,
              use_tanda_affiliate: true
            })
          });
          
          // The scrape endpoint returns { success: true, product: {...} }
          if (externalProduct && externalProduct.success && externalProduct.product && externalProduct.product.id) {
            payload.external_product = externalProduct.product.id;
            
            // Store the ID in hidden field for reference
            document.getElementById('externalProductId').value = externalProduct.product.id;
            
            // Show success message with product name if available
            const productName = externalProduct.product.product_name || externalProduct.product.name || 'product';
            showToast(`âœ… Product "${productName}" loaded successfully from ${platformName}!`, 'success');
          } else {
            urlInput.placeholder = originalPlaceholder;
            urlInput.disabled = false;
            return showToast(
              `Unable to extract product information from ${platformName}. ` +
              `The product page may be unavailable or the URL may be incorrect. Please verify the URL and try again.`,
              'error'
            );
          }
        } catch (error) {
          // Restore input state
          urlInput.placeholder = originalPlaceholder;
          urlInput.disabled = false;
          
          // Provide user-friendly error messages
          let errorMsg = 'Unknown error occurred';
          if (error.message) {
            const msg = error.message.toLowerCase();
            if (msg.includes('timeout') || msg.includes('connection')) {
              errorMsg = `Connection timeout. ${platformName} may be slow or temporarily unavailable. Please try again in a moment.`;
            } else if (msg.includes('403') || msg.includes('forbidden') || msg.includes('blocked')) {
              errorMsg = `Access blocked by ${platformName}. The product page may require authentication or may not be accessible.`;
            } else if (msg.includes('404') || msg.includes('not found')) {
              errorMsg = `Product not found. Please verify the URL is correct and the product still exists on ${platformName}.`;
            } else if (msg.includes('scraping') || msg.includes('extract')) {
              errorMsg = `Unable to extract product details from ${platformName}. The page structure may have changed. Please try a different product or contact support.`;
            } else {
              errorMsg = error.message;
            }
          } else if (error.details && error.details.error) {
            errorMsg = error.details.error;
          }
          
          return showToast(`Failed to process product from ${platformName}: ${errorMsg}`, 'error');
        } finally {
          // Always restore input state
          if (urlInput) {
            urlInput.placeholder = originalPlaceholder;
            urlInput.disabled = false;
          }
        }
      }

      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
      try {
        await SuperAffiliateAPI.createProductTag(Number(videoId), payload);
        showToast('âœ… Product tag created successfully! The tag will appear on your video.', 'success');
        document.getElementById('notes').value = '';
        await loadTags();
      } catch (e) {
        let errorMsg = 'Failed to create product tag';
        if (e.message) {
          const msg = e.message.toLowerCase();
          if (msg.includes('permission') || msg.includes('forbidden') || msg.includes('403')) {
            errorMsg = 'You do not have permission to tag products on this video. Please ensure you own this video.';
          } else if (msg.includes('not found') || msg.includes('404')) {
            errorMsg = 'Video not found. Please verify the Video ID is correct.';
          } else if (msg.includes('validation') || msg.includes('invalid')) {
            errorMsg = 'Invalid tag data. Please check all fields and try again.';
          } else {
            errorMsg = e.message;
          }
        }
        showToast(errorMsg, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plus"></i> Create Tag';
      }
    }

    function detectPlatform(url) {
      const lowerUrl = url.toLowerCase();
      if (lowerUrl.includes('jumia')) return 'jumia';
      if (lowerUrl.includes('temu')) return 'temu';
      if (lowerUrl.includes('amazon')) return 'amazon';
      if (lowerUrl.includes('aliexpress') || lowerUrl.includes('alibaba')) return 'aliexpress';
      if (lowerUrl.includes('konga')) return 'konga';
      if (lowerUrl.includes('shopify')) return 'shopify';
      return 'custom';
    }

    // Validate URL format and show real-time feedback
    function validateExternalUrl(url) {
      if (!url || url.trim() === '') {
        return { valid: false, message: 'Please enter a product URL' };
      }
      
      try {
        const urlObj = new URL(url);
        if (!['http:', 'https:'].includes(urlObj.protocol)) {
          return { valid: false, message: 'URL must start with http:// or https://' };
        }
        return { valid: true, message: null };
      } catch (e) {
        return { valid: false, message: 'Invalid URL format. Please enter a complete URL' };
      }
    }

    // Show platform detection in real-time as user types
    function updateExternalUrlFeedback() {
      const urlInput = document.getElementById('externalProductUrl');
      const url = urlInput.value.trim();
      
      // Remove any existing feedback elements
      const existingFeedback = urlInput.parentElement.querySelector('.url-feedback');
      if (existingFeedback) {
        existingFeedback.remove();
      }
      
      if (url.length === 0) {
        return;
      }
      
      const validation = validateExternalUrl(url);
      if (!validation.valid) {
        const feedback = document.createElement('div');
        feedback.className = 'url-feedback';
        feedback.style.cssText = 'color: #ff0050; font-size: 0.85rem; margin-top: 0.25rem;';
        feedback.textContent = validation.message;
        urlInput.parentElement.appendChild(feedback);
        return;
      }
      
      // Show detected platform
      const platform = detectPlatform(url);
      const platformNames = {
        'jumia': 'Jumia',
        'konga': 'Konga',
        'temu': 'Temu',
        'amazon': 'Amazon',
        'aliexpress': 'AliExpress',
        'shopify': 'Shopify',
        'custom': 'Custom Store'
      };
      const platformName = platformNames[platform] || 'Unknown Platform';
      
      const feedback = document.createElement('div');
      feedback.className = 'url-feedback';
      feedback.style.cssText = 'color: #00f2ea; font-size: 0.85rem; margin-top: 0.25rem;';
      feedback.innerHTML = `<i class="fas fa-check-circle"></i> Detected: ${platformName}`;
      urlInput.parentElement.appendChild(feedback);
    }

    // Edit tag functionality
    let currentEditTag = null;
    let currentEditVideoId = null;

    function editTag(videoId, tagId, buttonElement, event) {
      // Stop event propagation to prevent tag card click
      if (event) {
        event.stopPropagation();
      }

      // Find the tag data
      const tagCard = buttonElement.closest('.tag-card');
      if (!tagCard) return;

      const tagData = window.allTags ? window.allTags.find(t => (t.id || t.tag_id) === tagId) : null;
      if (!tagData) {
        showToast('Tag data not found', 'error');
        return;
      }

      // Only allow editing external products
      if (tagData.product_type !== 'external' && !tagData.external_product) {
        showToast('Only external products can be edited manually', 'error');
        return;
      }

      currentEditTag = tagData;
      currentEditVideoId = videoId;

      // Populate edit form
      document.getElementById('editTagName').value = tagData.product_name || tagData.name || '';
      document.getElementById('editTagPrice').value = tagData.product_price || tagData.price || '0';
      const imageUrl = tagData.product_image_url || tagData.image_url || '';
      document.getElementById('editTagImageUrl').value = imageUrl;
      document.getElementById('editTagProductUrl').value = tagData.product_url || tagData.url || tagData.link || '';
      
      // Update image preview
      updateEditTagImagePreview(imageUrl);

      // Show modal
      document.getElementById('editTagModal').style.display = 'flex';
    }

    function closeEditTagModal() {
      document.getElementById('editTagModal').style.display = 'none';
      currentEditTag = null;
      currentEditVideoId = null;
      // Reset image preview
      const imgElement = document.getElementById('editTagImagePreviewImg');
      const placeholderElement = document.getElementById('editTagImagePreviewPlaceholder');
      if (imgElement) {
        imgElement.style.display = 'none';
        imgElement.src = '';
      }
      if (placeholderElement) {
        placeholderElement.style.display = 'flex';
      }
    }

    // Update image preview in edit modal
    function updateEditTagImagePreview(url) {
      const imgElement = document.getElementById('editTagImagePreviewImg');
      const placeholderElement = document.getElementById('editTagImagePreviewPlaceholder');
      const urlInput = document.getElementById('editTagImageUrl');
      
      if (!imgElement || !placeholderElement) return;
      
      // Use provided URL or get from input field
      const imageUrl = url !== undefined ? url : (urlInput ? urlInput.value.trim() : '');
      
      if (imageUrl) {
        // Normalize URL (make absolute if relative)
        let normalizedUrl = imageUrl;
        if (imageUrl.startsWith('/')) {
          const apiBaseUrl = window.API_BASE_URL || 'https://api.tanda.media';
          normalizedUrl = apiBaseUrl + imageUrl;
        }
        
        imgElement.src = normalizedUrl;
        imgElement.style.display = 'block';
        placeholderElement.style.display = 'none';
      } else {
        imgElement.style.display = 'none';
        placeholderElement.style.display = 'flex';
        imgElement.src = '';
      }
    }

    async function saveTagEdit() {
      if (!currentEditTag || !currentEditVideoId) {
        showToast('No tag selected for editing', 'error');
        return;
      }

      const name = document.getElementById('editTagName').value.trim();
      if (!name) {
        showToast('Product name is required', 'error');
        return;
      }

      const priceInput = document.getElementById('editTagPrice').value.trim();
      const price = priceInput ? parseFloat(priceInput.replace(/,/g, '')) : 0;
      if (isNaN(price) || price < 0) {
        showToast('Please enter a valid price', 'error');
        return;
      }

      const imageUrl = document.getElementById('editTagImageUrl').value.trim();
      
      const productUrl = document.getElementById('editTagProductUrl').value.trim();
      if (!productUrl) {
        showToast('Product URL is required', 'error');
        return;
      }

      const saveBtn = document.getElementById('saveTagEditBtn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

      try {
        // Get current video to update product_tags
        const videoResponse = await SuperAffiliateAPI.apiRequest(`/videos/${currentEditVideoId}/`, {
          method: 'GET'
        });

        if (!videoResponse || !videoResponse.product_tags) {
          throw new Error('Video not found or has no tags');
        }

        // Find and update the tag
        const productTags = Array.isArray(videoResponse.product_tags) ? videoResponse.product_tags : [];
        const tagIndex = productTags.findIndex(t => (t.id || t.tag_id) === currentEditTag.id);
        
        if (tagIndex === -1) {
          throw new Error('Tag not found in video');
        }

        // Update tag data
        productTags[tagIndex].name = name;
        productTags[tagIndex].product_name = name;
        productTags[tagIndex].price = price.toString();
        productTags[tagIndex].product_price = price.toString();
        productTags[tagIndex].product_url = productUrl;
        productTags[tagIndex].url = productUrl; // Also set 'url' for backward compatibility
        productTags[tagIndex].link = productUrl; // Also set 'link' for backward compatibility
        if (imageUrl) {
          productTags[tagIndex].image_url = imageUrl;
          productTags[tagIndex].product_image_url = imageUrl;
        }

        // Update video via PUT endpoint
        await SuperAffiliateAPI.apiRequest(`/videos/${currentEditVideoId}/update/`, {
          method: 'PUT',
          body: JSON.stringify({
            product_tags: productTags
          })
        });

        // If this is an external product, also update the ExternalProductLink record
        // This ensures the product appears in the marketplace
        const externalProductId = currentEditTag.external_product_id || currentEditTag.external_product || currentEditTag.id;
        if (externalProductId && (currentEditTag.product_type === 'external' || currentEditTag.external_product)) {
          try {
            // Update the external product record to mark it as manually edited
            // This makes it appear in the marketplace
            const updateResponse = await SuperAffiliateAPI.apiRequest(`/videos/external-products/${externalProductId}/`, {
              method: 'PATCH',
              body: JSON.stringify({
                product_name: name,
                price: price,
                product_image_url: imageUrl || currentEditTag.product_image_url || '',
                original_url: productUrl,
                scrape_status: 'manual', // Mark as manually edited so it appears in marketplace
                is_active: true
              })
            });
            console.log('ExternalProductLink updated successfully:', updateResponse);
          } catch (error) {
            // Non-fatal: if external product update fails, the tag update still succeeded
            // This can happen if the product doesn't exist or user doesn't have permission
            console.warn('Failed to update external product record (this is OK if product was created by another user):', error);
            // Try to create the product if it doesn't exist (for marketplace visibility)
            // But don't block the tag update if this also fails
          }
        }

        showToast('Tag updated successfully', 'success');
        closeEditTagModal();
        loadTags(); // Reload tags to show updated data
      } catch (error) {
        console.error('Error updating tag:', error);
        let errorMsg = 'Failed to update tag';
        if (error.message) {
          errorMsg = error.message;
        }
        showToast(errorMsg, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
      }
    }

    // Publish to Tanda Feed
    async function publishToTandaFeed() {
      const videoId = document.getElementById('videoId').value.trim();
      if (!videoId || !/^\d+$/.test(videoId)) {
        showToast('Please enter a valid numeric video ID', 'error');
        return;
      }

      const publishBtn = document.getElementById('publishTandaBtn');
      const statusDiv = document.getElementById('publishTandaStatus');
      
      publishBtn.disabled = true;
      publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div style="color: var(--text-secondary);"><i class="fas fa-spinner fa-spin"></i> Publishing to Tanda feed...</div>';

      try {
        // Update video to be public and ready
        await SuperAffiliateAPI.apiRequest(`/videos/${videoId}/update/`, {
          method: 'PUT',
          body: JSON.stringify({
            is_public: true,
            processing_status: 'ready'
          })
        });

        statusDiv.innerHTML = '<div style="color: #00ff88;"><i class="fas fa-check-circle"></i> Successfully published to Tanda feed!</div>';
        showToast('Video published to Tanda feed', 'success');
      } catch (error) {
        console.error('Error publishing to Tanda feed:', error);
        let errorMsg = 'Failed to publish to Tanda feed';
        if (error.message) {
          const msg = error.message.toLowerCase();
          if (msg.includes('not found') || msg.includes('404')) {
            errorMsg = 'Video not found. Please verify the Video ID is correct.';
          } else if (msg.includes('permission') || msg.includes('forbidden')) {
            errorMsg = 'You do not have permission to publish this video.';
          } else {
            errorMsg = error.message;
          }
        }
        statusDiv.innerHTML = `<div style="color: #ff4444;"><i class="fas fa-times-circle"></i> ${errorMsg}</div>`;
        showToast(errorMsg, 'error');
      } finally {
        publishBtn.disabled = false;
        publishBtn.innerHTML = '<i class="fas fa-video"></i> Publish to Tanda Feed';
      }
    }

    async function deleteTag(videoId, tagId, tagName) {
      if (!confirm(`Are you sure you want to delete the tag "${tagName}"?\n\nThis action cannot be undone.`)) {
        return;
      }

      try {
        await SuperAffiliateAPI.apiRequest(`/videos/${videoId}/product-tags/${tagId}/`, {
          method: 'DELETE'
        });
        
        showToast('Tag deleted successfully', 'success');
        // Reload tags
        loadTags();
      } catch (error) {
        console.error('Error deleting tag:', error);
        let errorMsg = 'Failed to delete tag';
        if (error.message) {
          const msg = error.message.toLowerCase();
          if (msg.includes('not found') || msg.includes('404')) {
            errorMsg = 'Tag not found. It may have already been deleted.';
          } else if (msg.includes('permission') || msg.includes('forbidden')) {
            errorMsg = 'You do not have permission to delete this tag.';
          } else {
            errorMsg = error.message;
          }
        }
        showToast(errorMsg, 'error');
      }
    }

    // Update platform card selected state
    function updatePlatformCardState(checkbox) {
      const card = checkbox.closest('.platform-card');
      if (card) {
        if (checkbox.checked) {
          card.classList.add('platform-selected');
        } else {
          card.classList.remove('platform-selected');
        }
      }
    }

    // Platform connections state
    let connectedPlatforms = [];
    
    // Platform metadata
    const platformMetadata = {
      youtube: {
        name: 'YouTube',
        desc: 'Video sharing platform',
        icon: 'fab fa-youtube',
        iconClass: 'youtube-icon',
        hasFormatOptions: true
      },
      tiktok: {
        name: 'TikTok',
        desc: 'Short-form videos',
        icon: 'fab fa-tiktok',
        iconClass: 'tiktok-icon',
        hasFormatOptions: false
      },
      instagram: {
        name: 'Instagram',
        desc: 'Photo & video sharing',
        icon: 'fab fa-instagram',
        iconClass: 'instagram-icon',
        hasFormatOptions: false
      },
      facebook: {
        name: 'Facebook',
        desc: 'Social network',
        icon: 'fab fa-facebook',
        iconClass: 'facebook-icon',
        hasFormatOptions: false
      }
    };

    // Load connected platforms
    async function loadConnectedPlatforms() {
      const platformSelection = document.getElementById('platformSelection');
      const loadingState = document.getElementById('platforms-loading');
      const emptyState = document.getElementById('platforms-empty');
      const connectMessage = document.getElementById('platform-connect-message');
      
      try {
        // Make sure we clear any existing platform cards first
        const existingCards = platformSelection.querySelectorAll('.platform-card');
        existingCards.forEach(card => card.remove());
        
        const response = await SuperAffiliateAPI.apiRequest('/videos/platforms/connections/');
        
        console.log('Platform connections API response:', response);
        
        // Handle case where API returns null (404 or other expected errors)
        if (!response || !response.connections) {
          console.log('No platform connections found or API returned null');
          connectedPlatforms = [];
        } else {
          const connections = response.connections || [];
          console.log('All connections:', connections);
          
          // Filter only connected platforms (status === 'connected' - case insensitive)
          connectedPlatforms = connections.filter(conn => {
            if (!conn || !conn.platform) return false;
            const status = (conn.status || '').toLowerCase();
            const isConnected = status === 'connected';
            console.log(`Platform ${conn.platform}: status="${conn.status}" (normalized: "${status}"), isConnected=${isConnected}`);
            return isConnected;
          });
          
          console.log('Filtered connected platforms:', connectedPlatforms);
        }
        
        // Hide loading state
        if (loadingState) loadingState.style.display = 'none';
        
        if (connectedPlatforms.length === 0) {
          // Show empty state
          if (emptyState) emptyState.style.display = 'block';
          if (connectMessage) connectMessage.style.display = 'none';
          // Hide publish button if no platforms
          const publishBtn = document.getElementById('publishBtn');
          if (publishBtn) publishBtn.style.display = 'none';
        } else {
          // Hide empty state
          if (emptyState) emptyState.style.display = 'none';
          // Show connect message
          if (connectMessage) connectMessage.style.display = 'flex';
          // Show publish button
          const publishBtn = document.getElementById('publishBtn');
          if (publishBtn) publishBtn.style.display = 'block';
          
          // Render connected platforms
          renderConnectedPlatforms();
        }
      } catch (error) {
        console.error('Error loading platform connections:', error);
        // Hide loading, show empty state with error message
        if (loadingState) loadingState.style.display = 'none';
        if (emptyState) {
          emptyState.style.display = 'block';
          const emptyText = emptyState.querySelector('.platform-empty-text');
          if (emptyText) {
            emptyText.innerHTML = `
              <p><strong>Unable to load platforms</strong></p>
              <p>${error.message || 'Please try again later.'}</p>
            `;
          }
        }
        // Make sure no platform cards are shown on error
        connectedPlatforms = [];
        const existingCards = platformSelection.querySelectorAll('.platform-card');
        existingCards.forEach(card => card.remove());
      }
    }

    // Render connected platforms
    function renderConnectedPlatforms() {
      const platformSelection = document.getElementById('platformSelection');
      const loadingState = document.getElementById('platforms-loading');
      const emptyState = document.getElementById('platforms-empty');
      
      // Clear ALL existing platform cards (but keep loading/empty states)
      const existingCards = platformSelection.querySelectorAll('.platform-card');
      existingCards.forEach(card => card.remove());
      
      // Hide loading and empty states
      if (loadingState) loadingState.style.display = 'none';
      if (emptyState) emptyState.style.display = 'none';
      
      console.log('Rendering connected platforms:', connectedPlatforms);
      
      // Safety check: only render if we have connected platforms
      if (!connectedPlatforms || connectedPlatforms.length === 0) {
        console.warn('No connected platforms to render');
        return;
      }
      
      // Render each connected platform
      connectedPlatforms.forEach(connection => {
        const platform = connection.platform;
        const metadata = platformMetadata[platform];
        
        if (!metadata) {
          console.warn(`Unknown platform: ${platform}`);
          return;
        }
        
        const platformCard = document.createElement('div');
        platformCard.className = 'platform-card';
        platformCard.innerHTML = `
          <label class="platform-label" for="platform-${platform}">
            <input type="checkbox" id="platform-${platform}" value="${platform}" class="platform-checkbox">
            <div class="platform-content">
              <div class="platform-icon ${metadata.iconClass}">
                <i class="${metadata.icon}"></i>
              </div>
              <div class="platform-info">
                <div class="platform-name">${metadata.name}</div>
                <div class="platform-desc">${connection.platform_username ? `@${connection.platform_username}` : metadata.desc}</div>
              </div>
            </div>
          </label>
          ${metadata.hasFormatOptions ? `
            <div id="${platform}-options" class="platform-options" style="display: none;">
              <div class="platform-option-title">Upload Format:</div>
              <div class="platform-radio-group">
                <label class="platform-radio-label">
                  <input type="radio" name="youtube-format" value="short" checked>
                  <span class="radio-custom"></span>
                  <span class="radio-text">
                    <strong>Short</strong>
                    <small>Portrait (9:16)</small>
                  </span>
                </label>
                <label class="platform-radio-label">
                  <input type="radio" name="youtube-format" value="regular">
                  <span class="radio-custom"></span>
                  <span class="radio-text">
                    <strong>Regular</strong>
                    <small>Landscape (16:9)</small>
                  </span>
                </label>
              </div>
            </div>
          ` : ''}
        `;
        
        platformSelection.appendChild(platformCard);
        
        // Add event listeners
        const checkbox = platformCard.querySelector(`#platform-${platform}`);
        if (checkbox) {
          updatePlatformCardState(checkbox);
          checkbox.addEventListener('change', function() {
            updatePlatformCardState(this);
            if (metadata.hasFormatOptions) {
              const options = document.getElementById(`${platform}-options`);
              if (options) {
                options.style.display = this.checked ? 'block' : 'none';
                if (this.checked) {
                  options.style.animation = 'slideDown 0.3s ease';
                }
              }
            }
          });
        }
      });
    }

    async function publishToPlatforms() {
      const videoId = document.getElementById('videoId').value.trim();
      if (!videoId || !/^\d+$/.test(videoId)) {
        showToast('Please enter a valid numeric video ID', 'error');
        return;
      }

      // Get selected platforms dynamically from checkboxes
      const selectedPlatforms = [];
      connectedPlatforms.forEach(connection => {
        const platform = connection.platform;
        const checkbox = document.getElementById(`platform-${platform}`);
        if (checkbox && checkbox.checked) {
          selectedPlatforms.push(platform);
      }
      });

      if (selectedPlatforms.length === 0) {
        showToast('Please select at least one platform', 'error');
        return;
      }

      const publishBtn = document.getElementById('publishBtn');
      const statusDiv = document.getElementById('publishStatus');
      
      publishBtn.disabled = true;
      publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div style="color: var(--text-secondary);"><i class="fas fa-spinner fa-spin"></i> Publishing to platforms...</div>';

      try {
        const youtubeFormat = document.querySelector('input[name="youtube-format"]:checked')?.value || 'short';
        
        const payload = {
          platforms: selectedPlatforms,
          visibility: 'public',
          youtube_upload_format: youtubeFormat
        };

        const response = await SuperAffiliateAPI.apiRequest(`/videos/${videoId}/publish/`, {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        const successCount = response.results?.filter(r => r.success).length || 0;
        const totalCount = response.results?.length || 0;

        if (successCount === totalCount) {
          statusDiv.innerHTML = `<div style="color: #00ff88;"><i class="fas fa-check-circle"></i> Successfully published to all ${totalCount} platform(s)!</div>`;
          showToast(`Published to ${totalCount} platform(s)`, 'success');
        } else {
          const errors = response.results?.filter(r => !r.success).map(r => `${r.platform}: ${r.error}`).join('<br>') || '';
          statusDiv.innerHTML = `<div style="color: #ffaa00;"><i class="fas fa-exclamation-triangle"></i> Published to ${successCount}/${totalCount} platforms.<br>${errors}</div>`;
          showToast(`Published to ${successCount}/${totalCount} platforms`, 'error');
        }

        // Show platform URLs if available
        const urls = response.results?.filter(r => r.platform_video_url).map(r => 
          `<a href="${r.platform_video_url}" target="_blank" style="color: var(--accent-color);">View on ${r.platform}</a>`
        ).join(' | ') || '';
        if (urls) {
          statusDiv.innerHTML += `<div style="margin-top: 0.5rem;">${urls}</div>`;
        }

      } catch (error) {
        console.error('Error publishing:', error);
        statusDiv.innerHTML = `<div style="color: #ff4444;"><i class="fas fa-times-circle"></i> ${error.message || 'Failed to publish'}</div>`;
        showToast(error.message || 'Failed to publish to platforms', 'error');
      } finally {
        publishBtn.disabled = false;
        publishBtn.innerHTML = '<i class="fas fa-upload"></i> Publish to Selected Platforms';
      }
    }

    // Initialize
    toggleProductInputs();
    if (initialVideoId) loadTags();
    
    // Pre-check user role on page load
    checkUserRole();
    
    // Load connected platforms on page load (wait for auth to be ready)
    // Use DOMContentLoaded or immediate execution
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        loadConnectedPlatforms();
      });
    } else {
      // DOM already loaded
      loadConnectedPlatforms();
    }
  </script>

  <!-- Edit Tag Modal -->
  <div id="editTagModal" class="product-modal" style="display: none;" onclick="if(event.target.id === 'editTagModal') closeEditTagModal()">
    <div class="product-modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
      <div class="product-modal-header">
        <h2>Edit Product Tag</h2>
        <button class="product-modal-close" onclick="closeEditTagModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div style="padding: 1rem;">
        <!-- Product Image Preview -->
        <div style="margin-bottom: 1.5rem; text-align: center;">
          <div style="margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500; font-size: 0.9rem;">Product Image</div>
          <div id="editTagImagePreview" style="width: 200px; height: 200px; margin: 0 auto; border-radius: 0.75rem; overflow: hidden; background: var(--bg-secondary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; position: relative;">
            <img id="editTagImagePreviewImg" src="" alt="Product image" style="width: 100%; height: 100%; object-fit: cover; display: none;" onerror="this.style.display='none'; document.getElementById('editTagImagePreviewPlaceholder').style.display='flex';" />
            <div id="editTagImagePreviewPlaceholder" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; color: var(--text-secondary);">
              <i class="fas fa-image" style="font-size: 3rem; opacity: 0.5;"></i>
            </div>
          </div>
        </div>
        
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500;">Product Name *</label>
          <input type="text" id="editTagName" class="search-input" placeholder="Enter product name" required />
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500;">Price (â‚¦)</label>
          <input type="text" id="editTagPrice" class="search-input" placeholder="0.00" pattern="[0-9.]*" />
          <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Enter numbers only (no commas)
          </small>
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500;">Product Image URL</label>
          <input type="url" id="editTagImageUrl" class="search-input" placeholder="https://example.com/image.jpg" oninput="updateEditTagImagePreview()" />
          <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Leave empty to keep current image
          </small>
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500;">Product URL *</label>
          <input type="url" id="editTagProductUrl" class="search-input" placeholder="https://example.com/product" required />
          <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            The URL buyers will click to view/purchase the product
          </small>
        </div>
      </div>
      <div class="product-modal-footer">
        <button class="btn secondary" onclick="closeEditTagModal()">Cancel</button>
        <button class="btn" onclick="saveTagEdit()" id="saveTagEditBtn">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </div>
  </div>

  <style>
    .tag-card {
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .tag-card:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    .tag-edit-btn, .tag-delete-btn {
      background: rgba(0, 242, 234, 0.2);
      border: 1px solid rgba(0, 242, 234, 0.3);
      color: var(--accent-color);
      border-radius: 0.5rem;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }
    .tag-edit-btn:hover {
      background: rgba(0, 242, 234, 0.3);
      transform: scale(1.1);
    }
    .tag-delete-btn {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid rgba(255, 0, 0, 0.3);
      color: #ff4444;
    }
    .tag-delete-btn:hover {
      background: rgba(255, 0, 0, 0.3);
      transform: scale(1.1);
    }
  </style>
</body>
</html>


