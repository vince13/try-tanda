<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  <meta name="theme-color" content="#ff0050">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tanda">
  <title>Checkout - Tanda Web</title>

  <link rel="icon" type="image/png" sizes="32x32" href="Tanda logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #ff0050, #00f2ea);
      --accent-color: #00f2ea;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --bg-card: rgba(255, 255, 255, 0.05);
      --border-radius: 1rem;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      min-height: 100vh;
      padding: 2rem;
    }

    /* Safe area insets for iPhone notches and home indicator */
    @supports (padding: env(safe-area-inset-top)) {
      .header {
        padding-top: calc(2rem + env(safe-area-inset-top));
        padding-left: calc(2rem + env(safe-area-inset-left));
        padding-right: calc(2rem + env(safe-area-inset-right));
      }

      .container {
        padding-left: calc(2rem + env(safe-area-inset-left));
        padding-right: calc(2rem + env(safe-area-inset-right));
      }

      @media (max-width: 768px) {
        .container {
          padding-left: calc(1rem + env(safe-area-inset-left));
          padding-right: calc(1rem + env(safe-area-inset-right));
        }
      }
    }

    /* iOS keyboard handling - prevent zoom on input focus */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    input[type="tel"],
    input[type="url"],
    input[type="search"],
    textarea,
    select {
      font-size: 16px !important;
    }

    input[type="number"] {
      inputmode: "numeric";
    }

    input[type="tel"] {
      inputmode: "tel";
    }

    input[type="email"] {
      inputmode: "email";
    }

    .header {
      max-width: 1200px;
      margin: 0 auto 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .title {
      font-size: 1.8rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }

    .nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Mobile: Add horizontal scroll to nav items - same as profile.html */
    @media (max-width: 768px) {
      .nav {
        gap: 0.25rem;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        scroll-behavior: smooth;
      }
      
      .nav::-webkit-scrollbar {
        display: none;
      }
      
      /* Ensure nav children don't shrink */
      .nav > * {
        flex-shrink: 0;
      }
      
      /* Ensure user menu dropdown can escape overflow on mobile */
      .nav .user-menu-dropdown {
        overflow: visible !important;
        position: relative !important;
      }
      
      .nav .user-menu-wrapper {
        overflow: visible !important;
      }
    }
    
    @media (max-width: 480px) {
      .nav {
        gap: 0.15rem;
      }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .checkout-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
    }

    .card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 2rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      margin-bottom: 1.5rem;
      color: var(--accent-color);
      font-size: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.9rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 0.6rem;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      background: rgba(255, 255, 255, 0.08);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .summary {
      position: sticky;
      top: 2rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .summary-total {
      font-size: 1.5rem;
      font-weight: 800;
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: 1rem;
      margin-top: 1rem;
    }

    .btn {
      padding: 1rem 2rem;
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 0.6rem;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      justify-content: center;
      margin-top: 1.5rem;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 0, 80, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      padding: 0.75rem 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.6rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--accent-color);
    }

    .address-option {
      padding: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.6rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.03);
    }

    .address-option:hover {
      border-color: var(--accent-color);
      background: rgba(255, 255, 255, 0.05);
    }

    .address-option.selected {
      border-color: var(--accent-color);
      background: rgba(0, 242, 234, 0.1);
    }

    .address-option input[type="radio"] {
      margin-right: 0.75rem;
      width: auto;
    }

    .address-option-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .address-option-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .address-option-default {
      background: var(--primary-gradient);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .address-option-details {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    /* Shipping Method Selection Styles */
    .shipping-methods-section {
      margin-top: 0.5rem;
    }
    
    .seller-shipping-group {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .seller-shipping-group:last-child {
      margin-bottom: 0;
    }
    
    .seller-shipping-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .seller-shipping-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }
    
    .seller-shipping-info {
      flex: 1;
      min-width: 0;
    }
    
    .seller-shipping-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .seller-shipping-items {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    
    .shipping-option {
      padding: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.6rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.02);
    }
    
    .shipping-option:last-child {
      margin-bottom: 0;
    }
    
    .shipping-option:hover {
      border-color: var(--accent-color);
      background: rgba(255, 255, 255, 0.05);
    }
    
    .shipping-option.selected {
      border-color: var(--accent-color);
      background: rgba(0, 242, 234, 0.1);
    }
    
    .shipping-option-content {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    
    .shipping-option input[type="radio"] {
      margin-top: 0.25rem;
      width: auto;
      flex-shrink: 0;
    }
    
    .shipping-option-details {
      flex: 1;
      min-width: 0;
    }
    
    .shipping-option-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 0.25rem;
    }
    
    .shipping-option-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }
    
    .shipping-option-price {
      color: var(--accent-color);
      font-weight: 700;
      font-size: 1rem;
      flex-shrink: 0;
    }
    
    .shipping-option-price.free {
      background: linear-gradient(135deg, #00c853, #00f2ea);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .shipping-option-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 1rem;
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }
    
    .shipping-option-meta span {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    
    .shipping-option-meta i {
      font-size: 0.75rem;
      opacity: 0.7;
    }
    
    .shipping-loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }
    
    .shipping-loading i {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    
    .no-shipping-methods {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-secondary);
      background: rgba(255, 0, 80, 0.1);
      border: 1px solid rgba(255, 0, 80, 0.2);
      border-radius: 0.6rem;
    }
    
    .no-shipping-methods i {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      display: block;
      color: #ff0050;
    }
    
    /* Shipping breakdown in summary */
    .shipping-breakdown {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      padding-left: 0.5rem;
      border-left: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .shipping-breakdown-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.25rem;
      gap: 0.5rem;
    }
    
    .shipping-breakdown-item:last-child {
      margin-bottom: 0;
    }
    
    .shipping-breakdown-seller {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }
    
    .shipping-breakdown-cost {
      flex-shrink: 0;
      color: var(--accent-color);
    }
    
    @media (max-width: 768px) {
      .seller-shipping-group {
        padding: 0.75rem;
      }
      
      .seller-shipping-icon {
        width: 36px;
        height: 36px;
        font-size: 0.9rem;
      }
      
      .shipping-option {
        padding: 0.75rem;
      }
      
      .shipping-option-header {
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .shipping-option-meta {
        flex-direction: column;
        gap: 0.25rem;
      }
    }

    .order-item {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .order-item-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 0.5rem;
      background: rgba(255,255,255,0.05);
    }

    .order-item-details {
      flex: 1;
    }

    .order-item-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .order-item-meta {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .title {
        font-size: 1.5rem;
      }

      .checkout-layout {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .card {
        padding: 1.5rem;
      }

      .summary {
        position: static;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .order-item {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .item-image {
        width: 100%;
        max-width: 150px;
        margin: 0 auto;
      }

      .btn {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 0.75rem;
      }

      .title {
        font-size: 1.3rem;
      }

      .card {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 class="title">Checkout</h1>
    <div class="nav" id="authNav"></div>
  </div>

  <div class="container">
    <div id="loading-section" class="loading">
      <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
      <p>Loading checkout...</p>
    </div>

    <div id="checkout-section" style="display: none;">
      <div class="checkout-layout">
        <div>
          <form id="checkout-form" onsubmit="handleCheckout(event)">
            <div class="card">
              <h2>Shipping Address</h2>
              
              <!-- Address Selection Section -->
              <div id="address-selection-section" style="display: none;">
                <div class="form-group">
                  <label>Select an Address</label>
                  <div id="address-list" style="margin-bottom: 1rem;"></div>
                  <button type="button" class="btn-secondary" onclick="showNewAddressForm()" style="width: auto; margin-top: 0.5rem;">
                    <i class="fas fa-plus"></i> Add New Address
                  </button>
                </div>
              </div>

              <!-- New Address Form Section -->
              <div id="new-address-form">
                <div class="form-group">
                  <label for="shipping-full-name">Full Name</label>
                  <input type="text" id="shipping-full-name" required>
                </div>
                <div class="form-group">
                  <label for="shipping-phone">Phone Number</label>
                  <input type="tel" id="shipping-phone" required>
                </div>
                <div class="form-group">
                  <label for="shipping-address">Address</label>
                  <textarea id="shipping-address" rows="3" required></textarea>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="shipping-city">City</label>
                    <input type="text" id="shipping-city" required>
                  </div>
                  <div class="form-group">
                    <label for="shipping-state">State</label>
                    <input type="text" id="shipping-state" required>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="shipping-country">Country</label>
                    <input type="text" id="shipping-country" value="Nigeria" required>
                  </div>
                  <div class="form-group">
                    <label for="shipping-postal-code">Postal Code</label>
                    <input type="text" id="shipping-postal-code" placeholder="Optional">
                  </div>
                </div>
              </div>
            </div>

            <!-- Shipping Method Selection -->
            <div class="card" id="shipping-method-card" style="display: none;">
              <h2><i class="fas fa-truck" style="margin-right: 0.5rem;"></i>Shipping Method</h2>
              <div id="shipping-methods-container">
                <div class="shipping-loading">
                  <i class="fas fa-spinner fa-spin"></i>
                  <span>Loading shipping options...</span>
                </div>
              </div>
            </div>

            <div class="card">
              <h2>Payment Method</h2>
              <div class="form-group">
                <label>
                  <input type="radio" name="payment_method" value="paystack" checked style="width: auto; margin-right: 0.5rem;">
                  Paystack (Card, Bank Transfer)
                </label>
              </div>
            </div>

            <button type="submit" class="btn" id="checkout-btn">
              <i class="fas fa-lock"></i> Complete Order
            </button>
          </form>
        </div>

        <div class="summary card">
          <h2>Order Summary</h2>
          <div id="order-items"></div>
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="subtotal">₦0.00</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span id="shipping">₦0.00</span>
          </div>
          <div id="shipping-breakdown" class="shipping-breakdown" style="display: none;">
            <!-- Shipping breakdown per seller will be populated here -->
          </div>
          <div class="summary-row summary-total">
            <span>Total</span>
            <span id="total">₦0.00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/super-affiliate-api.js?v=3"></script>
  <script>
    let cartData = null;
    let shippingAddresses = [];
    let selectedAddressId = null;
    let currentShippingCost = 0;
    
    // Shipping method selection state
    let sellerShippingOptions = {};  // { sellerId: { seller_name, items: [], options: [...] } }
    let selectedShippingMethods = {}; // { sellerId: { method_id, method_name, cost } }

    // Check authentication
    if (!SuperAffiliateAPI.isAuthenticated()) {
      window.location.href = 'super-affiliate-login.html?redirect=' + encodeURIComponent(window.location.href);
    }

    // Render auth nav
    SuperAffiliateAPI.renderAuthNav('authNav');

    async function loadCart() {
      try {
        const response = await SuperAffiliateAPI.getCart();
        cartData = response;
        displayOrderSummary(response);
        document.getElementById('loading-section').style.display = 'none';
        document.getElementById('checkout-section').style.display = 'block';
        
        // Load shipping addresses
        await loadShippingAddresses();
      } catch (error) {
        console.error('Error loading cart:', error);
        window.location.href = 'cart.html';
      }
    }

    async function loadShippingAddresses() {
      try {
        const response = await SuperAffiliateAPI.apiRequest('/commerce/shipping/addresses/');
        // Handle both array and paginated response formats
        shippingAddresses = Array.isArray(response) 
          ? response 
          : (response.results || response.data || []);
        
        if (shippingAddresses && shippingAddresses.length > 0) {
          // Show address selection, hide new address form
          displayAddressSelection();
        } else {
          // No addresses - require new address form
          document.getElementById('address-selection-section').style.display = 'none';
          document.getElementById('new-address-form').style.display = 'block';
          // Reset shipping cost when no address is selected
          currentShippingCost = 0;
          updateOrderTotals();
        }
      } catch (error) {
        console.error('Error loading shipping addresses:', error);
        // If error, show new address form as fallback
        document.getElementById('address-selection-section').style.display = 'none';
        document.getElementById('new-address-form').style.display = 'block';
      }
    }

    function displayAddressSelection() {
      const addressList = document.getElementById('address-list');
      const selectionSection = document.getElementById('address-selection-section');
      const newAddressForm = document.getElementById('new-address-form');
      
      // Show selection section, hide new address form
      selectionSection.style.display = 'block';
      newAddressForm.style.display = 'none';
      
      // Remove required attributes from new address form fields when selection is shown
      const newAddressFields = newAddressForm.querySelectorAll('input[required], textarea[required]');
      newAddressFields.forEach(field => {
        field.removeAttribute('required');
      });
      
      // Find default address or first address
      const defaultAddress = shippingAddresses.find(addr => addr.is_default) || shippingAddresses[0];
      if (defaultAddress) {
        selectedAddressId = defaultAddress.id;
        // Calculate shipping when address is selected
        calculateShippingCost(defaultAddress.id);
      }
      
      addressList.innerHTML = shippingAddresses.map(address => `
        <div class="address-option ${address.id === selectedAddressId ? 'selected' : ''}" onclick="selectAddress(${address.id})">
          <div class="address-option-header">
            <label style="display: flex; align-items: center; cursor: pointer; width: 100%;">
              <input type="radio" name="shipping-address" value="${address.id}" ${address.id === selectedAddressId ? 'checked' : ''} onchange="selectAddress(${address.id})">
              <span class="address-option-name">${address.full_name}</span>
            </label>
            ${address.is_default ? '<span class="address-option-default">Default</span>' : ''}
          </div>
          <div class="address-option-details">
            <div>${address.phone_number}</div>
            <div>${address.street_address}${address.apartment_suite ? ', ' + address.apartment_suite : ''}</div>
            <div>${address.city}, ${address.state}${address.postal_code ? ' ' + address.postal_code : ''}</div>
            <div>${address.country}</div>
          </div>
        </div>
      `).join('');
    }

    function selectAddress(addressId) {
      selectedAddressId = addressId;
      // Update visual selection
      document.querySelectorAll('.address-option').forEach(option => {
        option.classList.remove('selected');
        const radio = option.querySelector('input[type="radio"]');
        if (radio && parseInt(radio.value) === addressId) {
          option.classList.add('selected');
          radio.checked = true;
        }
      });
      // Calculate shipping cost when address changes
      calculateShippingCost(addressId);
    }

    function showNewAddressForm() {
      document.getElementById('address-selection-section').style.display = 'none';
      document.getElementById('new-address-form').style.display = 'block';
      selectedAddressId = null;
      
      // Clear any selected radio buttons
      document.querySelectorAll('input[name="shipping-address"]').forEach(radio => {
        radio.checked = false;
      });
      
      // Add required attributes back to new address form fields
      const newAddressForm = document.getElementById('new-address-form');
      const requiredFields = [
        'shipping-full-name',
        'shipping-phone',
        'shipping-address',
        'shipping-city',
        'shipping-state',
        'shipping-country'
      ];
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.setAttribute('required', 'required');
        }
      });
    }

    function displayOrderSummary(data) {
      const items = data.items || [];
      const formatCurrency = (amount) => {
        return `₦${parseFloat(amount || 0).toLocaleString('en-NG', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      };

      const itemsHtml = items.map(item => `
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span>${item.product?.name || 'Product'} x${item.quantity}</span>
          <span>${formatCurrency((item.product?.price || 0) * item.quantity)}</span>
        </div>
      `).join('');

      document.getElementById('order-items').innerHTML = itemsHtml;

      updateOrderTotals();
    }

    function updateOrderTotals() {
      if (!cartData) return;
      
      const items = cartData.items || [];
      const formatCurrency = (amount) => {
        return `₦${parseFloat(amount || 0).toLocaleString('en-NG', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      };

      const subtotal = items.reduce((sum, item) => sum + (parseFloat(item.product?.price || 0) * item.quantity), 0);
      const shipping = currentShippingCost;
      const total = subtotal + shipping;

      document.getElementById('subtotal').textContent = formatCurrency(subtotal);
      document.getElementById('shipping').textContent = formatCurrency(shipping);
      document.getElementById('total').textContent = formatCurrency(total);
    }

    async function calculateShippingCost(addressId) {
      if (!cartData || !addressId) {
        currentShippingCost = 0;
        sellerShippingOptions = {};
        selectedShippingMethods = {};
        document.getElementById('shipping-method-card').style.display = 'none';
        updateOrderTotals();
        return;
      }

      try {
        // Show shipping method card with loading state
        const shippingCard = document.getElementById('shipping-method-card');
        const shippingContainer = document.getElementById('shipping-methods-container');
        shippingCard.style.display = 'block';
        shippingContainer.innerHTML = `
          <div class="shipping-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Loading shipping options...</span>
          </div>
        `;

        // Get the selected address
        const address = shippingAddresses.find(addr => addr.id === addressId);
        if (!address) {
          currentShippingCost = 0;
          shippingCard.style.display = 'none';
          updateOrderTotals();
          return;
        }

        // Group items by seller
        const items = cartData.items || [];
        const itemsBySeller = {};
        items.forEach(item => {
          const sellerId = item.product?.creator?.id;
          if (sellerId) {
            if (!itemsBySeller[sellerId]) {
              itemsBySeller[sellerId] = {
                seller: item.product.creator,
                items: [],
                subtotal: 0
              };
            }
            itemsBySeller[sellerId].items.push(item);
            itemsBySeller[sellerId].subtotal += parseFloat(item.product?.price || 0) * item.quantity;
          }
        });

        // Fetch shipping options for each seller
        sellerShippingOptions = {};
        selectedShippingMethods = {};
        
        for (const [sellerId, sellerGroup] of Object.entries(itemsBySeller)) {
          try {
            // Get seller ID from product's creator_seller_info if available, otherwise use creator ID
            // Note: sellerId is the user ID, but we need the Seller model ID
            let sellerModelId = parseInt(sellerId);
            const firstProduct = sellerGroup.items[0]?.product;
            if (firstProduct?.creator_seller_info?.id) {
              sellerModelId = parseInt(firstProduct.creator_seller_info.id);
            }
            
            const response = await SuperAffiliateAPI.apiRequest('/commerce/shipping/calculator/', {
              method: 'POST',
              body: JSON.stringify({
                seller_id: sellerModelId,
                shipping_address_id: parseInt(addressId),
                order_total: sellerGroup.subtotal
              })
            });

            if (response.shipping_options && response.shipping_options.length > 0) {
              const availableOptions = response.shipping_options.filter(opt => opt.is_available);
              
              if (availableOptions.length > 0) {
                sellerShippingOptions[sellerId] = {
                  seller_name: response.seller_name || sellerGroup.seller.username || sellerGroup.seller.shop_name || `Seller ${sellerId}`,
                  items: sellerGroup.items,
                  options: availableOptions
                };
                
                // Auto-select cheapest option
                const cheapest = availableOptions.reduce((min, opt) => 
                  (opt.cost < min.cost) ? opt : min
                );
                selectedShippingMethods[sellerId] = {
                  method_id: cheapest.shipping_method_id,
                  method_name: cheapest.method_name,
                  cost: parseFloat(cheapest.cost || 0)
                };
              }
            }
          } catch (error) {
            console.error('Error fetching shipping for seller:', sellerId, error);
          }
        }

        // Display shipping options
        displayShippingMethods();
        
        // Calculate total shipping
        recalculateTotalShipping();
        
      } catch (error) {
        console.error('Error calculating shipping cost:', error);
        currentShippingCost = 0;
        document.getElementById('shipping-method-card').style.display = 'none';
        updateOrderTotals();
      }
    }
    
    function displayShippingMethods() {
      const container = document.getElementById('shipping-methods-container');
      const sellerIds = Object.keys(sellerShippingOptions);
      
      if (sellerIds.length === 0) {
        container.innerHTML = `
          <div class="no-shipping-methods">
            <i class="fas fa-exclamation-triangle"></i>
            <div>No shipping methods available for your location.</div>
            <small>Please try a different address or contact the seller.</small>
          </div>
        `;
        document.getElementById('shipping-method-card').style.display = 'block';
        return;
      }
      
      const formatCurrency = (amount) => {
        if (amount === 0) return 'FREE';
        return `₦${parseFloat(amount || 0).toLocaleString('en-NG', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      };
      
      let html = '<div class="shipping-methods-section">';
      
      for (const sellerId of sellerIds) {
        const sellerData = sellerShippingOptions[sellerId];
        const itemCount = sellerData.items.length;
        const selectedMethod = selectedShippingMethods[sellerId];
        
        html += `
          <div class="seller-shipping-group" data-seller-id="${sellerId}">
            <div class="seller-shipping-header">
              <div class="seller-shipping-icon">
                <i class="fas fa-store"></i>
              </div>
              <div class="seller-shipping-info">
                <div class="seller-shipping-name">${sellerData.seller_name}</div>
                <div class="seller-shipping-items">${itemCount} item${itemCount > 1 ? 's' : ''}</div>
              </div>
            </div>
            <div class="seller-shipping-options">
        `;
        
        for (const option of sellerData.options) {
          const isSelected = selectedMethod && selectedMethod.method_id === option.shipping_method_id;
          const priceClass = option.cost === 0 ? 'free' : '';
          
          html += `
            <div class="shipping-option ${isSelected ? 'selected' : ''}" 
                 onclick="selectShippingMethod('${sellerId}', '${option.shipping_method_id}', '${option.method_name}', ${option.cost})">
              <div class="shipping-option-content">
                <input type="radio" 
                       name="shipping-${sellerId}" 
                       value="${option.shipping_method_id}"
                       ${isSelected ? 'checked' : ''}
                       onchange="selectShippingMethod('${sellerId}', '${option.shipping_method_id}', '${option.method_name}', ${option.cost})">
                <div class="shipping-option-details">
                  <div class="shipping-option-header">
                    <span class="shipping-option-name">${option.method_name}</span>
                    <span class="shipping-option-price ${priceClass}">${formatCurrency(option.cost)}</span>
                  </div>
                  <div class="shipping-option-meta">
                    <span><i class="fas fa-clock"></i> ${option.delivery_time_min}-${option.delivery_time_max} days</span>
                    ${option.description ? `<span><i class="fas fa-info-circle"></i> ${option.description}</span>` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        }
        
        html += `
            </div>
          </div>
        `;
      }
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // Make selectShippingMethod globally accessible for onclick handlers
    window.selectShippingMethod = function(sellerId, methodId, methodName, cost) {
      // Update selection state
      selectedShippingMethods[sellerId] = {
        method_id: methodId,
        method_name: methodName,
        cost: parseFloat(cost)
      };
      
      // Update visual selection
      const sellerGroup = document.querySelector(`.seller-shipping-group[data-seller-id="${sellerId}"]`);
      if (sellerGroup) {
        sellerGroup.querySelectorAll('.shipping-option').forEach(opt => {
          opt.classList.remove('selected');
          const radio = opt.querySelector('input[type="radio"]');
          if (radio && radio.value === methodId) {
            opt.classList.add('selected');
            radio.checked = true;
          }
        });
      }
      
      // Recalculate totals
      recalculateTotalShipping();
    }
    
    function recalculateTotalShipping() {
      // Sum up all selected shipping costs
      currentShippingCost = Object.values(selectedShippingMethods)
        .reduce((sum, method) => sum + (method.cost || 0), 0);
      
      // Update shipping breakdown display
      updateShippingBreakdown();
      
      // Update totals
      updateOrderTotals();
    }
    
    function updateShippingBreakdown() {
      const breakdownEl = document.getElementById('shipping-breakdown');
      const sellerIds = Object.keys(selectedShippingMethods);
      
      if (sellerIds.length <= 1) {
        // Don't show breakdown for single seller
        breakdownEl.style.display = 'none';
        return;
      }
      
      const formatCurrency = (amount) => {
        if (amount === 0) return 'FREE';
        return `₦${parseFloat(amount || 0).toLocaleString('en-NG', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      };
      
      let html = '';
      for (const sellerId of sellerIds) {
        const method = selectedShippingMethods[sellerId];
        const sellerName = sellerShippingOptions[sellerId]?.seller_name || `Seller ${sellerId}`;
        html += `
          <div class="shipping-breakdown-item">
            <span class="shipping-breakdown-seller">${sellerName}</span>
            <span class="shipping-breakdown-cost">${formatCurrency(method.cost)}</span>
          </div>
        `;
      }
      
      breakdownEl.innerHTML = html;
      breakdownEl.style.display = 'block';
    }

    async function handleCheckout(event) {
      event.preventDefault();
      const btn = document.getElementById('checkout-btn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      let shippingAddressId = null;

      // Validate shipping method selection (if shipping options exist)
      const sellerIds = Object.keys(sellerShippingOptions);
      if (sellerIds.length > 0) {
        // Check that all sellers have a shipping method selected
        for (const sellerId of sellerIds) {
          if (!selectedShippingMethods[sellerId]) {
            showToast('Please select a shipping method for all sellers', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-lock"></i> Complete Order';
            return;
          }
        }
      }

      // Check if user selected an existing address
      if (selectedAddressId) {
        shippingAddressId = selectedAddressId;
        console.log('Using existing shipping address:', shippingAddressId);
      } else {
        // User is creating a new address - validate form
        const fullName = document.getElementById('shipping-full-name').value.trim();
        const phone = document.getElementById('shipping-phone').value.trim();
        const address = document.getElementById('shipping-address').value.trim();
        const city = document.getElementById('shipping-city').value.trim();
        const state = document.getElementById('shipping-state').value.trim();
        const country = document.getElementById('shipping-country').value.trim();

        if (!fullName || !phone || !address || !city || !state || !country) {
          showToast('Please fill in all shipping details', 'error');
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-lock"></i> Complete Order';
          return;
        }

        // Create new shipping address
        const shippingAddressData = {
          full_name: document.getElementById('shipping-full-name').value,
          phone_number: document.getElementById('shipping-phone').value,
          street_address: document.getElementById('shipping-address').value,
          city: document.getElementById('shipping-city').value,
          state: document.getElementById('shipping-state').value,
          country: document.getElementById('shipping-country').value,
          postal_code: document.getElementById('shipping-postal-code').value || '',
        };

        try {
          const addressResponse = await SuperAffiliateAPI.apiRequest('/commerce/shipping/addresses/', {
            method: 'POST',
            body: JSON.stringify(shippingAddressData),
          });
          shippingAddressId = addressResponse.id;
          console.log('Shipping address created:', shippingAddressId);
          // Add to addresses array so calculateShippingCost can find it
          shippingAddresses.push(addressResponse);
          // Calculate shipping cost for the new address
          await calculateShippingCost(shippingAddressId);
        } catch (error) {
          // Address creation failed - don't proceed with order
          console.error('Address creation failed:', error);
          const errorMessage = error.message || 'Failed to create shipping address';
          showToast(errorMessage, 'error');
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-lock"></i> Complete Order';
          return; // Stop execution
        }
      }

      // Validate that we have an address ID
      if (!shippingAddressId) {
        showToast('Please select or add a shipping address', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-lock"></i> Complete Order';
        return;
      }

      try {

        // Create order with shipping methods
        const orderData = {
          shipping_address: shippingAddressId,
          billing_address: shippingAddressId, // Use same for billing
          payment_method: document.querySelector('input[name="payment_method"]:checked').value,
        };
        
        // Include selected shipping methods if available
        if (Object.keys(selectedShippingMethods).length > 0) {
          orderData.shipping_methods = {};
          for (const [sellerId, method] of Object.entries(selectedShippingMethods)) {
            orderData.shipping_methods[sellerId] = {
              method_id: method.method_id,
              method_name: method.method_name,
              cost: method.cost
            };
          }
          // Also include total shipping cost for backend validation
          orderData.shipping_cost = currentShippingCost;
        }

        const orderResponse = await SuperAffiliateAPI.apiRequest('/commerce/orders/create/', {
          method: 'POST',
          body: JSON.stringify(orderData),
        });

        console.log('Order creation response:', orderResponse);

        // Handle payment redirect - check for different response formats
        let paymentUrl = null;
        let orderId = null;

        // Single order format
        if (orderResponse.order) {
          orderId = orderResponse.order.id;
          if (orderResponse.payment?.authorization_url) {
            paymentUrl = orderResponse.payment.authorization_url;
          }
        }
        // Multiple orders format
        else if (orderResponse.orders && orderResponse.orders.length > 0) {
          orderId = orderResponse.orders[0].id;
          if (orderResponse.payments && orderResponse.payments.length > 0) {
            paymentUrl = orderResponse.payments[0].authorization_url;
          }
        }
        // Direct format (backward compatibility)
        else {
          orderId = orderResponse.id || orderResponse.order_id;
          paymentUrl = orderResponse.payment_url || 
                      orderResponse.authorization_url || 
                      orderResponse.paystack_authorization_url ||
                      (orderResponse.payment && orderResponse.payment.authorization_url);
        }

        if (paymentUrl) {
          // Redirect to Paystack payment page
          showToast('Redirecting to Paystack...', 'success');
          setTimeout(() => {
            window.location.href = paymentUrl;
          }, 1000);
        } else if (orderId) {
          // Order created but no payment URL - redirect to order detail page
          showToast('Order created successfully!', 'success');
          setTimeout(() => {
            window.location.href = `order-detail.html?id=${orderId}`;
          }, 1500);
        } else {
          // Fallback to orders list
          showToast('Order created! Check your orders.', 'success');
          setTimeout(() => {
            window.location.href = 'orders.html';
          }, 2000);
        }
      } catch (error) {
        console.error('Checkout error:', error);
        showToast(error.message || 'Failed to complete checkout', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-lock"></i> Complete Order';
      }
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: ${type === 'success' ? '#00f2ea' : '#ff0050'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Initialize
    loadCart();
  </script>
</body>
</html>
