<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  <meta name="theme-color" content="#ff0050">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tanda">
  <title>Checkout - Tanda Web</title>

  <link rel="icon" type="image/png" sizes="32x32" href="Tanda logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #ff0050, #00f2ea);
      --accent-color: #00f2ea;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --bg-card: rgba(255, 255, 255, 0.05);
      --border-radius: 1rem;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      min-height: 100vh;
      padding: 2rem;
    }

    /* Safe area insets for iPhone notches and home indicator */
    @supports (padding: env(safe-area-inset-top)) {
      .header {
        padding-top: calc(2rem + env(safe-area-inset-top));
        padding-left: calc(2rem + env(safe-area-inset-left));
        padding-right: calc(2rem + env(safe-area-inset-right));
      }

      .container {
        padding-left: calc(2rem + env(safe-area-inset-left));
        padding-right: calc(2rem + env(safe-area-inset-right));
      }

      @media (max-width: 768px) {
        .container {
          padding-left: calc(1rem + env(safe-area-inset-left));
          padding-right: calc(1rem + env(safe-area-inset-right));
        }
      }
    }

    /* iOS keyboard handling - prevent zoom on input focus */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    input[type="tel"],
    input[type="url"],
    input[type="search"],
    textarea,
    select {
      font-size: 16px !important;
    }

    input[type="number"] {
      inputmode: "numeric";
    }

    input[type="tel"] {
      inputmode: "tel";
    }

    input[type="email"] {
      inputmode: "email";
    }

    .header {
      max-width: 1200px;
      margin: 0 auto 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .title {
      font-size: 1.8rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }

    .nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .checkout-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
    }

    .card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 2rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      margin-bottom: 1.5rem;
      color: var(--accent-color);
      font-size: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.9rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 0.6rem;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      background: rgba(255, 255, 255, 0.08);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .summary {
      position: sticky;
      top: 2rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .summary-total {
      font-size: 1.5rem;
      font-weight: 800;
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: 1rem;
      margin-top: 1rem;
    }

    .btn {
      padding: 1rem 2rem;
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 0.6rem;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      justify-content: center;
      margin-top: 1.5rem;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 0, 80, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      padding: 0.75rem 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.6rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--accent-color);
    }

    .address-option {
      padding: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.6rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.03);
    }

    .address-option:hover {
      border-color: var(--accent-color);
      background: rgba(255, 255, 255, 0.05);
    }

    .address-option.selected {
      border-color: var(--accent-color);
      background: rgba(0, 242, 234, 0.1);
    }

    .address-option input[type="radio"] {
      margin-right: 0.75rem;
      width: auto;
    }

    .address-option-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .address-option-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .address-option-default {
      background: var(--primary-gradient);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .address-option-details {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .order-item {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .order-item-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 0.5rem;
      background: rgba(255,255,255,0.05);
    }

    .order-item-details {
      flex: 1;
    }

    .order-item-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .order-item-meta {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .title {
        font-size: 1.5rem;
      }

      .checkout-layout {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .card {
        padding: 1.5rem;
      }

      .summary {
        position: static;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .order-item {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .item-image {
        width: 100%;
        max-width: 150px;
        margin: 0 auto;
      }

      .btn {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 0.75rem;
      }

      .title {
        font-size: 1.3rem;
      }

      .card {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 class="title">Checkout</h1>
    <div class="nav" id="authNav"></div>
  </div>

  <div class="container">
    <div id="loading-section" class="loading">
      <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
      <p>Loading checkout...</p>
    </div>

    <div id="checkout-section" style="display: none;">
      <div class="checkout-layout">
        <div>
          <form id="checkout-form" onsubmit="handleCheckout(event)">
            <div class="card">
              <h2>Shipping Address</h2>
              
              <!-- Address Selection Section -->
              <div id="address-selection-section" style="display: none;">
                <div class="form-group">
                  <label>Select an Address</label>
                  <div id="address-list" style="margin-bottom: 1rem;"></div>
                  <button type="button" class="btn-secondary" onclick="showNewAddressForm()" style="width: auto; margin-top: 0.5rem;">
                    <i class="fas fa-plus"></i> Add New Address
                  </button>
                </div>
              </div>

              <!-- New Address Form Section -->
              <div id="new-address-form">
                <div class="form-group">
                  <label for="shipping-full-name">Full Name</label>
                  <input type="text" id="shipping-full-name" required>
                </div>
                <div class="form-group">
                  <label for="shipping-phone">Phone Number</label>
                  <input type="tel" id="shipping-phone" required>
                </div>
                <div class="form-group">
                  <label for="shipping-address">Address</label>
                  <textarea id="shipping-address" rows="3" required></textarea>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="shipping-city">City</label>
                    <input type="text" id="shipping-city" required>
                  </div>
                  <div class="form-group">
                    <label for="shipping-state">State</label>
                    <input type="text" id="shipping-state" required>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="shipping-country">Country</label>
                    <input type="text" id="shipping-country" value="Nigeria" required>
                  </div>
                  <div class="form-group">
                    <label for="shipping-postal-code">Postal Code</label>
                    <input type="text" id="shipping-postal-code" placeholder="Optional">
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <h2>Payment Method</h2>
              <div class="form-group">
                <label>
                  <input type="radio" name="payment_method" value="paystack" checked style="width: auto; margin-right: 0.5rem;">
                  Paystack (Card, Bank Transfer)
                </label>
              </div>
            </div>

            <button type="submit" class="btn" id="checkout-btn">
              <i class="fas fa-lock"></i> Complete Order
            </button>
          </form>
        </div>

        <div class="summary card">
          <h2>Order Summary</h2>
          <div id="order-items"></div>
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="subtotal">₦0.00</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span id="shipping">₦0.00</span>
          </div>
          <div class="summary-row summary-total">
            <span>Total</span>
            <span id="total">₦0.00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/super-affiliate-api.js?v=3"></script>
  <script>
    let cartData = null;
    let shippingAddresses = [];
    let selectedAddressId = null;

    // Check authentication
    if (!SuperAffiliateAPI.isAuthenticated()) {
      window.location.href = 'super-affiliate-login.html?redirect=' + encodeURIComponent(window.location.href);
    }

    // Render auth nav
    SuperAffiliateAPI.renderAuthNav('authNav');

    async function loadCart() {
      try {
        const response = await SuperAffiliateAPI.getCart();
        cartData = response;
        displayOrderSummary(response);
        document.getElementById('loading-section').style.display = 'none';
        document.getElementById('checkout-section').style.display = 'block';
        
        // Load shipping addresses
        await loadShippingAddresses();
      } catch (error) {
        console.error('Error loading cart:', error);
        window.location.href = 'cart.html';
      }
    }

    async function loadShippingAddresses() {
      try {
        const response = await SuperAffiliateAPI.apiRequest('/commerce/shipping/addresses/');
        // Handle both array and paginated response formats
        shippingAddresses = Array.isArray(response) 
          ? response 
          : (response.results || response.data || []);
        
        if (shippingAddresses && shippingAddresses.length > 0) {
          // Show address selection, hide new address form
          displayAddressSelection();
        } else {
          // No addresses - require new address form
          document.getElementById('address-selection-section').style.display = 'none';
          document.getElementById('new-address-form').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading shipping addresses:', error);
        // If error, show new address form as fallback
        document.getElementById('address-selection-section').style.display = 'none';
        document.getElementById('new-address-form').style.display = 'block';
      }
    }

    function displayAddressSelection() {
      const addressList = document.getElementById('address-list');
      const selectionSection = document.getElementById('address-selection-section');
      const newAddressForm = document.getElementById('new-address-form');
      
      // Show selection section, hide new address form
      selectionSection.style.display = 'block';
      newAddressForm.style.display = 'none';
      
      // Find default address or first address
      const defaultAddress = shippingAddresses.find(addr => addr.is_default) || shippingAddresses[0];
      if (defaultAddress) {
        selectedAddressId = defaultAddress.id;
      }
      
      addressList.innerHTML = shippingAddresses.map(address => `
        <div class="address-option ${address.id === selectedAddressId ? 'selected' : ''}" onclick="selectAddress(${address.id})">
          <div class="address-option-header">
            <label style="display: flex; align-items: center; cursor: pointer; width: 100%;">
              <input type="radio" name="shipping-address" value="${address.id}" ${address.id === selectedAddressId ? 'checked' : ''} onchange="selectAddress(${address.id})">
              <span class="address-option-name">${address.full_name}</span>
            </label>
            ${address.is_default ? '<span class="address-option-default">Default</span>' : ''}
          </div>
          <div class="address-option-details">
            <div>${address.phone_number}</div>
            <div>${address.street_address}${address.apartment_suite ? ', ' + address.apartment_suite : ''}</div>
            <div>${address.city}, ${address.state}${address.postal_code ? ' ' + address.postal_code : ''}</div>
            <div>${address.country}</div>
          </div>
        </div>
      `).join('');
    }

    function selectAddress(addressId) {
      selectedAddressId = addressId;
      // Update visual selection
      document.querySelectorAll('.address-option').forEach(option => {
        option.classList.remove('selected');
        const radio = option.querySelector('input[type="radio"]');
        if (radio && parseInt(radio.value) === addressId) {
          option.classList.add('selected');
          radio.checked = true;
        }
      });
    }

    function showNewAddressForm() {
      document.getElementById('address-selection-section').style.display = 'none';
      document.getElementById('new-address-form').style.display = 'block';
      selectedAddressId = null;
      
      // Clear any selected radio buttons
      document.querySelectorAll('input[name="shipping-address"]').forEach(radio => {
        radio.checked = false;
      });
      
      // Add required attributes back to new address form fields
      const newAddressForm = document.getElementById('new-address-form');
      const requiredFields = [
        'shipping-full-name',
        'shipping-phone',
        'shipping-address',
        'shipping-city',
        'shipping-state',
        'shipping-country'
      ];
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.setAttribute('required', 'required');
        }
      });
    }

    function displayOrderSummary(data) {
      const items = data.items || [];
      const formatCurrency = (amount) => {
        return `₦${parseFloat(amount || 0).toLocaleString('en-NG', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      };

      const itemsHtml = items.map(item => `
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span>${item.product?.name || 'Product'} x${item.quantity}</span>
          <span>${formatCurrency((item.product?.price || 0) * item.quantity)}</span>
        </div>
      `).join('');

      document.getElementById('order-items').innerHTML = itemsHtml;

      const subtotal = items.reduce((sum, item) => sum + (parseFloat(item.product?.price || 0) * item.quantity), 0);
      const shipping = 0;
      const total = subtotal + shipping;

      document.getElementById('subtotal').textContent = formatCurrency(subtotal);
      document.getElementById('shipping').textContent = formatCurrency(shipping);
      document.getElementById('total').textContent = formatCurrency(total);
    }

    async function handleCheckout(event) {
      event.preventDefault();
      const btn = document.getElementById('checkout-btn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      let shippingAddressId = null;

      // Check if user selected an existing address
      if (selectedAddressId) {
        shippingAddressId = selectedAddressId;
        console.log('Using existing shipping address:', shippingAddressId);
      } else {
        // User is creating a new address - validate form
        const fullName = document.getElementById('shipping-full-name').value.trim();
        const phone = document.getElementById('shipping-phone').value.trim();
        const address = document.getElementById('shipping-address').value.trim();
        const city = document.getElementById('shipping-city').value.trim();
        const state = document.getElementById('shipping-state').value.trim();
        const country = document.getElementById('shipping-country').value.trim();

        if (!fullName || !phone || !address || !city || !state || !country) {
          showToast('Please fill in all shipping details', 'error');
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-lock"></i> Complete Order';
          return;
        }

        // Create new shipping address
        const shippingAddressData = {
          full_name: document.getElementById('shipping-full-name').value,
          phone_number: document.getElementById('shipping-phone').value,
          street_address: document.getElementById('shipping-address').value,
          city: document.getElementById('shipping-city').value,
          state: document.getElementById('shipping-state').value,
          country: document.getElementById('shipping-country').value,
          postal_code: document.getElementById('shipping-postal-code').value || '',
        };

        try {
          const addressResponse = await SuperAffiliateAPI.apiRequest('/commerce/shipping/addresses/', {
            method: 'POST',
            body: JSON.stringify(shippingAddressData),
          });
          shippingAddressId = addressResponse.id;
          console.log('Shipping address created:', shippingAddressId);
        } catch (error) {
          // Address creation failed - don't proceed with order
          console.error('Address creation failed:', error);
          const errorMessage = error.message || 'Failed to create shipping address';
          showToast(errorMessage, 'error');
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-lock"></i> Complete Order';
          return; // Stop execution
        }
      }

      // Validate that we have an address ID
      if (!shippingAddressId) {
        showToast('Please select or add a shipping address', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-lock"></i> Complete Order';
        return;
      }

      try {

        // Create order
        const orderData = {
          shipping_address: shippingAddressId,
          billing_address: shippingAddressId, // Use same for billing
          payment_method: document.querySelector('input[name="payment_method"]:checked').value,
        };

        const orderResponse = await SuperAffiliateAPI.apiRequest('/commerce/orders/create/', {
          method: 'POST',
          body: JSON.stringify(orderData),
        });

        console.log('Order creation response:', orderResponse);

        // Handle payment redirect - check for different response formats
        let paymentUrl = null;
        let orderId = null;

        // Single order format
        if (orderResponse.order) {
          orderId = orderResponse.order.id;
          if (orderResponse.payment?.authorization_url) {
            paymentUrl = orderResponse.payment.authorization_url;
          }
        }
        // Multiple orders format
        else if (orderResponse.orders && orderResponse.orders.length > 0) {
          orderId = orderResponse.orders[0].id;
          if (orderResponse.payments && orderResponse.payments.length > 0) {
            paymentUrl = orderResponse.payments[0].authorization_url;
          }
        }
        // Direct format (backward compatibility)
        else {
          orderId = orderResponse.id || orderResponse.order_id;
          paymentUrl = orderResponse.payment_url || 
                      orderResponse.authorization_url || 
                      orderResponse.paystack_authorization_url ||
                      (orderResponse.payment && orderResponse.payment.authorization_url);
        }

        if (paymentUrl) {
          // Redirect to Paystack payment page
          showToast('Redirecting to Paystack...', 'success');
          setTimeout(() => {
            window.location.href = paymentUrl;
          }, 1000);
        } else if (orderId) {
          // Order created but no payment URL - redirect to order detail page
          showToast('Order created successfully!', 'success');
          setTimeout(() => {
            window.location.href = `order-detail.html?id=${orderId}`;
          }, 1500);
        } else {
          // Fallback to orders list
          showToast('Order created! Check your orders.', 'success');
          setTimeout(() => {
            window.location.href = 'orders.html';
          }, 2000);
        }
      } catch (error) {
        console.error('Checkout error:', error);
        showToast(error.message || 'Failed to complete checkout', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-lock"></i> Complete Order';
      }
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: ${type === 'success' ? '#00f2ea' : '#ff0050'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Initialize
    loadCart();
  </script>
</body>
</html>
